<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Admin Panel ‚Äî Enterprise Travel Pricing</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        html{-webkit-text-size-adjust:100%;text-size-adjust:100%}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:#f5f7fa;min-height:100vh;overflow-x:hidden}

{% if mode == 'login' %}
        /* ===== LOGIN PAGE STYLES ===== */
        body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;min-height:100vh}
        .login-wrap{background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.2);padding:40px;width:100%;max-width:420px;margin:20px}
        .login-logo{text-align:center;margin-bottom:28px}
        .login-logo h1{font-size:26px;font-weight:800;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .login-logo p{color:#888;font-size:13px;margin-top:4px}
        .login-tabs{display:flex;gap:4px;background:#f0f0f0;border-radius:8px;padding:4px;margin-bottom:24px}
        .login-tab{flex:1;padding:9px;text-align:center;border:none;background:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;color:#666;transition:.2s}
        .login-tab.active{background:#fff;color:#667eea;box-shadow:0 2px 8px rgba(0,0,0,.1)}
        .login-panel{display:none}.login-panel.active{display:block}
        .form-group{margin-bottom:16px}
        .form-group label{display:block;font-size:13px;font-weight:600;color:#555;margin-bottom:6px}
        .form-group input{width:100%;padding:11px 14px;border:1.5px solid #e0e0e0;border-radius:8px;font-size:14px;transition:.2s;-webkit-appearance:none}
        .form-group input:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.15)}
        .login-btn{width:100%;padding:13px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;transition:.2s;margin-top:8px}
        .login-btn:hover{opacity:.9;transform:translateY(-1px)}
        .login-btn:active{transform:translateY(0)}
        .login-btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
        .login-err{background:#fff0f0;border:1px solid #ffd0d0;color:#c0392b;padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:16px;display:none}
        .login-err.show{display:block}
        .pin-inputs{display:flex;gap:8px;justify-content:center;margin-bottom:8px}
        .pin-inputs input{width:48px;height:56px;text-align:center;font-size:22px;font-weight:700;border:2px solid #e0e0e0;border-radius:10px;-webkit-appearance:none;appearance:none;background:#fafafa;transition:.2s}
        .pin-inputs input:focus{border-color:#667eea;background:#fff;box-shadow:0 0 0 3px rgba(102,126,234,.15);outline:none}
        .pin-inputs input::-webkit-outer-spin-button,.pin-inputs input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
        .pin-inputs input[type=number]{-moz-appearance:textfield}
        .passkey-btn{width:100%;padding:14px;background:#f8f9ff;border:2px dashed #667eea;color:#667eea;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;gap:10px}
        .passkey-btn:hover{background:#eef0ff;border-style:solid}
        .passkey-btn svg{width:24px;height:24px;flex-shrink:0}
        .passkey-info{font-size:12px;color:#999;text-align:center;margin-top:10px;line-height:1.5}
        .setup-link{text-align:center;margin-top:20px;font-size:13px;color:#888}
        .setup-link a{color:#667eea;font-weight:600;text-decoration:none}
        .setup-link a:hover{text-decoration:underline}
{% else %}
        /* ===== HEADER ===== */
        .header{
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;
            padding:14px 20px;display:flex;justify-content:space-between;align-items:center;
            box-shadow:0 2px 10px rgba(0,0,0,.1);position:sticky;top:0;z-index:100;
            flex-wrap:wrap;gap:10px;
        }
        .header h1{font-size:clamp(14px,3vw,22px);white-space:nowrap}
        .header-right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
        .client-selector{
            padding:8px 12px;border-radius:6px;border:1px solid rgba(255,255,255,.3);
            background:rgba(255,255,255,.15);color:#fff;font-size:13px;font-weight:600;
            cursor:pointer;min-height:38px;-webkit-appearance:none;appearance:none;
        }
        .client-selector option{color:#333;background:#fff}
        .btn-logout{
            padding:8px 16px;background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);
            color:#fff;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;
            text-decoration:none;transition:.3s;white-space:nowrap;min-height:38px;
            display:inline-flex;align-items:center;
        }
        .btn-logout:hover{background:rgba(255,255,255,.3)}

        /* ===== CONTAINER ===== */
        .container{max-width:1600px;margin:20px auto;padding:0 16px}

        /* ===== TABS ===== */
        .tabs{
            display:flex;gap:6px;margin-bottom:20px;background:#fff;padding:10px;
            border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.05);
            flex-wrap:wrap;overflow-x:auto;-webkit-overflow-scrolling:touch;
        }
        .tab{
            padding:9px 14px;cursor:pointer;background:#f8f9fa;border:none;border-radius:6px;
            font-size:12px;font-weight:600;transition:.3s;color:#666;white-space:nowrap;
            min-height:36px;-webkit-tap-highlight-color:transparent;flex-shrink:0;
        }
        .tab.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;box-shadow:0 4px 12px rgba(102,126,234,.3)}
        .tab:hover:not(.active){background:#e9ecef}
        .tab-content{display:none}.tab-content.active{display:block;animation:fadeIn .3s}
        @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

        /* ===== CARDS ===== */
        .section-card{background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.05);margin-bottom:20px}
        .section-header{font-size:clamp(14px,3vw,18px);font-weight:700;color:#333;margin-bottom:14px;padding-bottom:10px;border-bottom:2px solid #f0f0f0}

        /* ===== REGION SECTIONS ===== */
        .region-section-divider{margin:24px 0 14px;padding:14px;background:linear-gradient(135deg,rgba(102,126,234,.1),rgba(118,75,162,.1));border-radius:8px;border-left:4px solid #667eea}
        .region-section-title{font-size:clamp(15px,3vw,20px);font-weight:700;color:#667eea;display:flex;align-items:center;gap:8px;flex-wrap:wrap}

        /* ===== FILTER BUTTONS ===== */
        .filter-buttons{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap}
        .filter-btn{
            padding:7px 14px;background:#f8f9fa;border:1px solid #e0e0e0;border-radius:6px;
            cursor:pointer;font-size:12px;font-weight:600;transition:.3s;color:#666;
            min-height:34px;-webkit-tap-highlight-color:transparent;
        }
        .filter-btn.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-color:#667eea}
        .filter-btn:hover:not(.active){background:#e9ecef}

        /* ===== FORMS ===== */
        .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;margin-bottom:18px}
        .form-group{display:flex;flex-direction:column}
        .form-group label{font-size:12px;font-weight:600;color:#555;margin-bottom:5px}
        .form-group label .req{color:#e74c3c}
        .form-group input,.form-group select,.form-group textarea{
            padding:9px 11px;border:2px solid #e0e0e0;border-radius:6px;font-size:13px;
            transition:.3s;font-family:inherit;min-height:40px;width:100%;
            -webkit-appearance:none;appearance:none;
        }
        .form-group input:focus,.form-group select:focus,.form-group textarea:focus{
            outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)
        }
        textarea{min-height:60px;resize:vertical}
        .checkbox-label{display:flex;align-items:center;font-size:13px;color:#555;cursor:pointer;gap:6px;margin-top:6px;min-height:24px}
        .checkbox-label input[type="checkbox"]{width:16px;height:16px;min-height:16px;flex-shrink:0}

        /* ===== BUTTONS ===== */
        .btn{
            padding:9px 20px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;
            border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;
            transition:.3s;min-height:40px;-webkit-tap-highlight-color:transparent;
            display:inline-flex;align-items:center;justify-content:center;
        }
        .btn:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(102,126,234,.4)}
        .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        .btn-sm{padding:5px 11px;font-size:11px;min-height:30px}
        .btn-danger{background:#e74c3c}.btn-danger:hover{box-shadow:0 6px 18px rgba(231,76,60,.4)}
        .btn-secondary{background:#6c757d}.btn-secondary:hover{box-shadow:0 6px 18px rgba(108,117,125,.4)}
        .btn-ai{background:linear-gradient(135deg,#f093fb,#f5576c);color:#fff}.btn-ai:hover{box-shadow:0 6px 18px rgba(240,147,251,.4)}

        /* ===== TABLES ===== */
        .table-container{overflow-x:auto;margin-top:16px;-webkit-overflow-scrolling:touch;border-radius:8px;border:1px solid #f0f0f0}
        table{width:100%;border-collapse:collapse;min-width:500px}
        th{
            background:#f8f9fa;padding:11px 10px;text-align:left;font-weight:600;
            font-size:11px;color:#666;text-transform:uppercase;letter-spacing:.5px;
            border-bottom:2px solid #e0e0e0;white-space:nowrap;
        }
        td{padding:10px;border-bottom:1px solid #f0f0f0;font-size:12px;color:#333;word-break:break-word}
        tr:hover{background:#f8f9fa}
        tr.inactive{opacity:.5;background:#f9f9f9}
        .actions{display:flex;gap:5px;align-items:center;flex-wrap:nowrap}
        .badge{display:inline-block;padding:3px 7px;border-radius:4px;font-size:10px;font-weight:600;white-space:nowrap}
        .badge-active{background:#d4edda;color:#155724}
        .badge-inactive{background:#f8d7da;color:#721c24}
        .badge-domestic{background:#cce5ff;color:#004085}
        .badge-intl{background:#fff3cd;color:#856404}

        /* ===== TOGGLE SWITCH ===== */
        .toggle-switch{position:relative;display:inline-block;width:42px;height:22px;flex-shrink:0}
        .toggle-switch input{opacity:0;width:0;height:0}
        .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;transition:.3s;border-radius:22px}
        .toggle-slider:before{position:absolute;content:"";height:16px;width:16px;left:3px;bottom:3px;background:#fff;transition:.3s;border-radius:50%}
        input:checked+.toggle-slider{background:#27ae60}
        input:checked+.toggle-slider:before{transform:translateX(20px)}

        /* ===== MESSAGES ===== */
        .msg{padding:11px 14px;border-radius:6px;margin-bottom:14px;font-size:13px;display:none}
        .msg.show{display:block;animation:slideD .3s}
        @keyframes slideD{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
        .msg.success{background:#d4edda;color:#155724;border-left:4px solid #28a745}
        .msg.error{background:#f8d7da;color:#721c24;border-left:4px solid #dc3545}
        .msg.warning{background:#fff3cd;color:#856404;border-left:4px solid #ffc107}

        /* ===== MODAL ===== */
        .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5);overflow-y:auto;padding:16px}
        .modal.show{display:flex;align-items:flex-start;justify-content:center}
        .modal-content{
            background:#fff;padding:24px;border-radius:10px;max-width:650px;width:100%;
            margin:auto;
        }
        .modal-header{font-size:clamp(15px,3vw,18px);font-weight:700;margin-bottom:14px;color:#333}
        .modal-footer{display:flex;gap:8px;justify-content:flex-end;margin-top:18px;flex-wrap:wrap}
        .modal-footer .btn{flex:1;min-width:80px}

        /* ===== CONFIRM MODAL ===== */
        .confirm-modal-content{max-width:420px}
        .confirm-modal-msg{font-size:14px;color:#333;margin-bottom:8px}
        .confirm-modal-detail{font-size:12px;color:#888}

        /* ===== INFO BOXES ===== */
        .info-box{background:#e3f2fd;border-left:4px solid #2196f3;padding:11px 14px;margin-bottom:18px;border-radius:6px;font-size:13px;color:#1976d2}
        .info-box-ai{background:#fce4ec;border-left:4px solid #e91e63;padding:11px 14px;margin-bottom:18px;border-radius:6px;font-size:13px;color:#880e4f}

        /* ===== RATE GRID ===== */
        .rate-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px}
        .rate-section{padding:12px;background:#f8f9fa;border-radius:6px}
        .rate-section-title{font-size:11px;font-weight:600;text-transform:uppercase;color:#666;margin-bottom:8px}

        /* ===== JSON EDITOR ===== */
        .json-editor{
            width:100%;min-height:90px;font-family:'Courier New',monospace;font-size:12px;
            padding:9px;border:2px solid #e0e0e0;border-radius:6px;resize:vertical;
        }
        .json-editor:focus{outline:none;border-color:#667eea}

        /* ===== EMPTY STATE ===== */
        .empty-state{text-align:center;padding:36px;color:#999}
        .empty-state-icon{font-size:44px;margin-bottom:10px}

        /* ===== MATRIX ===== */
        .matrix-rate-input{
            width:80px;padding:5px 7px;border:1px solid #ddd;border-radius:4px;
            font-size:12px;text-align:right;min-height:30px;
        }
        .matrix-rate-input:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 2px rgba(102,126,234,.15)}
        .matrix-rate-input.modified{border-color:#28a745;background:#f0fff0}
        .matrix-table th{position:sticky;top:0;z-index:2;font-size:10px;padding:7px 5px;background:#f8f9fa}
        .matrix-table td{padding:5px;text-align:center;font-size:12px}
        .matrix-table .cab-name{text-align:left;font-weight:600;position:sticky;left:0;background:#fff;z-index:1;min-width:100px;max-width:140px;word-break:break-word}
        .matrix-save-bar{display:flex;gap:10px;align-items:center;margin-top:14px;padding:11px;background:#f8f9fa;border-radius:6px;flex-wrap:wrap}
        .matrix-save-bar .changes-count{font-size:13px;color:#666}

        /* ===== AI RULE BUILDER ===== */
        .nl-rule-container{margin-bottom:18px;padding:14px;background:#fafafa;border-radius:8px;border:1px solid #eee}
        .nl-rule-input{
            width:100%;padding:11px 13px;border:2px solid #e0e0e0;border-radius:6px;
            font-size:14px;min-height:44px;resize:none;font-family:inherit;transition:.3s;
        }
        .nl-rule-input:focus{outline:none;border-color:#f093fb;box-shadow:0 0 0 3px rgba(240,147,251,.15)}
        .nl-rule-input::placeholder{color:#aaa}
        .nl-rule-actions{display:flex;gap:8px;margin-top:10px;align-items:center;flex-wrap:wrap}
        .nl-rule-status{font-size:12px;padding:6px 10px;border-radius:4px;margin-top:8px;display:none}
        .nl-rule-status.show{display:block}
        .nl-rule-status.success{background:#d4edda;color:#155724}
        .nl-rule-status.error{background:#f8d7da;color:#721c24}
        .nl-rule-status.warning{background:#fff3cd;color:#856404}
        .nl-rule-examples{margin-top:8px;font-size:11px;color:#888;line-height:1.9}
        .nl-rule-examples code{background:#f0f0f0;padding:2px 6px;border-radius:3px;font-size:10px;word-break:break-all}
        .clarification-box{background:#fff3cd;border-left:4px solid #ffc107;padding:11px 14px;margin-top:11px;border-radius:6px;font-size:13px;color:#856404;display:none}
        .clarification-box.show{display:block}

        /* ===== MULTIPLIER FIELD VISIBILITY ===== */
        .multiplier-group{transition:opacity .2s}
        .multiplier-group.hidden-field{display:none;opacity:0;pointer-events:none}

        /* ===== MOBILE NAV ===== */
        .mobile-tab-scroll{
            display:none;
            overflow-x:auto;
            -webkit-overflow-scrolling:touch;
            scroll-behavior:smooth;
        }

        /* ===== RESPONSIVE BREAKPOINTS ===== */
        @media (max-width:900px){
            .container{padding:0 12px;margin:14px auto}
            .form-grid{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
            .rate-grid{grid-template-columns:1fr 1fr}
            .header{padding:12px 16px}
        }
        @media (max-width:700px){
            .header{padding:10px 14px}
            .header h1{font-size:15px}
            .header-right{gap:8px}
            .container{padding:0 10px;margin:12px auto}
            .section-card{padding:16px}
            .tabs{
                padding:8px;gap:4px;border-radius:8px;
                overflow-x:auto;flex-wrap:nowrap;
            }
            .tab{font-size:11px;padding:8px 11px;min-height:34px}
            .form-grid{grid-template-columns:1fr}
            .rate-grid{grid-template-columns:1fr}
            table{min-width:400px}
            .modal{padding:10px}
            .modal-content{padding:18px}
            .matrix-rate-input{width:70px;font-size:11px}
            .btn{font-size:12px;padding:8px 16px}
            .btn-sm{font-size:10px;padding:4px 9px}
        }
        @media (max-width:480px){
            .header{padding:10px 12px;gap:8px}
            .header h1{font-size:13px}
            .client-selector{font-size:12px;padding:6px 10px}
            .btn-logout{font-size:12px;padding:6px 12px}
            .container{padding:0 8px;margin:10px auto}
            .section-card{padding:14px;border-radius:8px}
            .section-header{font-size:15px;margin-bottom:12px;padding-bottom:8px}
            .tabs{
                padding:7px;border-radius:8px;gap:3px;
                flex-wrap:wrap;
            }
            .tab{font-size:10px;padding:7px 9px;min-height:32px;border-radius:5px}
            .form-group input,.form-group select,.form-group textarea{font-size:16px;}
            td{font-size:11px;padding:8px 7px}
            th{font-size:10px;padding:8px 7px}
            .actions{gap:4px}
            .btn-sm{font-size:10px;padding:4px 8px;min-height:28px}
            .toggle-switch{width:38px;height:20px}
            .toggle-slider:before{height:14px;width:14px}
            input:checked+.toggle-slider:before{transform:translateX(18px)}
            .nl-rule-input{font-size:16px}
            .json-editor{font-size:11px}
            .matrix-rate-input{width:60px;font-size:10px;padding:4px 5px}
            .rate-section{padding:10px}
            .region-section-title{font-size:14px}
            .filter-btn{font-size:11px;padding:6px 11px}
            .modal-footer{flex-direction:column}
            .modal-footer .btn{width:100%}
        }
        @media (max-width:360px){
            .header h1{font-size:12px}
            .tab{font-size:9px;padding:6px 7px}
            .container{padding:0 6px}
        }
{% endif %}
    </style>
</head>
<body>

{% if mode == 'login' %}
<!-- ============================================================
     LOGIN PAGE ‚Äî Point 1 (v4.0)
     Multi-method: Password / PIN / Passkey (WebAuthn biometric)
     All auth is backend-validated. No frontend-only checks.
     NO "Remember Me" ‚Äî sessions expire on browser close.
     ============================================================ -->
<div class="login-wrap">
    <div class="login-logo">
        <h1>Global Calc</h1>
        <p>Enterprise Travel Pricing System</p>
    </div>

    <div id="loginErr" class="login-err"></div>

    <div class="login-tabs">
        <button class="login-tab active" onclick="switchLoginTab('password')">üîë Password</button>
        <button class="login-tab" onclick="switchLoginTab('pin')">üî¢ PIN</button>
        {% if webauthn_available %}
        <button class="login-tab" onclick="switchLoginTab('passkey')">üîí Passkey</button>
        {% endif %}
    </div>

    <!-- ‚îÄ‚îÄ Password Panel ‚îÄ‚îÄ -->
    <div class="login-panel active" id="panel-password">
        <div class="form-group">
            <label for="pw-username">Username</label>
            <input type="text" id="pw-username" autocomplete="username" placeholder="admin" />
        </div>
        <div class="form-group">
            <label for="pw-password">Password</label>
            <input type="password" id="pw-password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                   onkeydown="if(event.key==='Enter')submitPassword()" />
        </div>
        <button class="login-btn" id="pw-btn" onclick="submitPassword()">Sign In</button>
    </div>

    <!-- ‚îÄ‚îÄ PIN Panel ‚îÄ‚îÄ -->
    <div class="login-panel" id="panel-pin">
        <div class="form-group">
            <label for="pin-username">Username</label>
            <input type="text" id="pin-username" autocomplete="username" placeholder="admin" />
        </div>
        <div class="form-group" style="margin-top:4px">
            <label>PIN (4‚Äì6 digits)</label>
            <div class="pin-inputs" id="pinInputs">
                <input type="number" maxlength="1" min="0" max="9" class="pin-cell" data-idx="0" inputmode="numeric" />
                <input type="number" maxlength="1" min="0" max="9" class="pin-cell" data-idx="1" inputmode="numeric" />
                <input type="number" maxlength="1" min="0" max="9" class="pin-cell" data-idx="2" inputmode="numeric" />
                <input type="number" maxlength="1" min="0" max="9" class="pin-cell" data-idx="3" inputmode="numeric" />
                <input type="number" maxlength="1" min="0" max="9" class="pin-cell" data-idx="4" inputmode="numeric" />
                <input type="number" maxlength="1" min="0" max="9" class="pin-cell" data-idx="5" inputmode="numeric" />
            </div>
        </div>
        <button class="login-btn" id="pin-btn" onclick="submitPin()">Sign In with PIN</button>
    </div>

    {% if webauthn_available %}
    <!-- ‚îÄ‚îÄ Passkey Panel ‚îÄ‚îÄ -->
    <div class="login-panel" id="panel-passkey">
        <div class="form-group">
            <label for="pk-username">Username</label>
            <input type="text" id="pk-username" autocomplete="username" placeholder="admin" />
        </div>
        <button class="passkey-btn" id="pk-btn" onclick="submitPasskey()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 1C8.7 1 6 3.7 6 7c0 2.4 1.3 4.5 3.3 5.6L8 20h8l-1.3-7.4C16.7 11.5 18 9.4 18 7c0-3.3-2.7-6-6-6z"/>
                <circle cx="12" cy="7" r="2.5" fill="currentColor" stroke="none"/>
            </svg>
            Authenticate with Face ID / Fingerprint
        </button>
        <p class="passkey-info">Uses your device's built-in biometric sensor.<br>No password needed once registered.</p>
    </div>
    {% endif %}

    <div class="setup-link">
        First time? <a href="/admin/setup-page" id="setupLink">Set up admin account</a>
    </div>
</div>

<script>
// ‚îÄ‚îÄ Login page JavaScript ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function showLoginErr(msg) {
    const el = document.getElementById('loginErr');
    el.textContent = msg;
    el.classList.add('show');
}

function hideLoginErr() {
    document.getElementById('loginErr').classList.remove('show');
}

function switchLoginTab(tab) {
    document.querySelectorAll('.login-tab').forEach((t, i) => {
        const panels = ['password', 'pin', 'passkey'];
        t.classList.toggle('active', panels[i] === tab);
    });
    document.querySelectorAll('.login-panel').forEach(p => p.classList.remove('active'));
    const panel = document.getElementById('panel-' + tab);
    if (panel) panel.classList.add('active');
    hideLoginErr();
}

// ‚îÄ‚îÄ Password Login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function submitPassword() {
    hideLoginErr();
    const username = document.getElementById('pw-username').value.trim();
    const password = document.getElementById('pw-password').value;
    const btn = document.getElementById('pw-btn');

    if (!username || !password) {
        showLoginErr('Please enter username and password.');
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Signing in‚Ä¶';

    try {
        const res = await fetch('/admin/auth/password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (data.success) {
            window.location.href = data.redirect || '/admin';
        } else {
            showLoginErr(data.error || 'Invalid credentials. Please try again.');
            btn.disabled = false;
            btn.textContent = 'Sign In';
        }
    } catch (e) {
        showLoginErr('Connection error. Please try again.');
        btn.disabled = false;
        btn.textContent = 'Sign In';
    }
}

// ‚îÄ‚îÄ PIN Login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function setupPinInputs() {
    const cells = document.querySelectorAll('.pin-cell');
    cells.forEach((cell, idx) => {
        cell.addEventListener('input', function() {
            const val = this.value.replace(/[^0-9]/g, '');
            this.value = val.slice(-1);
            if (this.value && idx < cells.length - 1) {
                cells[idx + 1].focus();
            }
            // Auto-submit when all 4‚Äì6 cells filled
            const pin = Array.from(cells).map(c => c.value).join('');
            if (pin.length >= 4 && cells[cells.length - 1].value) {
                submitPin();
            }
        });
        cell.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && !this.value && idx > 0) {
                cells[idx - 1].focus();
                cells[idx - 1].value = '';
            }
            if (e.key === 'Enter') submitPin();
        });
        cell.addEventListener('paste', function(e) {
            e.preventDefault();
            const pasted = (e.clipboardData || window.clipboardData).getData('text').replace(/[^0-9]/g,'');
            pasted.split('').slice(0, cells.length).forEach((ch, i) => {
                if (cells[i]) cells[i].value = ch;
            });
            const last = Math.min(pasted.length, cells.length) - 1;
            if (cells[last]) cells[last].focus();
            if (pasted.length >= 4) setTimeout(submitPin, 100);
        });
    });
})();

async function submitPin() {
    hideLoginErr();
    const username = document.getElementById('pin-username').value.trim();
    const pin = Array.from(document.querySelectorAll('.pin-cell')).map(c => c.value).join('');
    const btn = document.getElementById('pin-btn');

    if (!username) { showLoginErr('Please enter your username.'); return; }
    if (!/^\d{4,6}$/.test(pin)) { showLoginErr('Please enter your full 4‚Äì6 digit PIN.'); return; }

    btn.disabled = true;
    btn.textContent = 'Signing in‚Ä¶';

    try {
        const res = await fetch('/admin/auth/pin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, pin })
        });
        const data = await res.json();
        if (data.success) {
            window.location.href = data.redirect || '/admin';
        } else {
            showLoginErr(data.error || 'Invalid credentials. Please try again.');
            document.querySelectorAll('.pin-cell').forEach(c => c.value = '');
            document.querySelector('.pin-cell').focus();
            btn.disabled = false;
            btn.textContent = 'Sign In with PIN';
        }
    } catch (e) {
        showLoginErr('Connection error. Please try again.');
        btn.disabled = false;
        btn.textContent = 'Sign In with PIN';
    }
}

// ‚îÄ‚îÄ WebAuthn Passkey Login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function submitPasskey() {
    hideLoginErr();
    const username = document.getElementById('pk-username').value.trim();
    const btn = document.getElementById('pk-btn');

    if (!username) { showLoginErr('Please enter your username first.'); return; }

    if (!window.PublicKeyCredential) {
        showLoginErr('This browser or device does not support passkeys. Please use password login.');
        return;
    }

    btn.disabled = true;
    btn.innerHTML = `<span>Waiting for biometric‚Ä¶</span>`;

    try {
        // Step 1: Get authentication options from server
        const beginRes = await fetch('/admin/webauthn/login/begin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username })
        });
        const beginData = await beginRes.json();

        if (!beginData.success) {
            showLoginErr(beginData.error || 'Failed to start passkey authentication.');
            btn.disabled = false;
            btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1C8.7 1 6 3.7 6 7c0 2.4 1.3 4.5 3.3 5.6L8 20h8l-1.3-7.4C16.7 11.5 18 9.4 18 7c0-3.3-2.7-6-6-6z"/><circle cx="12" cy="7" r="2.5" fill="currentColor" stroke="none"/></svg> Authenticate with Face ID / Fingerprint`;
            return;
        }

        const options = beginData.options;

        // Step 2: Decode challenge and credential IDs from base64url
        const publicKeyOptions = {
            challenge: base64urlToBytes(options.challenge),
            rpId: options.rpId,
            timeout: options.timeout || 60000,
            allowCredentials: (options.allowCredentials || []).map(c => ({
                type: 'public-key',
                id: base64urlToBytes(c.id),
            })),
            userVerification: options.userVerification || 'required',
        };

        // Step 3: Trigger device biometric prompt
        const credential = await navigator.credentials.get({ publicKey: publicKeyOptions });

        // Step 4: Send response to server for verification
        const credentialJSON = {
            id: credential.id,
            rawId: bytesToBase64url(new Uint8Array(credential.rawId)),
            type: credential.type,
            response: {
                authenticatorData: bytesToBase64url(new Uint8Array(credential.response.authenticatorData)),
                clientDataJSON: bytesToBase64url(new Uint8Array(credential.response.clientDataJSON)),
                signature: bytesToBase64url(new Uint8Array(credential.response.signature)),
                userHandle: credential.response.userHandle
                    ? bytesToBase64url(new Uint8Array(credential.response.userHandle))
                    : null,
            },
        };

        const completeRes = await fetch('/admin/webauthn/login/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, credential: credentialJSON })
        });
        const completeData = await completeRes.json();

        if (completeData.success) {
            window.location.href = completeData.redirect || '/admin';
        } else {
            showLoginErr(completeData.error || 'Passkey verification failed.');
            btn.disabled = false;
            btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1C8.7 1 6 3.7 6 7c0 2.4 1.3 4.5 3.3 5.6L8 20h8l-1.3-7.4C16.7 11.5 18 9.4 18 7c0-3.3-2.7-6-6-6z"/><circle cx="12" cy="7" r="2.5" fill="currentColor" stroke="none"/></svg> Authenticate with Face ID / Fingerprint`;
        }

    } catch (e) {
        if (e.name === 'NotAllowedError') {
            showLoginErr('Passkey authentication was cancelled or timed out.');
        } else if (e.name === 'SecurityError') {
            showLoginErr('Security error ‚Äî ensure you are on a secure HTTPS connection.');
        } else {
            showLoginErr('Passkey error: ' + e.message);
        }
        btn.disabled = false;
        btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1C8.7 1 6 3.7 6 7c0 2.4 1.3 4.5 3.3 5.6L8 20h8l-1.3-7.4C16.7 11.5 18 9.4 18 7c0-3.3-2.7-6-6-6z"/><circle cx="12" cy="7" r="2.5" fill="currentColor" stroke="none"/></svg> Authenticate with Face ID / Fingerprint`;
    }
}

// ‚îÄ‚îÄ WebAuthn base64url helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function base64urlToBytes(b64url) {
    const b64 = b64url.replace(/-/g,'+').replace(/_/g,'/');
    const bin = atob(b64.padEnd(b64.length + (4 - b64.length % 4) % 4, '='));
    return Uint8Array.from(bin, c => c.charCodeAt(0));
}
function bytesToBase64url(bytes) {
    let bin = '';
    bytes.forEach(b => bin += String.fromCharCode(b));
    return btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}

// Auto-focus first input
document.querySelector('#pw-username').focus();
</script>

{% else %}
<!-- ============================================================
     ADMIN DASHBOARD ‚Äî Only shown when session is authenticated
     ============================================================ -->
<div class="header">
    <h1>Admin Panel ‚Äî Enterprise Travel Pricing</h1>
    <div class="header-right">
        <select class="client-selector" id="globalClientSelector" onchange="onClientChange()">
            <option value="1">Loading clients...</option>
        </select>
        <a href="/" class="btn-logout">‚Üê Back to App</a>
        <a href="/admin/logout" class="btn-logout" style="background:rgba(255,80,80,.25)">üîì Logout</a>
    </div>
</div>

<div class="container">
    <div class="msg" id="message"></div>

    <div class="tabs">
        <button class="tab active" data-tab="clients">üë• Clients</button>
        <button class="tab" data-tab="regions">üåç Regions</button>
        <button class="tab" data-tab="transport">üöå Transport</button>
        <button class="tab" data-tab="destinations">üèîÔ∏è Destinations</button>
        <button class="tab" data-tab="hotels">üè® Hotels</button>
        <button class="tab" data-tab="cabs">üöó Cabs</button>
        <button class="tab" data-tab="cab-dest-rates">üöóüèîÔ∏è Cab-Dest</button>
        <button class="tab" data-tab="addons">‚ûï Add-ons</button>
        <button class="tab" data-tab="pricing-rules">üìê Rules</button>
        <button class="tab" data-tab="global-rules">‚öôÔ∏è Global</button>
    </div>

    <!-- ===== CLIENTS TAB ===== -->
    <div class="tab-content active" id="clients">
        <div class="section-card">
            <div class="section-header">Create New Client</div>
            <form id="clientForm">
                <div class="form-grid">
                    <div class="form-group"><label>Client Name <span class="req">*</span></label><input type="text" name="name" required placeholder="e.g., AKS Hospitality"></div>
                    <div class="form-group"><label>Code <span class="req">*</span></label><input type="text" name="code" required placeholder="e.g., aks-hospitality"></div>
                    <div class="form-group"><label>Email</label><input type="email" name="contact_email" placeholder="admin@example.com"></div>
                    <div class="form-group"><label>Phone</label><input type="text" name="contact_phone" placeholder="+91..."></div>
                    <div class="form-group"><label>Default Currency</label><input type="text" name="currency_default" value="INR" placeholder="INR"></div>
                </div>
                <button type="submit" class="btn" style="margin-top:12px">Create Client</button>
            </form>
        </div>
        <div class="section-card">
            <div class="section-header">All Clients</div>
            <div class="table-container"><table id="clientsTable"><thead><tr><th>ID</th><th>Name</th><th>Code</th><th>Email</th><th>Currency</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <!-- ===== REGIONS TAB ===== -->
    <div class="tab-content" id="regions">
        <div class="section-card">
            <div class="section-header">Create New Region</div>
            <form id="regionForm">
                <div class="form-grid">
                    <div class="form-group"><label>Region Name <span class="req">*</span></label><input type="text" name="name" required placeholder="e.g., North India"></div>
                    <div class="form-group">
                        <label>Region Type <span class="req">*</span></label>
                        <select name="is_domestic" required>
                            <option value="true">Domestic</option>
                            <option value="false">International</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Currency</label><input type="text" name="currency" value="INR"></div>
                    <div class="form-group"><label>Service %</label><input type="number" step="0.01" name="service_percent" value="15"></div>
                    <div class="form-group"><label>Booking %</label><input type="number" step="0.01" name="booking_percent" value="12"></div>
                </div>
                <button type="submit" class="btn" style="margin-top:12px">Create Region</button>
            </form>
        </div>

        <div class="section-card">
            <div class="region-section-divider">
                <div class="region-section-title">üáÆüá≥ Domestic Regions</div>
            </div>
            <div class="table-container">
                <table id="domesticRegionsTable">
                    <thead><tr><th>ID</th><th>Name</th><th>Currency</th><th>Service%</th><th>Booking%</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="section-card">
            <div class="region-section-divider">
                <div class="region-section-title">üåé International Regions</div>
            </div>
            <div class="table-container">
                <table id="internationalRegionsTable">
                    <thead><tr><th>ID</th><th>Name</th><th>Currency</th><th>Service%</th><th>Booking%</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ===== TRANSPORT TAB ===== -->
    <div class="tab-content" id="transport">
        <div class="section-card">
            <div class="section-header">Create New Transport</div>
            <form id="transportForm">
                <div class="form-grid">
                    <div class="form-group"><label>Region <span class="req">*</span></label><select name="region_id" required id="transportRegion"></select></div>
                    <div class="form-group"><label>Transport Name <span class="req">*</span></label><input type="text" name="name" required placeholder="Volvo AC Bus"></div>
                    <div class="form-group">
                        <label>Trip Type <span class="req">*</span></label>
                        <select name="trip_type" id="transportTripType" required onchange="onTripTypeChange('transportTripType','transportReturnMultiplierGrp')">
                            <option value="">Select Trip Type</option>
                            <option value="one_way">One Way</option>
                            <option value="return">Return</option>
                            <option value="both">Both</option>
                        </select>
                    </div>
                    <div class="form-group multiplier-group hidden-field" id="transportReturnMultiplierGrp">
                        <label>Return Rate Multiplier <span class="req">*</span></label>
                        <input type="number" step="0.01" name="return_rate_multiplier" id="transportReturnMultiplier" value="1.8" min="0" placeholder="1.8">
                    </div>
                </div>
                <div class="rate-grid">
                    <div class="rate-section">
                        <div class="rate-section-title">Peak Season</div>
                        <div class="form-group"><label>Adult Rate</label><input type="number" step="0.01" name="adult_rate_peak" value="0"></div>
                        <div class="form-group" style="margin-top:8px"><label>Child Rate</label><input type="number" step="0.01" name="child_rate_peak" value="0"></div>
                        <div class="form-group" style="margin-top:8px">
                            <label>Pricing Type</label>
                            <select name="peak_pricing_type">
                                <option value="per_person">Per Person</option>
                                <option value="per_vehicle">Per Vehicle (Full Transport Cost)</option>
                            </select>
                        </div>
                    </div>
                    <div class="rate-section">
                        <div class="rate-section-title">Off Season</div>
                        <div class="form-group"><label>Adult Rate</label><input type="number" step="0.01" name="adult_rate_off" value="0"></div>
                        <div class="form-group" style="margin-top:8px"><label>Child Rate</label><input type="number" step="0.01" name="child_rate_off" value="0"></div>
                        <div class="form-group" style="margin-top:8px">
                            <label>Pricing Type</label>
                            <select name="off_pricing_type">
                                <option value="per_person">Per Person</option>
                                <option value="per_vehicle">Per Vehicle (Full Transport Cost)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn" style="margin-top:16px">Create Transport</button>
            </form>
        </div>
        <div class="section-card">
            <div class="section-header">All Transports</div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all" onclick="setRegionFilter('all')">All Regions</button>
                <button class="filter-btn" data-filter="domestic" onclick="setRegionFilter('domestic')">üáÆüá≥ Domestic</button>
                <button class="filter-btn" data-filter="international" onclick="setRegionFilter('international')">üåé International</button>
            </div>
            <div class="table-container"><table id="transportsTable"><thead><tr><th>ID</th><th>Region</th><th>Name</th><th>Trip Type</th><th>Return Mult.</th><th>Peak Adult</th><th>Peak Child</th><th>Peak Type</th><th>Off Adult</th><th>Off Child</th><th>Off Type</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <!-- ===== DESTINATIONS TAB ===== -->
    <div class="tab-content" id="destinations">
        <div class="section-card">
            <div class="section-header">Create New Destination</div>
            <form id="destinationForm">
                <div class="form-grid">
                    <div class="form-group"><label>Region <span class="req">*</span></label><select name="region_id" required id="destRegion"></select></div>
                    <div class="form-group"><label>Name <span class="req">*</span></label><input type="text" name="name" required placeholder="Manali"></div>
                    <div class="form-group"><label>Base Rate</label><input type="number" step="0.01" name="base_rate" value="0"></div>
                    <div class="form-group"><label>Per-Day Rate</label><input type="number" step="0.01" name="per_day_rate" value="0"></div>
                </div>
                <label class="checkbox-label"><input type="checkbox" name="is_special" value="1"> Special Destination</label>
                <button type="submit" class="btn" style="margin-top:12px">Create Destination</button>
            </form>
        </div>
        <div class="section-card">
            <div class="section-header">All Destinations</div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all" onclick="setRegionFilter('all')">All Regions</button>
                <button class="filter-btn" data-filter="domestic" onclick="setRegionFilter('domestic')">üáÆüá≥ Domestic</button>
                <button class="filter-btn" data-filter="international" onclick="setRegionFilter('international')">üåé International</button>
            </div>
            <div class="table-container"><table id="destinationsTable"><thead><tr><th>ID</th><th>Region</th><th>Name</th><th>Base</th><th>Per-Day</th><th>Special</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <!-- ===== HOTELS TAB ===== -->
    <div class="tab-content" id="hotels">
        <div class="section-card">
            <div class="section-header">Create New Hotel</div>
            <form id="hotelForm">
                <div class="form-grid">
                    <div class="form-group"><label>Region <span class="req">*</span></label><select name="region_id" required id="hotelRegion"></select></div>
                    <div class="form-group"><label>Hotel Name <span class="req">*</span></label><input type="text" name="name" required placeholder="Hotel Paradise"></div>
                    <div class="form-group"><label>Sharing Type</label>
                        <select name="sharing_type" id="sharingType">
                            <option value="DOUBLE">Double (2)</option><option value="QUAD">Quad (4)</option><option value="CUSTOM">Custom</option>
                        </select>
                    </div>
                    <div class="form-group" id="customCapGrp" style="display:none"><label>Custom Capacity</label><input type="number" name="custom_capacity" placeholder="3"></div>
                </div>
                <div class="rate-grid">
                    <div class="rate-section"><div class="rate-section-title">Peak Season</div>
                        <div class="form-group"><label>Adult Rate</label><input type="number" step="0.01" name="adult_rate_peak" value="0"></div>
                        <div class="form-group" style="margin-top:8px"><label>Child Rate</label><input type="number" step="0.01" name="child_rate_peak" value="0"></div>
                    </div>
                    <div class="rate-section"><div class="rate-section-title">Off Season</div>
                        <div class="form-group"><label>Adult Rate</label><input type="number" step="0.01" name="adult_rate_off" value="0"></div>
                        <div class="form-group" style="margin-top:8px"><label>Child Rate</label><input type="number" step="0.01" name="child_rate_off" value="0"></div>
                    </div>
                </div>
                <button type="submit" class="btn" style="margin-top:16px">Create Hotel</button>
            </form>
        </div>
        <div class="section-card">
            <div class="section-header">All Hotels</div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all" onclick="setRegionFilter('all')">All Regions</button>
                <button class="filter-btn" data-filter="domestic" onclick="setRegionFilter('domestic')">üáÆüá≥ Domestic</button>
                <button class="filter-btn" data-filter="international" onclick="setRegionFilter('international')">üåé International</button>
            </div>
            <div class="table-container"><table id="hotelsTable"><thead><tr><th>ID</th><th>Region</th><th>Name</th><th>Sharing</th><th>Peak Adult</th><th>Peak Child</th><th>Off Adult</th><th>Off Child</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <!-- ===== CABS TAB ===== -->
    <div class="tab-content" id="cabs">
        <div class="section-card">
            <div class="section-header">Create New Cab</div>
            <form id="cabForm">
                <div class="form-grid">
                    <div class="form-group"><label>Region <span class="req">*</span></label><select name="region_id" required id="cabRegion"></select></div>
                    <div class="form-group"><label>Cab Name <span class="req">*</span></label><input type="text" name="name" required placeholder="Alto"></div>
                    <div class="form-group"><label>Base Rate</label><input type="number" step="0.01" name="base_rate" value="0"></div>
                    <div class="form-group"><label>Per-Day Rate</label><input type="number" step="0.01" name="per_day_rate" value="0"></div>
                </div>
                <button type="submit" class="btn" style="margin-top:12px">Create Cab</button>
            </form>
        </div>
        <div class="section-card">
            <div class="section-header">All Cabs</div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all" onclick="setRegionFilter('all')">All Regions</button>
                <button class="filter-btn" data-filter="domestic" onclick="setRegionFilter('domestic')">üáÆüá≥ Domestic</button>
                <button class="filter-btn" data-filter="international" onclick="setRegionFilter('international')">üåé International</button>
            </div>
            <div class="table-container"><table id="cabsTable"><thead><tr><th>ID</th><th>Region</th><th>Name</th><th>Base</th><th>Per-Day</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <!-- ===== CAB-DEST RATES TAB ===== -->
    <div class="tab-content" id="cab-dest-rates">
        <div class="section-card">
            <div class="info-box"><strong>Cab-Destination Rate Matrix</strong> ‚Äî Set specific rates for each cab √ó destination combination. Every active cab and destination is shown. Edit any cell and click <strong>Save All Changes</strong>.</div>
            <div class="section-header">Create / Update Rate</div>
            <form id="cabDestRateForm">
                <div class="form-grid">
                    <div class="form-group"><label>Cab <span class="req">*</span></label><select name="cab_id" required id="cdrCab"><option value="">Select Cab</option></select></div>
                    <div class="form-group"><label>Destination <span class="req">*</span></label><select name="destination_id" required id="cdrDest"><option value="">Select Destination</option></select></div>
                    <div class="form-group"><label>Rate</label><input type="number" step="0.01" name="rate" value="0" placeholder="0"></div>
                    <div class="form-group"><label>Override Rate</label><input type="number" step="0.01" name="override_rate" value="" placeholder="Leave blank for default"></div>
                </div>
                <button type="submit" class="btn" style="margin-top:12px">Save Rate</button>
            </form>
        </div>
        <div class="section-card">
            <div class="section-header">Rate Matrix (All Cabs √ó All Destinations)</div>
            <div id="matrixSaveBar" class="matrix-save-bar" style="display:none">
                <button class="btn" onclick="saveMatrixChanges()">Save All Changes</button>
                <span class="changes-count" id="matrixChangesCount">0 unsaved changes</span>
                <button class="btn btn-secondary btn-sm" onclick="discardMatrixChanges()">Discard</button>
            </div>
            <div class="table-container" id="matrixContainer">
                <div class="empty-state"><div class="empty-state-icon">üöóüèîÔ∏è</div>Loading matrix...</div>
            </div>
        </div>
    </div>

    <!-- ===== ADDONS TAB ===== -->
    <div class="tab-content" id="addons">
        <div class="section-card">
            <div class="section-header">Create New Add-on</div>
            <form id="addonForm">
                <div class="form-grid">
                    <div class="form-group"><label>Region <span class="req">*</span></label><select name="region_id" required id="addonRegion"><option value="">Select Region</option></select></div>
                    <div class="form-group"><label>Name <span class="req">*</span></label><input type="text" name="name" required placeholder="Travel Insurance"></div>
                    <div class="form-group">
                        <label>Add-on Type <span class="req">*</span></label>
                        <select name="addon_type" required>
                            <option value="GENERAL">General</option>
                            <option value="INSURANCE">Insurance</option>
                            <option value="MEAL">Meal</option>
                            <option value="ACTIVITY">Activity</option>
                            <option value="TRANSPORT">Transport</option>
                            <option value="EQUIPMENT">Equipment</option>
                            <option value="SERVICE">Service</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Pricing Type</label>
                        <select name="pricing_type"><option value="flat">Flat</option><option value="per_person">Per Person</option><option value="per_day">Per Day</option><option value="per_night">Per Night</option></select>
                    </div>
                </div>
                <div class="rate-grid">
                    <div class="rate-section">
                        <div class="rate-section-title">Peak Season</div>
                        <div class="form-group"><label>Peak Rate</label><input type="number" step="0.01" name="rate_peak" value="0"></div>
                    </div>
                    <div class="rate-section">
                        <div class="rate-section-title">Off Season</div>
                        <div class="form-group"><label>Off Rate</label><input type="number" step="0.01" name="rate_off" value="0"></div>
                    </div>
                </div>
                <button type="submit" class="btn" style="margin-top:16px">Create Add-on</button>
            </form>
        </div>
        <div class="section-card">
            <div class="section-header">All Add-ons</div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all" onclick="setRegionFilter('all')">All Regions</button>
                <button class="filter-btn" data-filter="domestic" onclick="setRegionFilter('domestic')">üáÆüá≥ Domestic</button>
                <button class="filter-btn" data-filter="international" onclick="setRegionFilter('international')">üåé International</button>
            </div>
            <div class="table-container"><table id="addonsTable"><thead><tr><th>ID</th><th>Region</th><th>Name</th><th>Type</th><th>Pricing</th><th>Peak Rate</th><th>Off Rate</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <!-- ===== PRICING RULES TAB ===== -->
    <div class="tab-content" id="pricing-rules">
        <div class="section-card">
            <div class="info-box">
                <strong>Dynamic Pricing Rules</strong> ‚Äî Rules are evaluated in priority order. Conditions are checked against the booking context. Actions modify component costs BEFORE service/booking charges are applied.
            </div>

            <div class="info-box-ai">
                <strong>ü§ñ AI Rule Builder</strong> ‚Äî Describe your pricing rule in plain English and let AI generate the structured conditions and actions for you. The AI will ask clarifying questions if your description is ambiguous.
            </div>
            <div class="nl-rule-container">
                <textarea class="nl-rule-input" id="nlRuleInput" placeholder="Describe your rule in plain English, e.g. &quot;Increase hotel rate by 10% during peak season for groups of 6 or more adults&quot;"></textarea>
                <div class="nl-rule-actions">
                    <button type="button" class="btn btn-ai" onclick="parseNaturalLanguageRule()" id="aiParseBtn">ü§ñ Generate Rule from Description</button>
                    <span id="nlRuleStatusInline" style="font-size:12px;color:#888"></span>
                </div>
                <div class="nl-rule-status" id="nlRuleStatus"></div>
                <div class="clarification-box" id="clarificationBox">
                    <strong>‚ö†Ô∏è Clarification Needed:</strong>
                    <p id="clarificationQuestion"></p>
                </div>
                <div class="nl-rule-examples">
                    Examples:
                    <code>Increase hotel rate by 10% during peak season</code>
                    <code>Decrease transport cost by 15% for groups of 6+ adults</code>
                    <code>Add flat fee of 500 when nights &gt;= 3</code>
                    <code>Apply 5% margin on total for off season</code>
                    <code>Decrease cab cost by 10% for 4+ nights</code>
                </div>
            </div>

            <div class="section-header">Create New Rule</div>
            <form id="ruleForm">
                <div class="form-grid">
                    <div class="form-group"><label>Rule Name <span class="req">*</span></label><input type="text" name="name" required id="ruleName" placeholder="Peak season surcharge"></div>
                    <div class="form-group"><label>Entity Type</label>
                        <select name="entity_type" id="ruleEntityType"><option value="global">Global</option><option value="hotel">Hotel</option><option value="transport">Transport</option><option value="cab">Cab</option><option value="destination">Destination</option><option value="addon">Add-on</option></select>
                    </div>
                    <div class="form-group"><label>Entity ID (optional)</label><input type="number" name="entity_id" id="ruleEntityId" placeholder="Leave empty for all"></div>
                    <div class="form-group"><label>Priority (lower = first)</label><input type="number" name="priority" id="rulePriority" value="100"></div>
                </div>
                <div class="form-group"><label>Description</label><textarea name="description" id="ruleDescription" placeholder="What this rule does..."></textarea></div>
                <div class="form-grid" style="margin-top:12px">
                    <div class="form-group">
                        <label>Conditions (JSON)</label>
                        <textarea class="json-editor" name="conditions_json" id="ruleConditions" placeholder='{"season": "ON", "adults_gte": 4}'>{}</textarea>
                        <small style="color:#999;margin-top:4px;display:block;font-size:11px">Keys: season, adults_gte, adults_lte, children_gte, nights_gte, nights_lte, hotel, transport, pax_gte, region_id</small>
                    </div>
                    <div class="form-group">
                        <label>Actions (JSON)</label>
                        <textarea class="json-editor" name="actions_json" id="ruleActions" placeholder='{"type": "increase_rate_percent", "target": "hotel", "value": 10}'>{}</textarea>
                        <small style="color:#999;margin-top:4px;display:block;font-size:11px">Types: increase_rate_percent, decrease_rate_percent, override_rate, add_flat_fee, apply_margin. Targets: hotel, transport, sightseeing, cab, addon, total</small>
                    </div>
                </div>
                <label class="checkbox-label"><input type="checkbox" name="stackable" value="1" id="ruleStackable" checked> Stackable (can combine with other rules)</label>
                <button type="submit" class="btn" style="margin-top:12px">Create Rule</button>
            </form>
        </div>
        <div class="section-card">
            <div class="section-header">All Pricing Rules</div>
            <div class="table-container"><table id="rulesTable"><thead><tr><th>ID</th><th>Name</th><th>Type</th><th>Entity</th><th>Priority</th><th>Stackable</th><th>Conditions</th><th>Actions</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <!-- ===== GLOBAL RULES TAB ===== -->
    <div class="tab-content" id="global-rules">
        <div class="section-card">
            <div class="section-header">Global Pricing Configuration</div>
            <form id="globalRulesForm">
                <div class="form-grid">
                    <div class="form-group"><label>Service Charge %</label><input type="number" step="0.01" name="service_charge" value="15"></div>
                    <div class="form-group"><label>Booking Charge %</label><input type="number" step="0.01" name="booking_charge" value="12"></div>
                    <div class="form-group"><label>Tax %</label><input type="number" step="0.01" name="tax" value="0"></div>
                    <div class="form-group"><label>Default Margin %</label><input type="number" step="0.01" name="default_margin" value="0"></div>
                    <div class="form-group"><label>Default Cancellation %</label><input type="number" step="0.01" name="default_cancellation" value="0"></div>
                </div>
                <button type="submit" class="btn" style="margin-top:12px">Save Global Rules</button>
            </form>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal" id="editModal">
    <div class="modal-content">
        <div class="modal-header" id="editModalTitle">Edit</div>
        <div id="editModalBody"></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn" id="saveEditBtn">Save</button>
        </div>
    </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal" id="confirmModal">
    <div class="modal-content confirm-modal-content">
        <div class="modal-header">‚ö†Ô∏è Confirm Delete</div>
        <div id="confirmModalBody">
            <p class="confirm-modal-msg">Are you sure you want to permanently delete this item?</p>
            <p class="confirm-modal-detail">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
    </div>
</div>

<script>
const API = window.location.origin;
let currentClientId = 1;
let allClients=[], allRegions=[], allTransports=[], allDestinations=[], allHotels=[], allCabs=[], allAddons=[], allCabDestRates=[], allRules=[];
let currentEditItem=null, currentEditType=null;
let matrixPendingChanges = {};

let regionTypeFilter = 'all';

// ===== TAB SWITCH =====
document.querySelectorAll('.tab').forEach(t => {
    t.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        document.getElementById(t.dataset.tab).classList.add('active');
        t.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'});
    });
});

function showMsg(text, type='success') {
    const m = document.getElementById('message');
    m.textContent = text; m.className = `msg ${type} show`;
    setTimeout(() => m.classList.remove('show'), 5000);
    window.scrollTo({top:0,behavior:'smooth'});
}
function closeModal() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('show')); }

document.getElementById('sharingType').addEventListener('change', e => {
    document.getElementById('customCapGrp').style.display = e.target.value === 'CUSTOM' ? 'block' : 'none';
});

function onClientChange() {
    currentClientId = parseInt(document.getElementById('globalClientSelector').value);
    loadAll();
}

function cq(url) { return url + (url.includes('?') ? '&' : '?') + `client_id=${currentClientId}`; }

async function loadAll() {
    await loadClients();
    await Promise.all([loadRegions(), loadTransports(), loadDestinations(), loadHotels(), loadCabs(), loadAddons(), loadCabDestMatrix(), loadRules(), loadGlobalRules()]);
}

function getRegionById(regionId) {
    return allRegions.find(r => r.id === regionId);
}

function matchesRegionFilter(entity) {
    if (regionTypeFilter === 'all') return true;
    const region = getRegionById(entity.region_id);
    if (!region) return true;
    if (regionTypeFilter === 'domestic') return region.is_domestic === true;
    if (regionTypeFilter === 'international') return region.is_domestic === false;
    return true;
}

function setRegionFilter(filter) {
    regionTypeFilter = filter;
    document.querySelectorAll('.filter-btn').forEach(btn => {
        if (btn.dataset.filter === filter) btn.classList.add('active');
        else btn.classList.remove('active');
    });
    displayTransports();
    displayDestinations();
    displayHotels();
    displayCabs();
    displayAddons();
}

// ===== TRIP TYPE TOGGLE =====
function onTripTypeChange(selectId, multiplierGrpId) {
    const val = document.getElementById(selectId).value;
    const grp = document.getElementById(multiplierGrpId);
    const input = grp ? grp.querySelector('input') : null;
    if (!grp) return;
    if (val === 'one_way' || val === '') {
        grp.classList.add('hidden-field');
        if (input) input.removeAttribute('required');
    } else {
        grp.classList.remove('hidden-field');
        if (input) input.setAttribute('required', 'required');
    }
}

// ===== HARD DELETE WITH CONFIRM MODAL + DOM REMOVAL =====
let _pendingDeleteResolve = null;

function confirmDelete(message, detail) {
    return new Promise((resolve) => {
        _pendingDeleteResolve = resolve;
        const body = document.getElementById('confirmModalBody');
        body.innerHTML = `<p class="confirm-modal-msg">${message}</p><p class="confirm-modal-detail">${detail || 'This action cannot be undone.'}</p>`;
        document.getElementById('confirmModal').classList.add('show');
        document.getElementById('confirmDeleteBtn').onclick = () => {
            closeModal();
            resolve(true);
        };
    });
}

async function deleteEntity(type, id, rowEl) {
    const confirmed = await confirmDelete(
        'Are you sure you want to permanently delete this item?',
        `Type: ${type} | ID: ${id} ‚Äî This action cannot be undone.`
    );
    if (!confirmed) return;

    try {
        const res = await fetch(`${API}/api/${type}/${id}`, {method:'DELETE'});
        let errMsg = 'Failed to delete';
        if (!res.ok) {
            try { const err = await res.json(); errMsg = err.error || errMsg; } catch(e) {}
            showMsg(errMsg, 'error');
            return;
        }
        showMsg('Item deleted successfully');
        // Remove the row from DOM if provided
        if (rowEl) {
            const tr = rowEl.closest('tr');
            if (tr) {
                tr.style.transition = 'opacity 0.3s';
                tr.style.opacity = '0';
                setTimeout(() => tr.remove(), 300);
            }
        } else {
            // Fallback: reload the relevant section
            await loadAll();
        }
    } catch (e) {
        console.error('Delete error:', e);
        showMsg('Failed to delete ‚Äî network error', 'error');
    }
}

// Close modal on backdrop click
document.getElementById('confirmModal').addEventListener('click', function(e){
    if(e.target === this) { closeModal(); }
});
document.getElementById('editModal').addEventListener('click', function(e){
    if(e.target === this) closeModal();
});

// ===== CLIENTS =====
async function loadClients() {
    try {
        const res = await fetch(`${API}/api/clients`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        allClients = await res.json();
        displayClients();
        const sel = document.getElementById('globalClientSelector');
        sel.innerHTML = allClients.map(c => `<option value="${c.id}" ${c.id===currentClientId?'selected':''}>${c.name}</option>`).join('');
    } catch (e) {
        console.error('Load clients error:', e);
        showMsg('Failed to load clients', 'error');
    }
}

function displayClients() {
    const tb = document.querySelector('#clientsTable tbody');
    tb.innerHTML = allClients.map(c => `<tr class="${c.active?'':'inactive'}" id="client-row-${c.id}">
        <td>${c.id}</td><td>${c.name}</td><td>${c.code}</td><td>${c.contact_email||'-'}</td><td>${c.currency_default}</td>
        <td><span class="badge ${c.active?'badge-active':'badge-inactive'}">${c.active?'Active':'Inactive'}</span></td>
        <td><div class="actions">
            <label class="toggle-switch"><input type="checkbox" ${c.active?'checked':''} onchange="toggleEntity('clients',${c.id},this.checked)"><span class="toggle-slider"></span></label>
            <button class="btn btn-sm" onclick="editClient(${c.id})">Edit</button>
            ${c.id!==1?`<button class="btn btn-sm btn-danger" onclick="deleteEntity('clients',${c.id},this)">Del</button>`:''}
        </div></td></tr>`).join('');
}

document.getElementById('clientForm').addEventListener('submit', async e => {
    e.preventDefault();
    try {
        const d = Object.fromEntries(new FormData(e.target));
        const res = await fetch(`${API}/api/clients`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
        if(res.ok){showMsg('Client created');e.target.reset();await loadClients();}else{const err=await res.json();showMsg(err.error||'Failed','error');}
    } catch (e) {
        console.error('Create client error:', e);
        showMsg('Failed to create client', 'error');
    }
});

function editClient(id) {
    const c = allClients.find(x=>x.id===id); currentEditItem=c; currentEditType='client';
    document.getElementById('editModalBody').innerHTML = `
        <div class="form-grid">
            <div class="form-group"><label>Name</label><input type="text" id="editName" value="${c.name}"></div>
            <div class="form-group"><label>Code</label><input type="text" id="editCode" value="${c.code}"></div>
            <div class="form-group"><label>Email</label><input type="email" id="editEmail" value="${c.contact_email||''}"></div>
            <div class="form-group"><label>Phone</label><input type="text" id="editPhone" value="${c.contact_phone||''}"></div>
            <div class="form-group"><label>Currency</label><input type="text" id="editCurrency" value="${c.currency_default}"></div>
        </div>`;
    document.getElementById('editModalTitle').textContent='Edit Client';
    document.getElementById('editModal').classList.add('show');
}

/**
 * Point 2 (v4.0): Fixed toggleEntity
 *
 * Changes:
 *   1. Properly awaits the fetch ‚Äî no race condition between toggle and loadAll
 *   2. Backend now returns {success, active, message} ‚Äî use returned active state
 *   3. Instead of full loadAll() reload, updates the in-memory cached array and
 *      re-renders only the specific entity table. This eliminates race conditions.
 */
async function toggleEntity(type, id, active) {
    // Map API type to the in-memory array and re-render function for targeted update
    const typeMap = {
        'clients':       { arr: () => allClients,      set: v => { allClients = v; },      render: displayClients },
        'regions':       { arr: () => allRegions,       set: v => { allRegions = v; },       render: displayRegions },
        'transports':    { arr: () => allTransports,    set: v => { allTransports = v; },    render: displayTransports },
        'hotels':        { arr: () => allHotels,        set: v => { allHotels = v; },        render: displayHotels },
        'destinations':  { arr: () => allDestinations,  set: v => { allDestinations = v; },  render: displayDestinations },
        'cabs':          { arr: () => allCabs,          set: v => { allCabs = v; },          render: displayCabs },
        'addons':        { arr: () => allAddons,        set: v => { allAddons = v; },        render: displayAddons },
        'pricing-rules': { arr: () => allPricingRules,  set: v => { allPricingRules = v; },  render: displayPricingRules },
    };

    try {
        const res = await fetch(`${API}/api/${type}/${id}/toggle`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ active })
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        const actualActive = data.active !== undefined ? data.active : active;

        // Update the in-memory cached array ‚Äî no full reload needed
        const mapping = typeMap[type];
        if (mapping) {
            const arr = mapping.arr();
            if (Array.isArray(arr)) {
                const updated = arr.map(item => item.id === id ? { ...item, active: actualActive } : item);
                mapping.set(updated);
                // Re-render only the affected table
                if (typeof mapping.render === 'function') {
                    mapping.render();
                }
            }
        }

        showMsg(data.message || 'Status updated');

    } catch (e) {
        console.error('Toggle error:', e);
        showMsg('Failed to toggle status', 'error');
        // On error: revert checkbox and reload to ensure consistent state
        await loadAll();
    }
}

// ===== REGIONS =====
async function loadRegions() {
    try {
        const res = await fetch(cq(`${API}/api/regions`));
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        allRegions = await res.json();
        displayRegions();
        updateRegionSelects();
    } catch (e) {
        console.error('Load regions error:', e);
        showMsg('Failed to load regions', 'error');
    }
}

function displayRegions() {
    const domesticRegions = allRegions.filter(r => r.is_domestic === true);
    const internationalRegions = allRegions.filter(r => r.is_domestic === false);

    const domTb = document.querySelector('#domesticRegionsTable tbody');
    if (domesticRegions.length === 0) {
        domTb.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999;padding:24px">No domestic regions yet</td></tr>';
    } else {
        domTb.innerHTML = domesticRegions.map(r => renderRegionRow(r)).join('');
    }

    const intlTb = document.querySelector('#internationalRegionsTable tbody');
    if (internationalRegions.length === 0) {
        intlTb.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999;padding:24px">No international regions yet</td></tr>';
    } else {
        intlTb.innerHTML = internationalRegions.map(r => renderRegionRow(r)).join('');
    }
}

function renderRegionRow(r) {
    return `<tr class="${r.active?'':'inactive'}" id="region-row-${r.id}">
        <td>${r.id}</td><td>${r.name}</td><td>${r.currency}</td><td>${r.service_percent}%</td><td>${r.booking_percent}%</td>
        <td><span class="badge ${r.active?'badge-active':'badge-inactive'}">${r.active?'Active':'Inactive'}</span></td>
        <td><div class="actions">
            <label class="toggle-switch"><input type="checkbox" ${r.active?'checked':''} onchange="toggleEntity('regions',${r.id},this.checked)"><span class="toggle-slider"></span></label>
            <button class="btn btn-sm" onclick="editRegion(${r.id})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteEntity('regions',${r.id},this)">Del</button>
        </div></td></tr>`;
}

function updateRegionSelects() {
    ['transportRegion','destRegion','hotelRegion','cabRegion','addonRegion'].forEach(id => {
        const s=document.getElementById(id); if(!s) return;
        const v=s.value;
        s.innerHTML='<option value="">Select Region</option>'+allRegions.filter(r=>r.active).map(r=>`<option value="${r.id}">${r.name} ${r.is_domestic?'üáÆüá≥':'üåé'}</option>`).join('');
        if(v) s.value=v;
    });
}

document.getElementById('regionForm').addEventListener('submit', async e => {
    e.preventDefault();
    try {
        const fd=new FormData(e.target);
        const d=Object.fromEntries(fd);
        d.client_id=currentClientId;
        const res=await fetch(`${API}/api/regions`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
        if(res.ok){showMsg('Region created');e.target.reset();await loadRegions();}else{const err=await res.json();showMsg(err.error||'Failed','error');}
    } catch (e) {
        console.error('Create region error:', e);
        showMsg('Failed to create region', 'error');
    }
});

function editRegion(id) {
    const r=allRegions.find(x=>x.id===id); currentEditItem=r; currentEditType='region';
    document.getElementById('editModalBody').innerHTML = `<div class="form-grid">
        <div class="form-group"><label>Name</label><input type="text" id="editName" value="${r.name}"></div>
        <div class="form-group"><label>Currency</label><input type="text" id="editCurrency" value="${r.currency}"></div>
        <div class="form-group"><label>Region Type</label>
            <select id="editRegionType">
                <option value="true" ${r.is_domestic?'selected':''}>Domestic</option>
                <option value="false" ${!r.is_domestic?'selected':''}>International</option>
            </select>
        </div>
        <div class="form-group"><label>Service %</label><input type="number" step="0.01" id="editSP" value="${r.service_percent}"></div>
        <div class="form-group"><label>Booking %</label><input type="number" step="0.01" id="editBP" value="${r.booking_percent}"></div>
    </div>`;
    document.getElementById('editModalTitle').textContent='Edit Region';
    document.getElementById('editModal').classList.add('show');
}

// ===== TRANSPORTS =====
async function loadTransports() {
    try {
        const res=await fetch(cq(`${API}/api/transports`));
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        allTransports=await res.json();
        displayTransports();
    } catch (e) {
        console.error('Load transports error:', e);
        showMsg('Failed to load transports', 'error');
    }
}

function displayTransports() {
    const filtered = allTransports.filter(t => matchesRegionFilter(t));
    const tb=document.querySelector('#transportsTable tbody');
    if (filtered.length === 0) {
        tb.innerHTML = '<tr><td colspan="13" style="text-align:center;color:#999;padding:24px">No transports found for selected filter</td></tr>';
        return;
    }
    tb.innerHTML=filtered.map(t=>{
        const r=getRegionById(t.region_id);
        const regionBadge = r ? (r.is_domestic ? ' üáÆüá≥' : ' üåé') : '';
        const tripType = t.trip_type || 'one_way';
        const retMult = (tripType !== 'one_way' && t.return_rate_multiplier != null) ? t.return_rate_multiplier : '-';
        return `<tr class="${t.active?'':'inactive'}" id="transport-row-${t.id}">
        <td>${t.id}</td><td>${r?r.name:'-'}${regionBadge}</td><td>${t.name}</td>
        <td><span class="badge badge-domestic">${tripType}</span></td>
        <td>${retMult}</td>
        <td>${t.adult_rate_peak}</td><td>${t.child_rate_peak}</td><td>${t.peak_pricing_type||'per_person'}</td>
        <td>${t.adult_rate_off}</td><td>${t.child_rate_off}</td><td>${t.off_pricing_type||'per_person'}</td>
        <td><span class="badge ${t.active?'badge-active':'badge-inactive'}">${t.active?'Active':'Inactive'}</span></td>
        <td><div class="actions">
            <label class="toggle-switch"><input type="checkbox" ${t.active?'checked':''} onchange="toggleEntity('transports',${t.id},this.checked)"><span class="toggle-slider"></span></label>
            <button class="btn btn-sm" onclick="editTransport(${t.id})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteEntity('transports',${t.id},this)">Del</button>
        </div></td></tr>`;
    }).join('');
}

document.getElementById('transportForm').addEventListener('submit', async e => {
    e.preventDefault();
    const tripTypeVal = document.getElementById('transportTripType').value;
    if (!tripTypeVal) { showMsg('Please select a Trip Type', 'error'); return; }

    const multInput = document.getElementById('transportReturnMultiplier');
    let returnMultiplier = parseFloat(multInput.value);

    if (tripTypeVal === 'one_way') {
        returnMultiplier = 1.0;
    } else {
        if (isNaN(returnMultiplier)) { showMsg('Return Rate Multiplier must be a number', 'error'); return; }
    }

    try {
        const d=Object.fromEntries(new FormData(e.target));
        d.client_id=currentClientId;
        d.trip_type = tripTypeVal;
        d.return_rate_multiplier = returnMultiplier;
        const res=await fetch(`${API}/api/transports`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
        if(res.ok){showMsg('Transport created');e.target.reset();document.getElementById('transportReturnMultiplierGrp').classList.add('hidden-field');await loadTransports();}else{const err=await res.json();showMsg(err.error||'Failed','error');}
    } catch (e) {
        console.error('Create transport error:', e);
        showMsg('Failed to create transport', 'error');
    }
});

function editTransport(id) {
    const t = allTransports.find(x => x.id === id);
    if (!t) return;
    currentEditItem = t;
    currentEditType = 'transport';

    const tripType = t.trip_type || 'one_way';
    const retMult = t.return_rate_multiplier != null ? t.return_rate_multiplier : 1.8;
    const isOneWay = tripType === 'one_way';

    document.getElementById('editModalBody').innerHTML = `
        <div class="form-grid">
            <div class="form-group"><label>Transport Name</label><input type="text" id="editTransName" value="${t.name}"></div>
            <div class="form-group"><label>Trip Type <span class="req">*</span></label>
                <select id="editTransTripType" onchange="onTripTypeChange('editTransTripType','editTransMultGrp')">
                    <option value="one_way" ${tripType==='one_way'?'selected':''}>One Way</option>
                    <option value="return" ${tripType==='return'?'selected':''}>Return</option>
                    <option value="both" ${tripType==='both'?'selected':''}>Both</option>
                </select>
            </div>
            <div class="form-group multiplier-group ${isOneWay ? 'hidden-field' : ''}" id="editTransMultGrp">
                <label>Return Rate Multiplier</label>
                <input type="number" step="0.01" id="editTransReturnMult" value="${retMult}" min="0">
            </div>
            <div class="form-group"><label>Peak Adult Rate</label><input type="number" step="0.01" id="editTransPeakAdult" value="${t.adult_rate_peak}"></div>
            <div class="form-group"><label>Peak Child Rate</label><input type="number" step="0.01" id="editTransPeakChild" value="${t.child_rate_peak}"></div>
            <div class="form-group"><label>Peak Pricing Type</label>
                <select id="editTransPeakType">
                    <option value="per_person" ${(t.peak_pricing_type||'per_person')==='per_person'?'selected':''}>Per Person</option>
                    <option value="per_vehicle" ${t.peak_pricing_type==='per_vehicle'?'selected':''}>Per Vehicle</option>
                </select>
            </div>
            <div class="form-group"><label>Off Adult Rate</label><input type="number" step="0.01" id="editTransOffAdult" value="${t.adult_rate_off}"></div>
            <div class="form-group"><label>Off Child Rate</label><input type="number" step="0.01" id="editTransOffChild" value="${t.child_rate_off}"></div>
            <div class="form-group"><label>Off Pricing Type</label>
                <select id="editTransOffType">
                    <option value="per_person" ${(t.off_pricing_type||'per_person')==='per_person'?'selected':''}>Per Person</option>
                    <option value="per_vehicle" ${t.off_pricing_type==='per_vehicle'?'selected':''}>Per Vehicle</option>
                </select>
            </div>
        </div>`;
    document.getElementById('editModalTitle').textContent = 'Edit Transport';
    document.getElementById('editModal').classList.add('show');
}

// ===== DESTINATIONS =====
async function loadDestinations() {
    try {
        const res=await fetch(cq(`${API}/api/destinations`));
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        allDestinations=await res.json();
        displayDestinations();
    } catch (e) {
        console.error('Load destinations error:', e);
        showMsg('Failed to load destinations', 'error');
    }
}

function displayDestinations() {
    const filtered = allDestinations.filter(d => matchesRegionFilter(d));
    const tb=document.querySelector('#destinationsTable tbody');
    if (filtered.length === 0) {
        tb.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#999;padding:24px">No destinations found for selected filter</td></tr>';
        return;
    }
    tb.innerHTML=filtered.map(d=>{
        const r=getRegionById(d.region_id);
        const regionBadge = r ? (r.is_domestic ? ' üáÆüá≥' : ' üåé') : '';
        return `<tr class="${d.active?'':'inactive'}" id="destination-row-${d.id}">
        <td>${d.id}</td><td>${r?r.name:'-'}${regionBadge}</td><td>${d.name}</td><td>${d.base_rate}</td><td>${d.per_day_rate}</td>
        <td>${d.is_special?'<span class="badge badge-domestic">Special</span>':'-'}</td>
        <td><span class="badge ${d.active?'badge-active':'badge-inactive'}">${d.active?'Active':'Inactive'}</span></td>
        <td><div class="actions">
            <label class="toggle-switch"><input type="checkbox" ${d.active?'checked':''} onchange="toggleEntity('destinations',${d.id},this.checked)"><span class="toggle-slider"></span></label>
            <button class="btn btn-sm btn-danger" onclick="deleteEntity('destinations',${d.id},this)">Del</button>
        </div></td></tr>`;
    }).join('');
}

document.getElementById('destinationForm').addEventListener('submit', async e => {
    e.preventDefault();
    try {
        const fd=new FormData(e.target); const d=Object.fromEntries(fd);
        d.is_special=fd.get('is_special')?1:0; d.client_id=currentClientId;
        const res=await fetch(`${API}/api/destinations`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
        if(res.ok){showMsg('Destination created');e.target.reset();await loadDestinations();}else{const err=await res.json();showMsg(err.error||'Failed','error');}
    } catch (e) {
        console.error('Create destination error:', e);
        showMsg('Failed to create destination', 'error');
    }
});

// ===== HOTELS =====
async function loadHotels() {
    try {
        const res=await fetch(cq(`${API}/api/hotels`));
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        allHotels=await res.json();
        displayHotels();
    } catch (e) {
        console.error('Load hotels error:', e);
        showMsg('Failed to load hotels', 'error');
    }
}

function displayHotels() {
    const filtered = allHotels.filter(h => matchesRegionFilter(h));
    const tb=document.querySelector('#hotelsTable tbody');
    if (filtered.length === 0) {
        tb.innerHTML = '<tr><td colspan="10" style="text-align:center;color:#999;padding:24px">No hotels found for selected filter</td></tr>';
        return;
    }
    tb.innerHTML=filtered.map(h=>{
        const r=getRegionById(h.region_id);
        const regionBadge = r ? (r.is_domestic ? ' üáÆüá≥' : ' üåé') : '';
        let sh=h.sharing_type;
        if(sh==='CUSTOM'&&h.custom_sharing_name)sh=`${h.custom_sharing_name}(${h.sharing_capacity})`;
        else if(sh==='DOUBLE')sh='Double(2)';
        else if(sh==='QUAD')sh='Quad(4)';
        return `<tr class="${h.active?'':'inactive'}" id="hotel-row-${h.id}">
        <td>${h.id}</td><td>${r?r.name:'-'}${regionBadge}</td><td>${h.name}</td><td>${sh}</td>
        <td>${h.adult_rate_peak}</td><td>${h.child_rate_peak}</td><td>${h.adult_rate_off}</td><td>${h.child_rate_off}</td>
        <td><span class="badge ${h.active?'badge-active':'badge-inactive'}">${h.active?'Active':'Inactive'}</span></td>
        <td><div class="actions">
            <label class="toggle-switch"><input type="checkbox" ${h.active?'checked':''} onchange="toggleEntity('hotels',${h.id},this.checked)"><span class="toggle-slider"></span></label>
            <button class="btn btn-sm btn-danger" onclick="deleteEntity('hotels',${h.id},this)">Del</button>
        </div></td></tr>`;
    }).join('');
}

document.getElementById('hotelForm').addEventListener('submit', async e => {
    e.preventDefault();
    try {
        const d=Object.fromEntries(new FormData(e.target)); d.client_id=currentClientId;
        const res=await fetch(`${API}/api/hotels`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
        if(res.ok){showMsg('Hotel created');e.target.reset();await loadHotels();}else{const err=await res.json();showMsg(err.error||'Failed','error');}
    } catch (e) {
        console.error('Create hotel error:', e);
        showMsg('Failed to create hotel', 'error');
    }
});

// ===== CABS =====
async function loadCabs() {
    try {
        const res=await fetch(cq(`${API}/api/cabs`));
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        allCabs=await res.json();
        displayCabs();
    } catch (e) {
        console.error('Load cabs error:', e);
        showMsg('Failed to load cabs', 'error');
    }
}

function displayCabs() {
    const filtered = allCabs.filter(c => matchesRegionFilter(c));
    const tb=document.querySelector('#cabsTable tbody');
    if (filtered.length === 0) {
        tb.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999;padding:24px">No cabs found for selected filter</td></tr>';
        return;
    }
    tb.innerHTML=filtered.map(c=>{
        const r=getRegionById(c.region_id);
        const regionBadge = r ? (r.is_domestic ? ' üáÆüá≥' : ' üåé') : '';
        return `<tr class="${c.active?'':'inactive'}" id="cab-row-${c.id}">
        <td>${c.id}</td><td>${r?r.name:'-'}${regionBadge}</td><td>${c.name}</td><td>${c.base_rate}</td><td>${c.per_day_rate}</td>
        <td><span class="badge ${c.active?'badge-active':'badge-inactive'}">${c.active?'Active':'Inactive'}</span></td>
        <td><div class="actions">
            <label class="toggle-switch"><input type="checkbox" ${c.active?'checked':''} onchange="toggleEntity('cabs',${c.id},this.checked)"><span class="toggle-slider"></span></label>
            <button class="btn btn-sm btn-danger" onclick="deleteEntity('cabs',${c.id},this)">Del</button>
        </div></td></tr>`;
    }).join('');
}

document.getElementById('cabForm').addEventListener('submit', async e => {
    e.preventDefault();
    try {
        const d=Object.fromEntries(new FormData(e.target)); d.client_id=currentClientId;
        const res=await fetch(`${API}/api/cabs`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
        if(res.ok){showMsg('Cab created');e.target.reset();await loadCabs();}else{const err=await res.json();showMsg(err.error||'Failed','error');}
    } catch (e) {
        console.error('Create cab error:', e);
        showMsg('Failed to create cab', 'error');
    }
});

// ===== CAB-DEST MATRIX =====
let matrixData = null;

async function loadCabDestMatrix() {
    try {
        const res = await fetch(cq(`${API}/api/cab-destination-matrix`));
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        matrixData = await res.json();
        matrixPendingChanges = {};
        renderMatrix();
        updateCDRDropdowns();
    } catch(e) {
        console.error('Matrix load error:', e);
        showMsg('Failed to load matrix', 'error');
        document.getElementById('matrixContainer').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div>Failed to load matrix</div>';
    }
}

function updateCDRDropdowns() {
    const cabSel = document.getElementById('cdrCab');
    const destSel = document.getElementById('cdrDest');
    if (matrixData) {
        cabSel.innerHTML = '<option value="">Select Cab</option>' + (matrixData.cabs||[]).map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        destSel.innerHTML = '<option value="">Select Destination</option>' + (matrixData.destinations||[]).map(d => `<option value="${d.id}">${d.name}</option>`).join('');
    }
}

function renderMatrix() {
    const container = document.getElementById('matrixContainer');
    if (!matrixData || !matrixData.cabs || !matrixData.destinations || !matrixData.cabs.length || !matrixData.destinations.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üöóüèîÔ∏è</div>No cabs or destinations found</div>';
        return;
    }

    const cabs = matrixData.cabs;
    const dests = matrixData.destinations;
    const ratesMap = {};
    (matrixData.matrix || []).forEach(m => {
        ratesMap[`${m.cab_id}_${m.destination_id}`] = m;
    });

    let html = '<table class="matrix-table"><thead><tr><th class="cab-name">Cab \\ Dest</th>';
    dests.forEach(d => {
        const shortName = d.name.length > 12 ? d.name.substring(0,11)+'‚Ä¶' : d.name;
        html += `<th title="${d.name}">${shortName}</th>`;
    });
    html += '</tr></thead><tbody>';

    cabs.forEach(cab => {
        html += `<tr><td class="cab-name">${cab.name}</td>`;
        dests.forEach(dest => {
            const key = `${cab.id}_${dest.id}`;
            const entry = ratesMap[key];
            const currentRate = entry ? (entry.override_rate !== null && entry.override_rate !== undefined ? entry.override_rate : entry.rate) : 0;
            const displayRate = currentRate || 0;
            const hasRecord = entry && entry.has_record;
            html += `<td>
                <input type="number" step="0.01" class="matrix-rate-input ${hasRecord ? '' : ''}"
                    id="mr_${key}" value="${displayRate}"
                    data-cab="${cab.id}" data-dest="${dest.id}" data-original="${displayRate}"
                    onchange="onMatrixCellChange('${key}', this)" onfocus="this.select()">
            </td>`;
        });
        html += '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
    updateMatrixSaveBar();
}

function onMatrixCellChange(key, input) {
    const original = parseFloat(input.dataset.original) || 0;
    const current = parseFloat(input.value) || 0;

    if (Math.abs(current - original) > 0.001) {
        input.classList.add('modified');
        matrixPendingChanges[key] = {
            cab_id: parseInt(input.dataset.cab),
            destination_id: parseInt(input.dataset.dest),
            rate: current,
            override_rate: current
        };
    } else {
        input.classList.remove('modified');
        delete matrixPendingChanges[key];
    }
    updateMatrixSaveBar();
}

function updateMatrixSaveBar() {
    const bar = document.getElementById('matrixSaveBar');
    const count = Object.keys(matrixPendingChanges).length;
    document.getElementById('matrixChangesCount').textContent = `${count} unsaved change${count!==1?'s':''}`;
    bar.style.display = count > 0 ? 'flex' : 'none';
}

async function saveMatrixChanges() {
    const changes = Object.values(matrixPendingChanges);
    if (!changes.length) return;

    let saved = 0;
    for (const change of changes) {
        try {
            const res = await fetch(`${API}/api/cab-destination-rates`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    client_id: currentClientId,
                    cab_id: change.cab_id,
                    destination_id: change.destination_id,
                    rate: change.rate,
                    override_rate: change.override_rate
                })
            });
            if (res.ok) saved++;
        } catch(e) { console.error('Save rate error:', e); }
    }

    showMsg(`Saved ${saved} rate${saved!==1?'s':''}`);
    matrixPendingChanges = {};
    await loadCabDestMatrix();
}

function discardMatrixChanges() {
    matrixPendingChanges = {};
    renderMatrix();
}

document.getElementById('cabDestRateForm').addEventListener('submit', async e => {
    e.preventDefault();
    try {
        const d = Object.fromEntries(new FormData(e.target));
        if (!d.cab_id || !d.destination_id) { showMsg('Select cab and destination', 'error'); return; }
        d.client_id = currentClientId;
        d.rate = parseFloat(d.rate) || 0;
        d.override_rate = d.override_rate ? parseFloat(d.override_rate) : d.rate;
        const res = await fetch(`${API}/api/cab-destination-rates`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)});
        if(res.ok){ showMsg('Rate saved'); await loadCabDestMatrix(); } else { showMsg('Failed','error'); }
    } catch (e) {
        console.error('Save rate error:', e);
        showMsg('Failed to save rate', 'error');
    }
});

// ===== ADDONS =====
async function loadAddons() {
    try {
        const res=await fetch(cq(`${API}/api/addons`));
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        allAddons=await res.json();
        displayAddons();
    } catch (e) {
        console.error('Load addons error:', e);
        showMsg('Failed to load addons', 'error');
    }
}

function displayAddons() {
    const filtered = allAddons.filter(a => matchesRegionFilter(a));
    const tb=document.querySelector('#addonsTable tbody');
    if (filtered.length === 0) {
        tb.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#999;padding:24px">No add-ons found for selected filter</td></tr>';
        return;
    }
    tb.innerHTML=filtered.map(a=>{
        const r=getRegionById(a.region_id);
        const regionBadge = r ? (r.is_domestic ? ' üáÆüá≥' : ' üåé') : '';
        return `<tr class="${a.active?'':'inactive'}" id="addon-row-${a.id}">
        <td>${a.id}</td><td>${r?r.name:'-'}${regionBadge}</td><td>${a.name}</td><td>${a.addon_type||'-'}</td><td>${a.pricing_type}</td>
        <td>${a.rate_peak||0}</td><td>${a.rate_off||0}</td>
        <td><span class="badge ${a.active?'badge-active':'badge-inactive'}">${a.active?'Active':'Inactive'}</span></td>
        <td><div class="actions">
            <label class="toggle-switch"><input type="checkbox" ${a.active?'checked':''} onchange="toggleEntity('addons',${a.id},this.checked)"><span class="toggle-slider"></span></label>
            <button class="btn btn-sm btn-danger" onclick="deleteEntity('addons',${a.id},this)">Del</button>
        </div></td></tr>`;
    }).join('');
}

document.getElementById('addonForm').addEventListener('submit', async e => {
    e.preventDefault();
    try {
        const fd = new FormData(e.target);
        const d = Object.fromEntries(fd);
        d.client_id = currentClientId;
        d.rate_peak = parseFloat(d.rate_peak) || 0;
        d.rate_off = parseFloat(d.rate_off) || 0;
        const res = await fetch(`${API}/api/addons`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)});
        if(res.ok){ showMsg('Add-on created'); e.target.reset(); await loadAddons(); }
        else { const err = await res.json(); showMsg(err.error || 'Failed', 'error'); }
    } catch (e) {
        console.error('Create addon error:', e);
        showMsg('Failed to create add-on', 'error');
    }
});

// ===== PRICING RULES =====
async function loadRules() {
    try {
        const res=await fetch(cq(`${API}/api/pricing-rules`));
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        allRules=await res.json();
        displayRules();
    } catch (e) {
        console.error('Load rules error:', e);
        showMsg('Failed to load rules', 'error');
    }
}

function displayRules() {
    const tb=document.querySelector('#rulesTable tbody');
    tb.innerHTML=allRules.map(r=>{
        const cond=typeof r.conditions_json==='string'?r.conditions_json:JSON.stringify(r.conditions_json);
        const act=typeof r.actions_json==='string'?r.actions_json:JSON.stringify(r.actions_json);
        return `<tr class="${r.active?'':'inactive'}" id="rule-row-${r.id}">
        <td>${r.id}</td><td>${r.name}</td><td>${r.entity_type}</td><td>${r.entity_id||'All'}</td>
        <td>${r.priority}</td><td>${r.stackable?'Yes':'No'}</td>
        <td><code style="font-size:10px;word-break:break-all;max-width:120px;display:block">${cond}</code></td>
        <td><code style="font-size:10px;word-break:break-all;max-width:120px;display:block">${act}</code></td>
        <td><span class="badge ${r.active?'badge-active':'badge-inactive'}">${r.active?'Active':'Inactive'}</span></td>
        <td><div class="actions">
            <label class="toggle-switch"><input type="checkbox" ${r.active?'checked':''} onchange="toggleEntity('pricing-rules',${r.id},this.checked)"><span class="toggle-slider"></span></label>
            <button class="btn btn-sm btn-danger" onclick="deleteEntity('pricing-rules',${r.id},this)">Del</button>
        </div></td></tr>`;
    }).join('') || '<tr><td colspan="10" class="empty-state"><div class="empty-state-icon">üìê</div>No rules</td></tr>';
}

document.getElementById('ruleForm').addEventListener('submit', async e => {
    e.preventDefault();
    try {
        const d=Object.fromEntries(new FormData(e.target));
        d.client_id=currentClientId;
        d.stackable=d.stackable?true:false;
        d.entity_id=d.entity_id?parseInt(d.entity_id):null;
        try{d.conditions_json=JSON.parse(d.conditions_json);}catch{showMsg('Invalid conditions JSON','error');return;}
        try{d.actions_json=JSON.parse(d.actions_json);}catch{showMsg('Invalid actions JSON','error');return;}
        const res=await fetch(`${API}/api/pricing-rules`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
        if(res.ok){showMsg('Rule created');e.target.reset();document.getElementById('ruleConditions').value='{}';document.getElementById('ruleActions').value='{}';await loadRules();}else{const err=await res.json();showMsg(err.error||'Failed','error');}
    } catch (e) {
        console.error('Create rule error:', e);
        showMsg('Failed to create rule', 'error');
    }
});

// ===== AI RULE PARSER =====
async function parseNaturalLanguageRule() {
    const input = document.getElementById('nlRuleInput');
    const statusDiv = document.getElementById('nlRuleStatus');
    const statusInline = document.getElementById('nlRuleStatusInline');
    const clarBox = document.getElementById('clarificationBox');
    const clarQuestion = document.getElementById('clarificationQuestion');
    const btn = document.getElementById('aiParseBtn');
    const text = input.value.trim();

    if (!text) { showMsg('Please describe your rule first', 'error'); return; }

    btn.disabled = true;
    btn.textContent = '‚è≥ Parsing...';
    statusInline.textContent = 'Processing...';
    statusDiv.classList.remove('show', 'success', 'error', 'warning');
    clarBox.classList.remove('show');

    try {
        const res = await fetch(`${API}/api/ai-parse-rule`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ text })
        });
        const data = await res.json();

        btn.disabled = false;
        btn.textContent = 'ü§ñ Generate Rule from Description';
        statusInline.textContent = '';

        if (data.needs_clarification) {
            statusDiv.className = 'nl-rule-status show warning';
            statusDiv.textContent = '‚ö†Ô∏è Needs clarification - please provide more details';
            clarBox.classList.add('show');
            clarQuestion.textContent = data.clarification_question || 'Please provide more specific details.';
            showMsg('Rule needs clarification', 'warning');
            return;
        }

        if (data.error && !data.name) {
            statusDiv.className = 'nl-rule-status show error';
            statusDiv.textContent = '‚ùå Could not parse. Try rephrasing.';
            showMsg('Could not parse rule', 'error');
            return;
        }

        document.getElementById('ruleName').value = data.name || text.substring(0, 200);
        document.getElementById('ruleDescription').value = data.description || text;
        document.getElementById('ruleEntityType').value = data.entity_type || 'global';
        document.getElementById('ruleEntityId').value = data.entity_id || '';
        document.getElementById('rulePriority').value = data.priority || 100;
        document.getElementById('ruleStackable').checked = data.stackable !== false;

        const conditionsStr = JSON.stringify(data.conditions_json || {}, null, 2);
        const actionsStr = JSON.stringify(data.actions_json || {}, null, 2);
        document.getElementById('ruleConditions').value = conditionsStr;
        document.getElementById('ruleActions').value = actionsStr;

        const hasConditions = Object.keys(data.conditions_json || {}).length > 0;
        const hasActions = Object.keys(data.actions_json || {}).length > 0;

        if (hasConditions && hasActions) {
            statusDiv.className = 'nl-rule-status show success';
            statusDiv.textContent = '‚úÖ Rule parsed successfully! Review and click "Create Rule".';
            showMsg('Rule generated successfully', 'success');
        } else if (hasActions && !hasConditions) {
            statusDiv.className = 'nl-rule-status show warning';
            statusDiv.textContent = '‚ö†Ô∏è Partial parse ‚Äî actions found but no conditions.';
            showMsg('Partial parse - add conditions manually', 'warning');
        } else {
            statusDiv.className = 'nl-rule-status show warning';
            statusDiv.textContent = '‚ö†Ô∏è Could not fully parse. Adjust manually.';
            showMsg('Partial parse - review fields', 'warning');
        }
    } catch(e) {
        btn.disabled = false;
        btn.textContent = 'ü§ñ Generate Rule from Description';
        statusInline.textContent = '';
        statusDiv.className = 'nl-rule-status show error';
        statusDiv.textContent = '‚ùå Error: ' + e.message;
        showMsg('Error parsing rule', 'error');
    }
}

// ===== GLOBAL RULES =====
async function loadGlobalRules() {
    try {
        const res=await fetch(cq(`${API}/api/global-rules`));
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const rules=await res.json();
        if(rules&&rules.service_charge!==undefined){
            document.querySelector('#globalRulesForm [name="service_charge"]').value=rules.service_charge;
            document.querySelector('#globalRulesForm [name="booking_charge"]').value=rules.booking_charge;
            document.querySelector('#globalRulesForm [name="tax"]').value=rules.tax||0;
            document.querySelector('#globalRulesForm [name="default_margin"]').value=rules.default_margin||0;
            document.querySelector('#globalRulesForm [name="default_cancellation"]').value=rules.default_cancellation||0;
        }
    } catch (e) {
        console.error('Load global rules error:', e);
    }
}

document.getElementById('globalRulesForm').addEventListener('submit', async e => {
    e.preventDefault();
    try {
        const d=Object.fromEntries(new FormData(e.target)); d.client_id=currentClientId;
        const res=await fetch(`${API}/api/global-rules`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
        if(res.ok){showMsg('Global rules saved');await loadGlobalRules();}else showMsg('Failed','error');
    } catch (e) {
        console.error('Save global rules error:', e);
        showMsg('Failed to save global rules', 'error');
    }
});

// ===== SAVE EDIT HANDLER =====
document.getElementById('saveEditBtn').addEventListener('click', async () => {
    try {
        if(currentEditType==='client'){
            const d={name:document.getElementById('editName').value,code:document.getElementById('editCode').value,
                contact_email:document.getElementById('editEmail').value,contact_phone:document.getElementById('editPhone').value,
                currency_default:document.getElementById('editCurrency').value};
            await fetch(`${API}/api/clients/${currentEditItem.id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
            showMsg('Client updated');closeModal();await loadClients();
        } else if(currentEditType==='region'){
            const d={name:document.getElementById('editName').value,currency:document.getElementById('editCurrency').value,
                service_percent:parseFloat(document.getElementById('editSP').value),
                booking_percent:parseFloat(document.getElementById('editBP').value),
                is_domestic:document.getElementById('editRegionType').value};
            await fetch(`${API}/api/regions/${currentEditItem.id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
            showMsg('Region updated');closeModal();await loadRegions();
        } else if(currentEditType==='transport'){
            const tripTypeVal = document.getElementById('editTransTripType').value;
            if (!tripTypeVal) { showMsg('Please select a Trip Type', 'error'); return; }
            let returnMultiplier = parseFloat(document.getElementById('editTransReturnMult').value);
            if (tripTypeVal === 'one_way') {
                returnMultiplier = 1.0;
            } else {
                if (isNaN(returnMultiplier)) { showMsg('Return Rate Multiplier must be a number', 'error'); return; }
            }
            const d = {
                name: document.getElementById('editTransName').value,
                trip_type: tripTypeVal,
                return_rate_multiplier: returnMultiplier,
                adult_rate_peak: parseFloat(document.getElementById('editTransPeakAdult').value)||0,
                child_rate_peak: parseFloat(document.getElementById('editTransPeakChild').value)||0,
                peak_pricing_type: document.getElementById('editTransPeakType').value,
                adult_rate_off: parseFloat(document.getElementById('editTransOffAdult').value)||0,
                child_rate_off: parseFloat(document.getElementById('editTransOffChild').value)||0,
                off_pricing_type: document.getElementById('editTransOffType').value,
            };
            const res = await fetch(`${API}/api/transports/${currentEditItem.id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
            if (res.ok) { showMsg('Transport updated'); closeModal(); await loadTransports(); }
            else { const err = await res.json(); showMsg(err.error||'Failed to update transport','error'); }
        }
    } catch (e) {
        console.error('Save edit error:', e);
        showMsg('Failed to save changes', 'error');
    }
});

// ===== INIT =====
(async()=>{await loadAll();})();
</script>
</body>
{% endif %}
</html>