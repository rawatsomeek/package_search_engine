<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Trip Package Assistant</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --primary-gradient:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  --glass-bg:rgba(255,255,255,0.08);
  --glass-border:rgba(255,255,255,0.12);
  --glass-shadow:0 8px 32px 0 rgba(31,38,135,0.37);
  --neon-glow:0 0 20px rgba(102,126,234,0.5);
  --transition-smooth:all 0.4s cubic-bezier(0.4,0,0.2,1);
  --touch-min:44px;
}
html{-webkit-text-size-adjust:100%;text-size-adjust:100%}
body{
  font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',system-ui,sans-serif;
  margin:0;background:#0a0a0f;color:#fff;overflow-x:hidden;min-height:100vh;
  position:relative;font-weight:400;letter-spacing:-0.01em;
}
body::before{
  content:'';position:fixed;top:0;left:0;width:100%;height:100%;
  background:radial-gradient(circle at 20% 30%,rgba(102,126,234,0.15) 0%,transparent 50%),
    radial-gradient(circle at 80% 70%,rgba(118,75,162,0.15) 0%,transparent 50%),
    radial-gradient(circle at 50% 50%,rgba(102,126,234,0.08) 0%,transparent 60%);
  animation:bgPulse 15s ease-in-out infinite alternate;z-index:0;
  pointer-events:none;
}
@keyframes bgPulse{0%{transform:scale(1);opacity:1}100%{transform:scale(1.1) translate(2%,2%);opacity:0.8}}

/* =====================================================
   HEADER
   ===================================================== */
header{
  padding:1.25rem 1rem;text-align:center;font-size:clamp(1.2rem,4vw,1.8rem);font-weight:700;
  background:var(--glass-bg);backdrop-filter:blur(20px) saturate(180%);
  -webkit-backdrop-filter:blur(20px) saturate(180%);
  border-bottom:1px solid var(--glass-border);position:relative;z-index:10;letter-spacing:-0.03em;
}
header::after{
  content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);
  width:100px;height:2px;background:var(--primary-gradient);box-shadow:var(--neon-glow);
}
.brand-tagline{font-size:clamp(0.55rem,2vw,0.7rem);font-weight:400;margin-bottom:0.4rem;opacity:0.6;letter-spacing:0.1em;text-transform:uppercase}
.subtitle{font-size:clamp(0.6rem,2vw,0.8rem);font-weight:400;margin-top:0.4rem;opacity:0.6;letter-spacing:0.05em;text-transform:uppercase}
.admin-link{
  position:absolute;top:50%;right:16px;transform:translateY(-50%);
  padding:8px 12px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);
  border-radius:8px;color:#fff;text-decoration:none;font-size:11px;font-weight:600;
  transition:var(--transition-smooth);white-space:nowrap;
  min-height:var(--touch-min);display:inline-flex;align-items:center;
}
.admin-link:hover{background:rgba(255,255,255,0.2)}

/* =====================================================
   MAIN LAYOUT
   ===================================================== */
#mainContainer{
  display:flex;width:94%;max-width:1600px;margin:1.5rem auto;gap:1.5rem;
  position:relative;z-index:1;
}
#chatbotContainer{
  width:68%;padding:1.5rem;background:var(--glass-bg);
  backdrop-filter:blur(40px) saturate(180%);-webkit-backdrop-filter:blur(40px) saturate(180%);
  border-radius:24px;border:1px solid var(--glass-border);box-shadow:var(--glass-shadow);
  display:flex;flex-direction:column;max-height:88vh;transition:var(--transition-smooth);
  min-width:0;
}
#sidebar{
  width:32%;padding:1.5rem;background:var(--glass-bg);
  backdrop-filter:blur(40px) saturate(180%);-webkit-backdrop-filter:blur(40px) saturate(180%);
  border-radius:24px;border:1px solid var(--glass-border);box-shadow:var(--glass-shadow);
  max-height:88vh;overflow-y:auto;transition:var(--transition-smooth);
  min-width:0;
}

/* =====================================================
   MESSAGES
   ===================================================== */
#messages{
  flex:1;overflow-y:auto;background:rgba(0,0,0,0.2);padding:1.25rem;
  border-radius:16px;display:flex;flex-direction:column;margin-bottom:1.25rem;
  min-height:200px;scroll-behavior:smooth;gap:0.875rem;
  -webkit-overflow-scrolling:touch;
}
.botMessage{
  max-width:80%;padding:1rem 1.2rem;
  background:linear-gradient(135deg,rgba(102,126,234,0.15),rgba(118,75,162,0.15));
  backdrop-filter:blur(20px);border-radius:16px;border:1px solid rgba(255,255,255,0.1);
  align-self:flex-start;word-wrap:break-word;word-break:break-word;line-height:1.6;
  box-shadow:0 4px 20px rgba(0,0,0,0.2);animation:msgIn .5s cubic-bezier(.34,1.56,.64,1);
  font-weight:400;font-size:clamp(0.8rem,2.5vw,0.95rem);
}
/* Rich formatting inside bot messages */
.botMessage strong{color:#c4b5fd;font-weight:600}
.botMessage em{color:rgba(255,255,255,0.8);font-style:italic}
.botMessage .ai-bullet{display:block;padding-left:1.2em;text-indent:-0.8em;margin:2px 0}
.botMessage .ai-bullet::before{content:"‚Ä¢ ";color:#a78bfa}
.botMessage hr{border:none;border-top:1px solid rgba(255,255,255,0.1);margin:8px 0}
/* Quick-action chip bar */
#aiQuickBar{display:flex;gap:0.4rem;flex-wrap:wrap;padding:0.5rem 0 0.25rem;flex-shrink:0;border-top:1px solid rgba(255,255,255,0.06);margin-top:4px}
#aiStatusBadge{font-size:0.65rem;padding:0.18rem 0.55rem;border-radius:1rem;border:1px solid;font-weight:500;margin-left:auto;align-self:center;white-space:nowrap;flex-shrink:0}
#aiStatusBadge.active{background:rgba(52,211,153,0.12);border-color:rgba(52,211,153,0.4);color:#34d399}
#aiStatusBadge.limited{background:rgba(251,191,36,0.12);border-color:rgba(251,191,36,0.4);color:#fbbf24}
.ai-no-key-banner{background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);border-radius:10px;padding:0.7rem 1rem;font-size:0.78rem;color:#fbbf24;line-height:1.5;margin-bottom:0.5rem;display:none}
.ai-no-key-banner code{background:rgba(0,0,0,0.3);padding:1px 5px;border-radius:3px;font-size:0.75rem}
.qchip{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);color:rgba(255,255,255,0.8);
  border-radius:1rem;padding:0.22rem 0.65rem;font-size:0.7rem;cursor:pointer;
  transition:all 0.2s;white-space:nowrap;font-family:inherit}
.qchip:hover{background:rgba(102,126,234,0.28);border-color:rgba(102,126,234,0.55);color:#fff;transform:translateY(-1px)}
@keyframes msgIn{0%{opacity:0;transform:translateY(20px) scale(0.95)}100%{opacity:1;transform:translateY(0) scale(1)}}
.userMessage{
  max-width:80%;padding:0.875rem 1.2rem;background:rgba(255,255,255,0.05);
  backdrop-filter:blur(10px);border-radius:16px;border:1px solid rgba(255,255,255,0.08);
  align-self:flex-end;word-wrap:break-word;word-break:break-word;line-height:1.6;
  box-shadow:0 2px 10px rgba(0,0,0,0.1);animation:msgInR .4s cubic-bezier(.4,0,.2,1);
  white-space:pre-wrap;color:rgba(255,255,255,0.9);font-size:clamp(0.8rem,2.5vw,0.95rem);
}
@keyframes msgInR{0%{opacity:0;transform:translateX(20px) scale(0.95)}100%{opacity:1;transform:translateX(0) scale(1)}}
.typing-indicator{display:inline-flex;gap:6px;padding:1rem}
.typing-indicator span{
  height:8px;width:8px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:50%;
  animation:tp 1.4s infinite;box-shadow:0 0 10px rgba(102,126,234,0.5);
}
.typing-indicator span:nth-child(2){animation-delay:0.2s}
.typing-indicator span:nth-child(3){animation-delay:0.4s}
@keyframes tp{0%,60%,100%{transform:translateY(0);opacity:0.7}30%{transform:translateY(-10px);opacity:1}}

/* =====================================================
   OPTIONS
   ===================================================== */
#optionsContainer{
  flex:0 1 auto;overflow-y:auto;max-height:42vh;padding-right:0.25rem;
  margin-bottom:1.25rem;-webkit-overflow-scrolling:touch;
}
.optionButton{
  padding:0.75rem 1.1rem;margin:0.35rem 0.35rem 0.35rem 0;
  border:none;border-radius:12px;
  background:linear-gradient(135deg,rgba(102,126,234,0.2),rgba(118,75,162,0.2));
  backdrop-filter:blur(10px);border:1px solid rgba(102,126,234,0.3);
  color:#fff;cursor:pointer;font-size:clamp(0.8rem,2.5vw,0.9rem);font-weight:500;
  transition:all .3s cubic-bezier(.4,0,.2,1);white-space:normal;
  box-shadow:0 4px 15px rgba(0,0,0,0.2);min-height:var(--touch-min);
  text-align:left;line-height:1.4;
}
.optionButton:hover{
  transform:scale(1.05) translateY(-2px);box-shadow:0 8px 30px rgba(102,126,234,0.5);
  border-color:rgba(255,255,255,0.5);
  background:linear-gradient(135deg,rgba(102,126,234,0.4),rgba(118,75,162,0.4));
}
#optionsContainer:has(.optionButton:hover) .optionButton:not(:hover){filter:blur(1px);opacity:0.5;transform:scale(0.97)}

/* =====================================================
   COUNTER SELECTOR
   ===================================================== */
.counterSelectorContainer{
  margin:1.25rem 0;padding:1.25rem;background:rgba(0,0,0,0.2);
  border-radius:16px;border:1px solid rgba(255,255,255,0.08);
}
.counterRow{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem;flex-wrap:wrap;gap:0.5rem}
.counterRow:last-child{margin-bottom:0}
.counterLabel{font-weight:600;font-size:clamp(0.85rem,2.5vw,1rem)}
.counterControls{display:flex;align-items:center;gap:0.75rem}
.counterBtn{
  width:44px;height:44px;border:2px solid rgba(102,126,234,0.3);
  background:rgba(102,126,234,0.1);color:#fff;border-radius:10px;cursor:pointer;
  transition:all .3s;font-weight:600;font-size:1.25rem;display:flex;align-items:center;justify-content:center;
  -webkit-tap-highlight-color:transparent;touch-action:manipulation;
}
.counterBtn:hover,.counterBtn:active{
  background:var(--primary-gradient);border-color:rgba(255,255,255,0.4);
  transform:scale(1.1);box-shadow:0 0 20px rgba(102,126,234,0.5);
}
.counterValue{font-weight:700;font-size:1.5rem;min-width:44px;text-align:center}

/* =====================================================
   DUAL SELECTOR (NIGHTS + SIGHTSEEING)
   ===================================================== */
.dualSelectorContainer{
  display:flex;gap:1.5rem;margin-top:1.25rem;margin-bottom:1.25rem;
  justify-content:center;padding:1.25rem;background:rgba(0,0,0,0.2);
  border-radius:16px;border:1px solid rgba(255,255,255,0.08);flex-wrap:wrap;
}
.selectorColumn{display:flex;flex-direction:column;align-items:center;gap:0.875rem;min-width:0;flex:1}
.selectorLabel{font-weight:600;font-size:clamp(0.8rem,2.5vw,1rem);text-align:center}
.horizontalScroll{
  display:flex;gap:0.625rem;overflow-x:auto;padding:1rem 0.625rem 1.25rem;
  background:rgba(255,255,255,0.03);border-radius:12px;width:100%;scroll-behavior:smooth;
  border:1px solid rgba(255,255,255,0.06);scroll-snap-type:x mandatory;
  -webkit-overflow-scrolling:touch;
}
.magnifyOption{
  min-width:52px;padding:0.875rem 0.75rem;border:2px solid rgba(102,126,234,0.3);
  background:rgba(102,126,234,0.1);color:#fff;border-radius:10px;cursor:pointer;
  transition:all .4s cubic-bezier(.34,1.56,.64,1);opacity:0.5;transform:scale(0.88);
  font-weight:600;font-size:clamp(0.75rem,2vw,0.9rem);flex-shrink:0;filter:blur(0.5px);
  scroll-snap-align:center;-webkit-tap-highlight-color:transparent;touch-action:manipulation;
}
.magnifyOption.active{
  opacity:1;transform:scale(1.25);background:var(--primary-gradient);
  border-color:rgba(255,255,255,0.4);box-shadow:0 0 25px rgba(102,126,234,0.6);z-index:10;filter:blur(0);
}
.magnifyOption:hover{opacity:1;transform:scale(1.2);background:var(--primary-gradient);box-shadow:0 0 20px rgba(102,126,234,0.5);filter:blur(0)}
.horizontalScroll:has(.magnifyOption:hover) .magnifyOption:not(:hover):not(.active){filter:blur(1.5px);opacity:0.3;transform:scale(0.85)}

/* =====================================================
   HOTEL SELECT
   ===================================================== */
.hotelSelectContainer{margin-top:1rem;width:100%}
.hotelSelect{
  width:100%;padding:0.875rem;border-radius:10px;border:1px solid rgba(255,255,255,0.15);
  background:rgba(102,126,234,0.15);color:#fff;font-size:clamp(0.8rem,2.5vw,0.875rem);
  cursor:pointer;transition:var(--transition-smooth);font-weight:500;font-family:inherit;
  min-height:var(--touch-min);-webkit-appearance:none;appearance:none;
}
.hotelSelect:hover{background:rgba(102,126,234,0.25);border-color:rgba(255,255,255,0.3)}
.hotelSelect:focus{outline:none;border-color:rgba(255,255,255,0.4);box-shadow:0 0 20px rgba(102,126,234,0.5)}
.hotelSelect option{background:#1a1a2e;color:#fff}

/* =====================================================
   KASOL SHARING
   ===================================================== */
.kasolSharingContainer{
  margin-top:1rem;padding:1rem;background:rgba(255,255,255,0.03);
  border-radius:10px;border:1px solid rgba(255,255,255,0.08);
}
.kasolSharingLabel{font-size:0.875rem;font-weight:600;margin-bottom:0.75rem;display:block;text-align:center}
.kasolSharingButtons{display:flex;gap:0.625rem;flex-wrap:wrap}
.kasolSharingButton{
  flex:1;min-width:70px;padding:0.75rem;border:2px solid rgba(102,126,234,0.3);
  background:rgba(102,126,234,0.1);color:#fff;border-radius:8px;cursor:pointer;
  font-weight:600;transition:var(--transition-smooth);font-size:0.875rem;
  min-height:var(--touch-min);-webkit-tap-highlight-color:transparent;
}
.kasolSharingButton.active{background:var(--primary-gradient);border-color:rgba(255,255,255,0.4)}

/* =====================================================
   SIGHTSEEING
   ===================================================== */
.sightseeingOption{
  background:rgba(0,0,0,0.2);padding:0.875rem;margin-bottom:0.875rem;
  border-radius:10px;border:1px solid rgba(255,255,255,0.08);
}
.sightseeingRow{display:flex;align-items:center;gap:0.625rem;flex-wrap:wrap}
.dayLabel{font-weight:600;font-size:0.875rem;min-width:52px;flex-shrink:0}
.sightseeingOption select{
  flex:1;min-width:130px;padding:0.625rem;border-radius:8px;
  border:1px solid rgba(255,255,255,0.15);background:rgba(102,126,234,0.15);
  color:#fff;font-size:clamp(0.75rem,2vw,0.8rem);cursor:pointer;font-family:inherit;
  min-height:var(--touch-min);-webkit-appearance:none;appearance:none;
}
.sightseeingOption select option{background:#1a1a2e;color:#fff}
.addHotelBtn{
  padding:0.5rem 0.875rem;border:none;border-radius:8px;background:rgba(255,255,255,0.1);
  color:#fff;cursor:pointer;font-size:0.75rem;font-weight:600;transition:var(--transition-smooth);
  white-space:nowrap;min-height:var(--touch-min);-webkit-tap-highlight-color:transparent;
}
.addHotelBtn:hover{background:rgba(255,255,255,0.2);transform:scale(1.05)}
.perNightHotelContainer{
  margin-top:0.75rem;padding:0.75rem;background:rgba(255,255,255,0.03);
  border-radius:8px;border:1px solid rgba(255,255,255,0.08);
}
.perNightHotelLabel{font-size:0.75rem;color:rgba(255,255,255,0.7);margin-bottom:0.5rem}

/* =====================================================
   ADDONS
   ===================================================== */
.addonsContainer{display:flex;flex-wrap:wrap;gap:0.625rem;margin-top:1rem}
.addonOption{
  padding:0.75rem 1.25rem;border:2px solid rgba(102,126,234,0.3);
  background:rgba(102,126,234,0.1);color:#fff;border-radius:12px;cursor:pointer;
  font-weight:500;transition:all .3s;font-size:clamp(0.8rem,2.5vw,0.9rem);
  box-shadow:0 4px 15px rgba(0,0,0,0.2);min-height:var(--touch-min);
  -webkit-tap-highlight-color:transparent;
}
.addonOption:hover{background:rgba(102,126,234,0.25);transform:translateY(-2px)}
.addonOption.selected{
  background:var(--primary-gradient);border-color:rgba(255,255,255,0.4);
  box-shadow:0 0 20px rgba(102,126,234,0.5);transform:scale(1.05);
}

/* =====================================================
   SUMMARY / SIDEBAR
   ===================================================== */
.summary{
  padding:1.25rem;background:rgba(0,0,0,0.3);border-radius:12px;
  line-height:1.8;font-size:clamp(0.75rem,2vw,0.875rem);border:1px solid rgba(255,255,255,0.08);
}
.summary b{font-weight:600}
.summary hr{border:none;border-top:1px solid rgba(255,255,255,0.15);margin:0.875rem 0}
.price-total-box{
  margin-top:12px;padding:14px;
  background:linear-gradient(135deg,rgba(102,126,234,0.25),rgba(118,75,162,0.25));
  border-radius:12px;border:1px solid rgba(102,126,234,0.4);text-align:center;
}
.price-total-amount{
  font-size:clamp(1.2rem,4vw,1.6em);font-weight:800;letter-spacing:-0.02em;
  background:linear-gradient(135deg,#667eea,#a855f7);-webkit-background-clip:text;
  -webkit-text-fill-color:transparent;background-clip:text;
}
.price-per-person{font-size:clamp(0.85rem,2.5vw,1.1em);font-weight:700;margin-top:6px;color:rgba(255,255,255,0.9)}
.price-label{font-size:0.7em;text-transform:uppercase;letter-spacing:0.1em;color:rgba(255,255,255,0.5);margin-bottom:2px}

/* =====================================================
   BACK + HOME BUTTONS
   ===================================================== */
#navBtnGroup{
  position:fixed;top:1rem;left:1rem;display:none;z-index:1000;
  display:flex;gap:0.5rem;align-items:center;
}
#backBtn{
  padding:0.625rem 0.875rem;
  border-radius:10px;border:none;background:rgba(0,0,0,0.5);backdrop-filter:blur(10px);
  color:#fff;cursor:pointer;transition:var(--transition-smooth);
  font-weight:600;font-size:1rem;min-height:var(--touch-min);
  -webkit-tap-highlight-color:transparent;display:flex;align-items:center;justify-content:center;
  line-height:1;
}
#backBtn:hover{background:rgba(0,0,0,0.7);transform:translateX(-3px)}
#homeBtn{
  padding:0.625rem 0.875rem;
  border-radius:10px;border:none;background:rgba(0,0,0,0.5);backdrop-filter:blur(10px);
  color:#fff;cursor:pointer;transition:var(--transition-smooth);
  font-weight:600;font-size:1.1rem;min-height:var(--touch-min);
  -webkit-tap-highlight-color:transparent;display:flex;align-items:center;justify-content:center;
}
#homeBtn:hover{background:rgba(102,126,234,0.4);transform:scale(1.05)}
#navBtnGroup.visible{display:flex}
#navBtnGroup.hidden{display:none}

/* =====================================================
   AI INPUT
   ===================================================== */
#aiInputContainer{display:flex;gap:0.625rem;align-items:center;flex-shrink:0}
#aiInput{
  flex:1;padding:0.875rem 1rem;border-radius:12px;border:1px solid rgba(255,255,255,0.15);
  font-size:clamp(0.8rem,2.5vw,0.9rem);background:rgba(255,255,255,0.08);
  backdrop-filter:blur(10px);color:#fff;transition:var(--transition-smooth);
  font-family:inherit;min-height:var(--touch-min);min-width:0;
}
#aiInput:focus{outline:none;border-color:rgba(255,255,255,0.3);box-shadow:0 0 20px rgba(102,126,234,0.4);background:rgba(255,255,255,0.1)}
#aiInput::placeholder{color:rgba(255,255,255,0.5)}
#voiceBtn{
  padding:0;border-radius:12px;border:1px solid rgba(255,255,255,0.15);
  background:rgba(102,126,234,0.15);color:#fff;cursor:pointer;transition:var(--transition-smooth);
  width:var(--touch-min);height:var(--touch-min);min-width:44px;display:flex;align-items:center;justify-content:center;
  flex-shrink:0;-webkit-tap-highlight-color:transparent;
}
#voiceBtn:hover{background:rgba(102,126,234,0.25);transform:scale(1.05)}
#voiceBtn.listening{background:var(--primary-gradient);animation:vp 1.5s ease-in-out infinite}
@keyframes vp{0%,100%{box-shadow:0 0 0 0 rgba(102,126,234,0.7)}50%{box-shadow:0 0 0 15px rgba(102,126,234,0)}}
#voiceBtn svg{width:18px;height:18px}
.voice-status{
  position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);
  font-size:0.625rem;color:rgba(255,255,255,0.6);white-space:nowrap;opacity:0;transition:opacity .3s;
}
#aiInputBtn{
  padding:0.875rem 1.25rem;border-radius:12px;border:none;background:var(--primary-gradient);
  color:#fff;font-weight:600;font-size:clamp(0.8rem,2.5vw,0.9rem);cursor:pointer;
  transition:all .3s;box-shadow:0 4px 15px rgba(102,126,234,0.4);
  min-height:var(--touch-min);white-space:nowrap;flex-shrink:0;
  -webkit-tap-highlight-color:transparent;
}
#aiInputBtn:hover{transform:translateY(-2px) scale(1.02);box-shadow:0 8px 25px rgba(102,126,234,0.6)}
#aiInputBtn:disabled{opacity:0.5;cursor:not-allowed;transform:none}

/* =====================================================
   HOTEL SOURCE SELECTOR
   ===================================================== */
.hotelSourceContainer{margin:1rem 0}
.hotelSourceLabel{font-size:0.875rem;font-weight:600;color:rgba(255,255,255,0.7);margin-bottom:0.75rem;display:block}
.hotelSourceBtns{display:flex;gap:0.625rem;flex-wrap:wrap}
.hotelSourceBtn{
  padding:0.75rem 1.1rem;border:2px solid rgba(102,126,234,0.3);
  background:rgba(102,126,234,0.1);color:#fff;border-radius:10px;cursor:pointer;
  font-weight:600;font-size:clamp(0.75rem,2vw,0.875rem);transition:var(--transition-smooth);
  display:flex;align-items:center;gap:0.4rem;min-height:var(--touch-min);
  flex:1;justify-content:center;-webkit-tap-highlight-color:transparent;
}
.hotelSourceBtn:hover{background:rgba(102,126,234,0.25);transform:translateY(-2px);box-shadow:0 4px 15px rgba(102,126,234,0.3)}
.hotelSourceBtn.active{background:var(--primary-gradient);border-color:rgba(255,255,255,0.4);box-shadow:0 0 20px rgba(102,126,234,0.5)}
.hotelSourceBtn .btn-icon{font-size:1rem}

/* =====================================================
   TRIP TYPE (ONE WAY / RETURN)
   ===================================================== */
.tripTypeContainer{
  margin:1rem 0;padding:1rem;background:rgba(0,0,0,0.2);
  border-radius:14px;border:1px solid rgba(255,255,255,0.08);
}
.tripTypeLabel{font-size:0.875rem;font-weight:600;color:rgba(255,255,255,0.7);margin-bottom:0.75rem;display:block}
.tripTypeBtns{display:flex;gap:0.625rem;flex-wrap:wrap}
.tripTypeBtn{
  padding:0.75rem 1.25rem;border:2px solid rgba(102,126,234,0.3);
  background:rgba(102,126,234,0.1);color:#fff;border-radius:10px;cursor:pointer;
  font-weight:600;font-size:clamp(0.8rem,2.5vw,0.9rem);transition:var(--transition-smooth);
  display:flex;align-items:center;gap:0.4rem;min-height:var(--touch-min);
  flex:1;justify-content:center;-webkit-tap-highlight-color:transparent;
}
.tripTypeBtn:hover{background:rgba(102,126,234,0.25);transform:translateY(-2px)}
.tripTypeBtn.active{background:var(--primary-gradient);border-color:rgba(255,255,255,0.4);box-shadow:0 0 20px rgba(102,126,234,0.5)}

/* =====================================================
   LIVE HOTEL MODAL
   ===================================================== */
#liveHotelModal{
  display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.75);backdrop-filter:blur(10px);z-index:2000;
  align-items:center;justify-content:center;padding:1rem;
  -webkit-overflow-scrolling:touch;
}
#liveHotelModal.open{display:flex}
.liveHotelModalBox{
  width:100%;max-width:700px;height:90vh;
  background:linear-gradient(135deg,rgba(15,15,30,0.98),rgba(20,15,35,0.98));
  border:1px solid var(--glass-border);border-radius:24px;padding:1.5rem;
  overflow:visible;box-shadow:0 20px 60px rgba(0,0,0,0.6),var(--neon-glow);
  display:flex;flex-direction:column;
}
.liveHotelModalTitle{font-size:clamp(1rem,4vw,1.3rem);font-weight:700;margin-bottom:1.25rem;letter-spacing:-0.02em;display:flex;align-items:center;gap:0.625rem}
.liveHotelModalTitle::before{content:'üè®';font-size:1.3rem}
.liveHotelSearchGrid{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-bottom:1.1rem}
.liveHotelFormGroup{display:flex;flex-direction:column;gap:0.3rem}
.liveHotelFormGroup label{font-size:0.75rem;font-weight:600;color:rgba(255,255,255,0.6);text-transform:uppercase;letter-spacing:0.05em}
.liveHotelInput{
  padding:0.75rem 0.875rem;border-radius:10px;border:1px solid rgba(255,255,255,0.15);
  background:rgba(102,126,234,0.1);color:#fff;font-size:0.875rem;
  transition:var(--transition-smooth);font-family:inherit;width:100%;
  min-height:var(--touch-min);-webkit-appearance:none;appearance:none;
}
.liveHotelInput:focus{outline:none;border-color:rgba(255,255,255,0.4);box-shadow:0 0 15px rgba(102,126,234,0.3);background:rgba(102,126,234,0.2)}
.liveHotelInput::placeholder{color:rgba(255,255,255,0.4)}
.liveHotelInput option{background:#1a1a2e;color:#fff}
.liveHotelInfoNote{font-size:0.75rem;color:rgba(255,255,255,0.5);margin-bottom:0.875rem;padding:0.5rem 0.875rem;background:rgba(255,255,255,0.04);border-radius:8px;border:1px solid rgba(255,255,255,0.06)}
.liveHotelSearchBtn{
  width:100%;padding:0.875rem;border:none;border-radius:12px;background:var(--primary-gradient);
  color:#fff;font-weight:700;font-size:0.9rem;cursor:pointer;transition:var(--transition-smooth);
  box-shadow:0 4px 15px rgba(102,126,234,0.4);margin-bottom:0.875rem;min-height:var(--touch-min);
  -webkit-tap-highlight-color:transparent;
}
.liveHotelSearchBtn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(102,126,234,0.6)}
.liveHotelSearchBtn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.liveHotelResults{display:flex;flex-direction:column;gap:0.75rem;overflow-y:auto;padding-right:0.25rem;margin-top:0.5rem;max-height:260px;}
.liveHotelCard{
  padding:1.1rem;background:rgba(0,0,0,0.3);border-radius:14px;
  border:1px solid rgba(255,255,255,0.08);cursor:pointer;transition:var(--transition-smooth);
  -webkit-tap-highlight-color:transparent;touch-action:manipulation;
  -webkit-user-select:none;user-select:none;
}
.liveHotelCard:hover{border-color:rgba(102,126,234,0.5);background:rgba(102,126,234,0.08);transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,0.2)}
.liveHotelCard.selected{border-color:rgba(102,126,234,0.8);background:linear-gradient(135deg,rgba(102,126,234,0.15),rgba(118,75,162,0.15));box-shadow:0 0 25px rgba(102,126,234,0.3)}
.liveHotelCardHeader{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.5rem;gap:0.875rem}
.liveHotelName{font-weight:700;font-size:clamp(0.875rem,2.5vw,1rem);line-height:1.3}
.liveHotelTotalPrice{font-weight:800;font-size:clamp(0.9rem,3vw,1.15rem);background:linear-gradient(135deg,#667eea,#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;white-space:nowrap}
.liveHotelMeta{font-size:0.78rem;color:rgba(255,255,255,0.55);display:flex;flex-wrap:wrap;gap:0.625rem;margin-top:0.375rem}
.liveHotelPerNight{font-size:0.72rem;color:rgba(255,255,255,0.4);margin-top:0.25rem}
.liveHotelNoResults{text-align:center;padding:2rem;color:rgba(255,255,255,0.5);font-size:0.875rem}
.liveHotelSearching{text-align:center;padding:1.75rem;color:rgba(255,255,255,0.7);font-size:0.875rem}
.liveHotelModalFooter{display:flex;gap:0.625rem;margin-top:1.1rem;padding-top:1.1rem;border-top:1px solid rgba(255,255,255,0.08);flex-wrap:wrap;flex-shrink:0}
.liveHotelModalConfirmBtn{
  flex:1;min-width:120px;padding:0.875rem;border:none;border-radius:12px;background:var(--primary-gradient);
  color:#fff;font-weight:700;font-size:0.9rem;cursor:pointer;transition:var(--transition-smooth);
  box-shadow:0 4px 15px rgba(102,126,234,0.4);min-height:var(--touch-min);
  -webkit-tap-highlight-color:transparent;
}
.liveHotelModalConfirmBtn:disabled{opacity:0.35;cursor:not-allowed}
.liveHotelModalConfirmBtn:not(:disabled):hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(102,126,234,0.6)}
.liveHotelModalCancelBtn{
  padding:0.875rem 1.25rem;border:1px solid rgba(255,255,255,0.2);border-radius:12px;
  background:rgba(255,255,255,0.05);color:#fff;font-weight:600;font-size:0.9rem;
  cursor:pointer;transition:var(--transition-smooth);min-height:var(--touch-min);
  -webkit-tap-highlight-color:transparent;
}
.liveHotelModalCancelBtn:hover{background:rgba(255,255,255,0.1)}
.liveHotelSelectedBadge{margin-top:0.75rem;padding:0.875rem 1rem;background:linear-gradient(135deg,rgba(102,126,234,0.2),rgba(118,75,162,0.2));border:1px solid rgba(102,126,234,0.4);border-radius:12px;font-size:0.85rem}
.liveHotelSelectedBadge .badge-name{font-weight:700;margin-bottom:0.3rem}
.liveHotelSelectedBadge .badge-meta{color:rgba(255,255,255,0.65);font-size:0.78rem}
.liveHotelSelectedBadge .badge-price{font-weight:800;font-size:clamp(0.875rem,3vw,1rem);margin-top:0.4rem;background:linear-gradient(135deg,#667eea,#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.liveHotelChangeBtns{display:flex;gap:0.5rem;margin-top:0.75rem;flex-wrap:wrap}
.liveHotelChangeBtn{padding:0.5rem 0.875rem;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.05);color:#fff;cursor:pointer;font-size:0.8rem;font-weight:600;transition:var(--transition-smooth);min-height:var(--touch-min)}
.liveHotelChangeBtn:hover{background:rgba(255,255,255,0.12)}
.liveHotelChangeBtn.remove{border-color:rgba(231,76,60,0.4);color:rgba(255,100,100,0.9)}
.liveHotelChangeBtn.remove:hover{background:rgba(231,76,60,0.15)}
.nightsAutoNote{font-size:0.72rem;color:rgba(255,255,255,0.45);margin-top:0.3rem}

/* =====================================================
   HOTEL NAME SEARCH (NEW)
   ===================================================== */
.hotelNameSearchContainer{
  position:relative;margin-bottom:0.75rem;
}
.hotelNameSearchDivider{
  display:flex;align-items:center;gap:0.75rem;margin:0.75rem 0;
}
.hotelNameSearchDivider::before,.hotelNameSearchDivider::after{
  content:'';flex:1;height:1px;background:rgba(255,255,255,0.1);
}
.hotelNameSearchDividerText{
  font-size:0.7rem;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.08em;white-space:nowrap;
}
.hotelNameAutocomplete{
  position:absolute;top:100%;left:0;right:0;z-index:3000;
  background:linear-gradient(135deg,rgba(15,15,30,0.98),rgba(25,20,40,0.98));
  border:1px solid rgba(102,126,234,0.4);border-radius:12px;
  max-height:220px;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,0.5);
  margin-top:4px;
}
.hotelNameAutocompleteItem{
  padding:0.75rem 1rem;cursor:pointer;transition:background 0.2s;
  border-bottom:1px solid rgba(255,255,255,0.05);
  display:flex;flex-direction:column;gap:0.15rem;
}
.hotelNameAutocompleteItem:last-child{border-bottom:none}
.hotelNameAutocompleteItem:hover{background:rgba(102,126,234,0.2)}
.hotelNameAutocompleteItem .ac-name{font-weight:600;font-size:0.875rem}
.hotelNameAutocompleteItem .ac-meta{font-size:0.72rem;color:rgba(255,255,255,0.5)}
.hotelNameSearchStatus{
  font-size:0.72rem;padding:0.5rem 0.875rem;color:rgba(255,255,255,0.45);
  display:flex;align-items:center;gap:0.4rem;
}
.hotelNameSearchStatus.searching{color:rgba(102,126,234,0.8)}
.hotelNameSearchStatus.rate-limited{color:rgba(255,150,50,0.8)}
.hotelNameSearchStatus.error{color:rgba(255,100,100,0.8)}
.hotelNameSearchSelectedPill{
  display:inline-flex;align-items:center;gap:0.4rem;padding:0.4rem 0.75rem;
  background:linear-gradient(135deg,rgba(102,126,234,0.3),rgba(118,75,162,0.3));
  border:1px solid rgba(102,126,234,0.5);border-radius:8px;
  font-size:0.78rem;font-weight:600;margin-top:0.4rem;
}
.hotelNameSearchSelectedPill .pill-clear{
  cursor:pointer;opacity:0.7;font-size:0.9rem;line-height:1;
  background:none;border:none;color:inherit;padding:0;
}
.hotelNameSearchSelectedPill .pill-clear:hover{opacity:1}

/* =====================================================
   SEARCH MODE TABS (city / hotel-name)
   ===================================================== */
.liveSearchModeTabs{
  display:flex;gap:0.4rem;margin-bottom:0.875rem;
}
.liveSearchModeTab{
  flex:1;padding:0.5rem 0.75rem;border:1px solid rgba(255,255,255,0.15);
  background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.6);
  border-radius:8px;cursor:pointer;font-size:0.8rem;font-weight:600;
  transition:var(--transition-smooth);text-align:center;
  -webkit-tap-highlight-color:transparent;
}
.liveSearchModeTab.active{
  background:rgba(102,126,234,0.25);border-color:rgba(102,126,234,0.5);
  color:#fff;
}
.liveSearchModeTab:hover:not(.active){background:rgba(255,255,255,0.08)}

/* =====================================================
   FLIGHT SEARCH STYLES
   ===================================================== */
.flightTypeContainer{display:flex;gap:0.625rem;margin:0.875rem 0;flex-wrap:wrap}
.flightTypeBtn{
  padding:0.625rem 1rem;border:2px solid rgba(102,126,234,0.3);background:rgba(102,126,234,0.1);
  color:#fff;border-radius:10px;cursor:pointer;font-weight:600;font-size:clamp(0.75rem,2vw,0.875rem);
  transition:var(--transition-smooth);min-height:var(--touch-min);flex:1;
  -webkit-tap-highlight-color:transparent;
}
.flightTypeBtn:hover{background:rgba(102,126,234,0.25);transform:translateY(-2px)}
.flightTypeBtn.active{background:var(--primary-gradient);border-color:rgba(255,255,255,0.4);box-shadow:0 0 20px rgba(102,126,234,0.5)}
.flightSearchForm{margin-top:0.875rem;padding:1.1rem;background:rgba(0,0,0,0.25);border-radius:14px;border:1px solid rgba(255,255,255,0.08)}
.flightSearchGrid{display:grid;grid-template-columns:1fr 1fr;gap:0.625rem;margin-bottom:0.875rem}
.flightFormGroup{display:flex;flex-direction:column;gap:0.3rem}
.flightFormGroup label{font-size:0.75rem;font-weight:600;color:rgba(255,255,255,0.6);text-transform:uppercase;letter-spacing:0.05em}
.flightInput{
  padding:0.625rem 0.875rem;border-radius:8px;border:1px solid rgba(255,255,255,0.15);
  background:rgba(102,126,234,0.1);color:#fff;font-size:clamp(0.8rem,2.5vw,0.875rem);
  transition:var(--transition-smooth);font-family:inherit;min-height:var(--touch-min);
  -webkit-appearance:none;appearance:none;
}
.flightInput:focus{outline:none;border-color:rgba(255,255,255,0.4);box-shadow:0 0 15px rgba(102,126,234,0.3);background:rgba(102,126,234,0.2)}
.flightInput::placeholder{color:rgba(255,255,255,0.4)}
.flightInput option{background:#1a1a2e;color:#fff}
.flightSearchBtn{
  width:100%;padding:0.875rem;border:none;border-radius:10px;background:var(--primary-gradient);
  color:#fff;font-weight:700;font-size:0.9rem;cursor:pointer;transition:var(--transition-smooth);
  box-shadow:0 4px 15px rgba(102,126,234,0.4);min-height:var(--touch-min);
  -webkit-tap-highlight-color:transparent;
}
.flightSearchBtn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(102,126,234,0.6)}
.flightSearchBtn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.flightResultsContainer{margin-top:0.875rem;display:flex;flex-direction:column;gap:0.625rem;max-height:280px;overflow-y:auto;padding-right:0.25rem;-webkit-overflow-scrolling:touch}
.flightResultCard{
  padding:0.875rem 1.1rem;background:rgba(0,0,0,0.3);border-radius:12px;
  border:1px solid rgba(255,255,255,0.08);cursor:pointer;transition:var(--transition-smooth);
  display:flex;flex-direction:column;gap:0.4rem;
}
.flightResultCard:hover{border-color:rgba(102,126,234,0.5);background:rgba(102,126,234,0.1);transform:translateX(4px)}
.flightResultCard.selected{border-color:rgba(102,126,234,0.8);background:linear-gradient(135deg,rgba(102,126,234,0.2),rgba(118,75,162,0.2));box-shadow:0 0 20px rgba(102,126,234,0.3)}
.flightCardHeader{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.4rem}
.flightCarrier{font-weight:700;font-size:0.9rem}
.flightPrice{font-weight:800;font-size:clamp(0.9rem,3vw,1.1rem);background:linear-gradient(135deg,#667eea,#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.flightRoute{font-size:0.8rem;color:rgba(255,255,255,0.65);display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap}
.flightMeta{font-size:0.75rem;color:rgba(255,255,255,0.45);display:flex;gap:0.75rem;flex-wrap:wrap}
.flightSelectedBadge{display:inline-flex;align-items:center;gap:0.4rem;padding:0.5rem 0.875rem;background:linear-gradient(135deg,rgba(102,126,234,0.3),rgba(118,75,162,0.3));border:1px solid rgba(102,126,234,0.5);border-radius:8px;font-size:0.8rem;font-weight:600;margin-top:0.625rem;flex-wrap:wrap}
.flightChangeBtns{display:flex;gap:0.5rem;margin-top:0.625rem;flex-wrap:wrap}
.flightChangeBtn{padding:0.5rem 0.875rem;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.05);color:#fff;cursor:pointer;font-size:0.8rem;font-weight:600;transition:var(--transition-smooth);min-height:var(--touch-min)}
.flightChangeBtn:hover{background:rgba(255,255,255,0.1)}
.flightChangeBtn.remove{border-color:rgba(231,76,60,0.4);color:rgba(255,100,100,0.9)}
.flightChangeBtn.remove:hover{background:rgba(231,76,60,0.15)}
.flightNoResults{text-align:center;padding:1.5rem;color:rgba(255,255,255,0.5);font-size:0.875rem}
.flightSearching{text-align:center;padding:1.25rem;color:rgba(255,255,255,0.7);font-size:0.875rem}

/* =====================================================
   FLIGHT DETAIL CARD (EXPANDABLE)
   ===================================================== */
.flightDetailCard{
  margin-top:0.75rem;padding:1.1rem;background:rgba(0,0,0,0.35);
  border-radius:14px;border:1px solid rgba(102,126,234,0.3);
  animation:msgIn 0.4s ease;
}
.flightDetailCard .fd-header{
  display:flex;align-items:center;justify-content:space-between;cursor:pointer;
  gap:0.5rem;flex-wrap:wrap;
}
.flightDetailCard .fd-title{font-weight:700;font-size:0.9rem;display:flex;align-items:center;gap:0.4rem}
.flightDetailCard .fd-toggle{
  padding:0.25rem 0.625rem;background:rgba(102,126,234,0.2);border:1px solid rgba(102,126,234,0.3);
  border-radius:6px;font-size:0.75rem;color:rgba(255,255,255,0.7);cursor:pointer;
  transition:var(--transition-smooth);white-space:nowrap;
}
.flightDetailCard .fd-toggle:hover{background:rgba(102,126,234,0.35)}
.flightDetailCard .fd-body{margin-top:0.875rem;display:none}
.flightDetailCard .fd-body.open{display:block}
.flightDetailGrid{display:grid;grid-template-columns:1fr 1fr;gap:0.625rem;margin-bottom:0.75rem}
.flightDetailItem{display:flex;flex-direction:column;gap:0.15rem}
.flightDetailItem .fdi-label{font-size:0.68rem;text-transform:uppercase;letter-spacing:0.06em;color:rgba(255,255,255,0.4)}
.flightDetailItem .fdi-value{font-size:0.85rem;font-weight:600}
.flightDetailRouteViz{
  display:flex;align-items:center;gap:0.5rem;padding:0.75rem;
  background:rgba(102,126,234,0.08);border-radius:10px;margin-bottom:0.75rem;
  flex-wrap:wrap;justify-content:space-between;
}
.flightDetailRouteViz .fdrv-airport{text-align:center}
.flightDetailRouteViz .fdrv-code{font-weight:800;font-size:1.2rem;letter-spacing:0.05em}
.flightDetailRouteViz .fdrv-time{font-size:0.75rem;color:rgba(255,255,255,0.6);margin-top:0.2rem}
.flightDetailRouteViz .fdrv-line{
  flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:0.2rem;
  min-width:60px;
}
.flightDetailRouteViz .fdrv-arrow{
  font-size:1.25rem;color:rgba(102,126,234,0.8);
}
.flightDetailRouteViz .fdrv-duration{font-size:0.72rem;color:rgba(255,255,255,0.5)}
.flightDetailRouteViz .fdrv-stops{font-size:0.68rem;color:rgba(255,180,50,0.8)}
.flightPricingBreakdown{
  padding:0.75rem;background:rgba(0,0,0,0.3);border-radius:10px;border:1px solid rgba(255,255,255,0.07);
  margin-top:0.5rem;
}
.flightPricingBreakdown .fpb-title{font-size:0.75rem;font-weight:700;color:rgba(255,255,255,0.7);margin-bottom:0.5rem;text-transform:uppercase;letter-spacing:0.06em}
.flightPricingRow{display:flex;justify-content:space-between;align-items:center;padding:0.25rem 0;font-size:0.8rem;border-bottom:1px solid rgba(255,255,255,0.05)}
.flightPricingRow:last-child{border-bottom:none;font-weight:700;padding-top:0.5rem;margin-top:0.25rem;border-top:1px solid rgba(255,255,255,0.1)}
.flightPricingRow .fpr-label{color:rgba(255,255,255,0.6)}
.flightPricingRow .fpr-value{font-weight:600}
.flightBaggageInfo{
  display:inline-flex;align-items:center;gap:0.3rem;padding:0.35rem 0.75rem;
  background:rgba(50,200,100,0.1);border:1px solid rgba(50,200,100,0.25);
  border-radius:6px;font-size:0.75rem;color:rgba(100,220,130,0.9);margin-top:0.5rem;
}
.flightReturnLeg{
  margin-top:0.75rem;padding:0.75rem;
  background:rgba(118,75,162,0.08);border-radius:10px;border:1px solid rgba(118,75,162,0.2);
}
.flightReturnLeg .frl-title{font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:rgba(168,85,247,0.8);margin-bottom:0.5rem}

/* =====================================================
   MOBILE SIDEBAR TOGGLE
   ===================================================== */
#sidebarToggle{
  display:none;
  position:fixed;bottom:80px;right:16px;z-index:500;
  width:52px;height:52px;border-radius:50%;border:none;
  background:var(--primary-gradient);color:#fff;font-size:1.2rem;cursor:pointer;
  box-shadow:0 4px 20px rgba(102,126,234,0.5);
  align-items:center;justify-content:center;
  -webkit-tap-highlight-color:transparent;
}
#mobileSidebarOverlay{
  display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);z-index:400;backdrop-filter:blur(5px);
}
#mobileSidebarOverlay.show{display:block}

/* =====================================================
   SCROLLBAR
   ===================================================== */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:rgba(255,255,255,0.05);border-radius:10px}
::-webkit-scrollbar-thumb{background:var(--primary-gradient);border-radius:10px}

/* =====================================================
   RESPONSIVE BREAKPOINTS
   ===================================================== */

/* Large tablets and small desktops (1024px and below) */
@media (max-width:1024px){
  #mainContainer{width:96%;gap:1.25rem}
  #chatbotContainer{width:62%}
  #sidebar{width:38%}
}

/* Tablets (768px and below) */
@media (max-width:768px){
  header{padding:1rem;padding-right:5rem}
  .admin-link{right:12px;padding:7px 10px;font-size:10px}
  #mainContainer{
    flex-direction:column;width:100%;margin:0;gap:0;
    border-radius:0;padding:0;
  }
  #chatbotContainer{
    width:100%;border-radius:0;border:none;border-bottom:1px solid var(--glass-border);
    max-height:none;height:auto;min-height:calc(100vh - 64px);
    padding:1rem;
  }
  #sidebar{
    display:none;
    position:fixed;bottom:0;left:0;right:0;z-index:450;
    width:100%;max-height:70vh;height:auto;
    border-radius:20px 20px 0 0;border:1px solid var(--glass-border);
    border-bottom:none;padding:1.25rem 1rem;
    transition:transform 0.4s cubic-bezier(0.4,0,0.2,1);
    transform:translateY(100%);
    max-height:70vh;
  }
  #sidebar.mobile-open{
    display:block;transform:translateY(0);
  }
  #sidebarToggle{display:flex}
  #messages{min-height:250px;max-height:45vh}
  #optionsContainer{max-height:35vh}
  .dualSelectorContainer{flex-direction:column;gap:1.25rem;padding:1rem}
  .selectorColumn{width:100%}
  .horizontalScroll{width:100%}
  .flightSearchGrid{grid-template-columns:1fr}
  .liveHotelSearchGrid{grid-template-columns:1fr}
  .liveHotelModalBox{padding:1.25rem;border-radius:16px}
  .flightDetailGrid{grid-template-columns:1fr}
}

/* Small phones (480px and below) */
@media (max-width:480px){
  header{padding:0.875rem;padding-right:4.5rem}
  .admin-link{padding:6px 8px;font-size:9px;border-radius:6px}
  #chatbotContainer{padding:0.75rem}
  #messages{padding:0.875rem;gap:0.625rem;min-height:200px;max-height:40vh}
  #optionsContainer{max-height:30vh}
  .botMessage,.userMessage{max-width:90%;padding:0.75rem 0.875rem}
  .optionButton{padding:0.625rem 0.875rem;margin:0.25rem 0.25rem 0.25rem 0;font-size:0.8rem}
  #aiInputContainer{gap:0.4rem}
  #aiInput{padding:0.75rem 0.875rem;font-size:0.8rem}
  #aiInputBtn{padding:0.75rem 0.875rem;font-size:0.8rem}
  #voiceBtn{width:40px;height:40px;min-width:40px}
  .counterSelectorContainer{padding:1rem}
  .counterBtn{width:40px;height:40px}
  .counterValue{font-size:1.25rem}
  .dualSelectorContainer{padding:0.75rem;gap:1rem}
  .magnifyOption{min-width:46px;padding:0.75rem 0.625rem;font-size:0.8rem}
  .flightTypeContainer{gap:0.4rem}
  .flightTypeBtn{font-size:0.75rem;padding:0.5rem 0.75rem}
  .liveHotelModalBox{padding:1rem;border-radius:14px}
  .kasolSharingButton{font-size:0.8rem;padding:0.625rem}
  .sightseeingOption{padding:0.75rem}
  .sightseeingRow{gap:0.4rem}
  .addHotelBtn{font-size:0.7rem;padding:0.4rem 0.625rem}
  #navBtnGroup{top:0.75rem;left:0.75rem}
  #backBtn,#homeBtn{padding:0.5rem 0.75rem;font-size:0.9rem}
  .hotelSourceBtn{font-size:0.75rem;padding:0.625rem 0.875rem}
  .liveHotelModalFooter{flex-direction:column}
  .liveHotelModalConfirmBtn,.liveHotelModalCancelBtn{width:100%}
  .tripTypeBtns{gap:0.4rem}
  .tripTypeBtn{font-size:0.8rem;padding:0.625rem 0.875rem}
}

/* Very small phones */
@media (max-width:360px){
  #aiInputBtn{padding:0.75rem;font-size:0.75rem}
  .optionButton{font-size:0.75rem;padding:0.5rem 0.75rem}
}
</style>
</head>
<body>

<!-- Nav Button Group (Back + Home) -->
<div id="navBtnGroup" class="hidden">
  <button id="backBtn" onclick="goBack()" title="Go Back">‚Üê</button>
  <button id="homeBtn" onclick="goHome()" title="Go Home">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
      <polyline points="9 22 9 12 15 12 15 22"></polyline>
    </svg>
  </button>
</div>

<!-- Mobile sidebar toggle -->
<button id="sidebarToggle" onclick="toggleMobileSidebar()" aria-label="Toggle trip summary">üí∞</button>
<div id="mobileSidebarOverlay" onclick="toggleMobileSidebar()"></div>

<!-- LIVE HOTEL SEARCH MODAL -->
<!-- ============================================================
     BOOK PACKAGE MODAL ‚Äî Point 3 (v4.0)
     Collects traveler details for Amadeus Create Order.
     flight_pnr and hotel_confirmation are always displayed separately.
     ============================================================ -->
<div id="bookingModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1100;align-items:center;justify-content:center;padding:20px">
    <div style="background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:16px;padding:28px;width:100%;max-width:460px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.5)">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
            <div style="font-size:18px;font-weight:700;color:#fff">üìã Book Package</div>
            <button onclick="closeBookingModal()" style="background:none;border:none;color:rgba(255,255,255,0.6);font-size:22px;cursor:pointer;padding:4px">‚úï</button>
        </div>

        <div id="bm-err" style="display:none;background:rgba(231,76,60,0.15);border:1px solid rgba(231,76,60,0.4);color:rgba(255,150,150,0.95);padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:14px"></div>

        <div style="font-size:12px;font-weight:600;color:rgba(255,255,255,0.5);margin-bottom:14px;letter-spacing:0.04em">
            LEAD TRAVELER DETAILS (<span id="bm-adult-count">1</span> Adult)
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
            <div>
                <label style="display:block;font-size:12px;color:rgba(255,255,255,0.6);margin-bottom:5px">First Name *</label>
                <input id="bm-fname" type="text" placeholder="JOHN" autocomplete="given-name"
                    style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.07);border:1.5px solid rgba(255,255,255,0.15);border-radius:8px;color:#fff;font-size:13px;text-transform:uppercase" />
            </div>
            <div>
                <label style="display:block;font-size:12px;color:rgba(255,255,255,0.6);margin-bottom:5px">Last Name *</label>
                <input id="bm-lname" type="text" placeholder="DOE" autocomplete="family-name"
                    style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.07);border:1.5px solid rgba(255,255,255,0.15);border-radius:8px;color:#fff;font-size:13px;text-transform:uppercase" />
            </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
            <div>
                <label style="display:block;font-size:12px;color:rgba(255,255,255,0.6);margin-bottom:5px">Date of Birth *</label>
                <input id="bm-dob" type="date" autocomplete="bday"
                    style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.07);border:1.5px solid rgba(255,255,255,0.15);border-radius:8px;color:#fff;font-size:13px" />
            </div>
            <div>
                <label style="display:block;font-size:12px;color:rgba(255,255,255,0.6);margin-bottom:5px">Gender *</label>
                <select id="bm-gender"
                    style="width:100%;padding:10px 12px;background:rgba(30,40,70,0.95);border:1.5px solid rgba(255,255,255,0.15);border-radius:8px;color:#fff;font-size:13px">
                    <option value="MALE">Male</option>
                    <option value="FEMALE">Female</option>
                </select>
            </div>
        </div>

        <div style="margin-bottom:12px">
            <label style="display:block;font-size:12px;color:rgba(255,255,255,0.6);margin-bottom:5px">Email *</label>
            <input id="bm-email" type="email" placeholder="john@example.com" autocomplete="email"
                style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.07);border:1.5px solid rgba(255,255,255,0.15);border-radius:8px;color:#fff;font-size:13px" />
        </div>

        <div style="margin-bottom:20px">
            <label style="display:block;font-size:12px;color:rgba(255,255,255,0.6);margin-bottom:5px">Phone * <span style="font-size:10px;opacity:0.6">(with country code, e.g. +91 9999999999)</span></label>
            <input id="bm-phone" type="tel" placeholder="+91 9999999999" autocomplete="tel"
                style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.07);border:1.5px solid rgba(255,255,255,0.15);border-radius:8px;color:#fff;font-size:13px" />
        </div>

        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:16px;padding:10px;background:rgba(255,255,255,0.04);border-radius:6px;line-height:1.6">
            ‚ÑπÔ∏è This will create a real booking via Amadeus.
            <br>Flight PNR and Hotel confirmation are issued separately.
        </div>

        <!-- Booking result ‚Äî shown after successful booking -->
        <div id="bm-result" style="display:none"></div>

        <div style="display:flex;gap:10px">
            <button id="bm-submit-btn" onclick="submitBooking()"
                style="flex:1;padding:13px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer">
                Confirm Booking
            </button>
            <button onclick="closeBookingModal()"
                style="padding:13px 18px;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.7);border:1px solid rgba(255,255,255,0.15);border-radius:10px;font-size:14px;cursor:pointer">
                Cancel
            </button>
        </div>
    </div>
</div>

<div id="liveHotelModal">
    <div class="liveHotelModalBox">
        <div class="liveHotelModalTitle">Search Live Hotels</div>

        <!-- Search Mode Tabs -->
        <div class="liveSearchModeTabs">
            <button class="liveSearchModeTab active" id="lhTabCity" onclick="setLiveSearchMode('city')">üèôÔ∏è By City</button>
            <button class="liveSearchModeTab" id="lhTabName" onclick="setLiveSearchMode('name')">üî§ By Hotel Name</button>
            <button class="liveSearchModeTab" id="lhTabBoth" onclick="setLiveSearchMode('both')">üîç City + Name</button>
        </div>

        <!-- City search section -->
        <div id="lhCitySection" class="liveHotelSearchGrid">
            <div class="liveHotelFormGroup" style="grid-column:1/-1">
                <label>City / IATA Code</label>
                <input type="text" id="lhCityCode" class="liveHotelInput" placeholder="e.g. DXB, SIN, BKK, PAR" maxlength="3" style="text-transform:uppercase" />
            </div>
            <div class="liveHotelFormGroup">
                <label>Check-In Date</label>
                <input type="date" id="lhCheckIn" class="liveHotelInput" oninput="onLiveHotelCheckInChange()" />
                <span class="nightsAutoNote" id="lhNightsNote"></span>
            </div>
            <div class="liveHotelFormGroup">
                <label>Check-Out Date</label>
                <input type="date" id="lhCheckOut" class="liveHotelInput" oninput="onLiveHotelCheckOutChange()" />
            </div>
        </div>

        <!-- Hotel Name search section -->
        <div id="lhNameSection" style="display:none;margin-bottom:0.875rem;">
            <div class="liveHotelFormGroup">
                <label>Hotel Name</label>
                <div class="hotelNameSearchContainer">
                    <input type="text" id="lhHotelNameInput" class="liveHotelInput"
                           placeholder="Type hotel name (e.g. Marriott, Hilton...)"
                           oninput="onHotelNameInput()"
                           autocomplete="off" />
                    <div id="lhHotelNameAutocomplete" class="hotelNameAutocomplete" style="display:none"></div>
                    <div id="lhHotelNameStatus" class="hotelNameSearchStatus" style="display:none"></div>
                </div>
                <div id="lhHotelNameSelectedPill" style="display:none"></div>
            </div>
        </div>

        <!-- Date fields shown for name-only mode too -->
        <div id="lhNameDatesSection" style="display:none;margin-bottom:0.875rem;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
                <div class="liveHotelFormGroup">
                    <label>Check-In Date</label>
                    <input type="date" id="lhCheckIn2" class="liveHotelInput" oninput="syncDates2to1()" />
                </div>
                <div class="liveHotelFormGroup">
                    <label>Check-Out Date</label>
                    <input type="date" id="lhCheckOut2" class="liveHotelInput" oninput="syncDates2to1()" />
                </div>
            </div>
        </div>

        <div class="liveHotelInfoNote" id="lhInfoNote">
            Rooms and travelers are taken from your trip settings.
        </div>

        <!-- Point 5 (v4.0): Star Rating Filter ‚Äî server-side + backend validation -->
        <div style="margin-bottom:0.875rem">
            <div style="font-size:0.8rem;font-weight:600;color:rgba(255,255,255,0.7);margin-bottom:0.5rem;letter-spacing:0.03em">
                STAR RATING FILTER
            </div>
            <div style="display:flex;gap:0.5rem;flex-wrap:wrap" id="starFilterBtns">
                <button class="star-filter-btn" data-stars="0" onclick="toggleStarFilter(this,0)"
                    style="padding:7px 14px;border-radius:20px;border:1.5px solid rgba(255,255,255,0.25);background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.8);font-size:12px;font-weight:600;cursor:pointer;transition:.2s">
                    All ‚òÖ
                </button>
                <button class="star-filter-btn" data-stars="3" onclick="toggleStarFilter(this,3)"
                    style="padding:7px 14px;border-radius:20px;border:1.5px solid rgba(255,255,255,0.25);background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.8);font-size:12px;font-weight:600;cursor:pointer;transition:.2s">
                    ‚òÖ‚òÖ‚òÖ 3 Star
                </button>
                <button class="star-filter-btn" data-stars="4" onclick="toggleStarFilter(this,4)"
                    style="padding:7px 14px;border-radius:20px;border:1.5px solid rgba(255,255,255,0.25);background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.8);font-size:12px;font-weight:600;cursor:pointer;transition:.2s">
                    ‚òÖ‚òÖ‚òÖ‚òÖ 4 Star
                </button>
                <button class="star-filter-btn" data-stars="5" onclick="toggleStarFilter(this,5)"
                    style="padding:7px 14px;border-radius:20px;border:1.5px solid rgba(255,255,255,0.25);background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.8);font-size:12px;font-weight:600;cursor:pointer;transition:.2s">
                    ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 5 Star
                </button>
            </div>
        </div>

        <button class="liveHotelSearchBtn" id="lhSearchBtn" onclick="doLiveHotelSearch()">
            üîç Search Live Hotels
        </button>

        <div id="lhResultsArea" style="flex:1 1 auto;min-height:0;overflow:visible"></div>

        <div class="liveHotelModalFooter">
            <button class="liveHotelModalConfirmBtn" id="lhConfirmBtn" disabled onclick="confirmLiveHotelSelection()">
                ‚úì Use Selected Hotel
            </button>
            <button class="liveHotelModalCancelBtn" onclick="cancelLiveHotelModal()">
                Cancel
            </button>
        </div>
    </div>
</div>

<header>
    <div class="brand-tagline">AKS Hospitality: Journeys that awaken the soul</div>
    Trip Package Assistant
    <div class="subtitle">AI-Powered Travel Planner</div>
    <a href="/admin" class="admin-link">Admin Panel</a>
</header>

<div id="mainContainer">
    <div id="chatbotContainer">
        <div id="messages"></div>
        <div id="optionsContainer"></div>
        <div id="aiQuickBar">
            <button class="qchip" onclick="sendAIMessage('Explain my current package in detail')">üìã Explain Package</button>
            <button class="qchip" onclick="sendAIMessage('Suggest me a perfect package based on my preferences')">‚ú® Suggest Package</button>
            <button class="qchip" onclick="sendAIMessage('What is the best time to visit my destination?')">üå§ Best Time</button>
            <button class="qchip" onclick="sendAIMessage('What are the must-see attractions there?')">üìç Top Attractions</button>
            <button class="qchip" onclick="sendAIMessage('How can I upgrade or improve this trip?')">‚¨Ü Upgrade Ideas</button>
            <span id="aiStatusBadge" class="limited">‚è≥ Loading‚Ä¶</span>
        </div>
        <div id="aiInputContainer">
            <input type="text" id="aiInput" placeholder="Ask me anything about your trip..." autocomplete="off" />
            <button id="voiceBtn" onclick="toggleVoiceInput()" title="Voice input" aria-label="Voice input">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
            </button>
            <span class="voice-status" id="voiceStatus"></span>
            <button id="aiInputBtn" onclick="sendAIMessage()">Send</button>
        </div>
    </div>
    <div id="sidebar">
        <h3 style="margin-bottom:1rem;font-size:1.1rem;font-weight:600;display:flex;justify-content:space-between;align-items:center">
            Trip Summary
            <button id="sidebarCloseBtn" onclick="toggleMobileSidebar()" style="display:none;background:none;border:none;color:#fff;cursor:pointer;font-size:1.2rem;padding:4px;line-height:1">√ó</button>
        </h3>
        <div class="summary">Waiting for inputs‚Ä¶</div>
    </div>
</div>

<script>
/* ============================================================
   MOBILE SIDEBAR TOGGLE
   ============================================================ */
function toggleMobileSidebar(){
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobileSidebarOverlay');
    const closeBtn = document.getElementById('sidebarCloseBtn');
    const isMobile = window.innerWidth <= 768;
    if(!isMobile) return;
    const isOpen = sidebar.classList.contains('mobile-open');
    if(isOpen){
        sidebar.classList.remove('mobile-open');
        overlay.classList.remove('show');
        closeBtn.style.display = 'none';
    } else {
        sidebar.classList.add('mobile-open');
        overlay.classList.add('show');
        closeBtn.style.display = 'block';
    }
}

window.addEventListener('resize', ()=>{
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobileSidebarOverlay');
    const closeBtn = document.getElementById('sidebarCloseBtn');
    if(window.innerWidth > 768){
        sidebar.classList.remove('mobile-open');
        overlay.classList.remove('show');
        closeBtn.style.display = 'none';
    }
});

/* ============================================================
   CONFIGURATION
   ============================================================ */
const API_BASE = window.location.origin;
const CLIENT_ID = 1;

/* ============================================================
   DYNAMIC DATA
   ============================================================ */
let allRegions=[], allHotels=[], allTransports=[], allDestinations=[], allAddons=[], allCabs=[];

async function loadAllData(){
    try{
        const [regR,hotR,traR,desR,addR,cabR] = await Promise.all([
            fetch(`${API_BASE}/api/regions?client_id=${CLIENT_ID}`),
            fetch(`${API_BASE}/api/hotels?client_id=${CLIENT_ID}`),
            fetch(`${API_BASE}/api/transports?client_id=${CLIENT_ID}`),
            fetch(`${API_BASE}/api/destinations?client_id=${CLIENT_ID}`),
            fetch(`${API_BASE}/api/addons?client_id=${CLIENT_ID}`),
            fetch(`${API_BASE}/api/cabs?client_id=${CLIENT_ID}`)
        ]);
        allRegions=await regR.json();
        allHotels=await hotR.json();
        allTransports=await traR.json();
        allDestinations=await desR.json();
        allAddons=await addR.json();
        allCabs=await cabR.json();
        console.log("Data loaded",{regions:allRegions.length,hotels:allHotels.length,transports:allTransports.length,destinations:allDestinations.length,addons:allAddons.length,cabs:allCabs.length});
        if(allHotels.length>0 && !selectedHotel) selectedHotel=allHotels[0].internal_name;
        if(allCabs.length>0 && !selectedCab) selectedCab=allCabs[0].internal_name;
    }catch(e){console.error("Data load failed:",e);}
}

/* ============================================================
   DISPLAY NAME HELPERS
   ============================================================ */
function getRegionDisplayName(rid){const r=allRegions.find(x=>x.id===rid);return r?r.name:rid;}
function getHotelDisplayName(iname){const h=allHotels.find(x=>x.internal_name===iname);return h?h.name:iname;}
function getTransportDisplayName(iname){const t=allTransports.find(x=>x.transport_type===iname);return t?t.display_name:iname;}
function getDestinationDisplayName(iname){const d=allDestinations.find(x=>x.internal_name===iname);return d?d.display_name:iname;}
function getCabDisplayName(iname){const c=allCabs.find(x=>x.internal_name===iname);return c?c.display_name:iname;}
function formatCurrency(n){return '‚Çπ' + Math.round(n).toLocaleString('en-IN');}
function formatDateTime(iso){
    if(!iso) return '‚Äî';
    try{
        const d=new Date(iso);
        return d.toLocaleString('en-IN',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit',hour12:true});
    }catch(e){return iso;}
}

/* ============================================================
   STEPS
   ============================================================ */
const STEPS={WELCOME:0,REGION_TYPE:1,DESTINATION:2,SEASON:3,TRAVELERS:4,STAY_EXPERIENCE:5,ROOMS:6,TRANSPORT:7,CAB:8,ADDONS:9};
let currentStep=STEPS.WELCOME, stepHistory=[];
let selectedRegionType="",selectedRegion=null,selectedDestination=null,selectedSeason="";
let selectedAdults=2,selectedChildren=0,selectedNights=0,selectedSightseeingDays=0,selectedRooms=0;
let selectedTransport="",selectedCab="",selectedHotel="",kasolSharing="";
let sightseeingSelectionsState=[],perNightHotels={},perNightKasolSharing={},selectedAddons=[];

/* ============================================================
   TRIP TYPE STATE (NEW ‚Äî ONE WAY / RETURN)
   ============================================================ */
let tripType = "return"; // default: return

/* ============================================================
   HOTEL SOURCE STATE
   ============================================================ */
let hotelSource = 'admin';

let liveHotelState = {
    cityCode: '',
    checkInDate: '',
    checkOutDate: '',
    selectedOffer: null,
    searchResults: [],
    nights: 0,
    searchMode: 'city',
    hotelNameQuery: '',
    hotelNameSelected: null,
};

function resetLiveHotelState(){
    liveHotelState = {
        cityCode:'',checkInDate:'',checkOutDate:'',
        selectedOffer:null,searchResults:[],nights:0,
        searchMode:'city',hotelNameQuery:'',hotelNameSelected:null
    };
}

function resetAdminHotelState(){
    perNightHotels = {};
    perNightKasolSharing = {};
    kasolSharing = '';
}

/* ============================================================
   FLIGHT STATE
   ============================================================ */
let flightState = {
    mode: 'none',
    origin: '',
    destination: '',
    departureDate: '',
    returnDate: '',
    selectedOffer: null,
    detailData: null,
    detailLoading: false,
};

function resetFlightState(){
    flightState = {mode:'none',origin:'',destination:'',departureDate:'',returnDate:'',selectedOffer:null,detailData:null,detailLoading:false};
}

function isFlightTransport(transportKey){
    if(!transportKey) return false;
    return transportKey.toUpperCase().includes('FLIGHT') || transportKey.toUpperCase().includes('AIR') || transportKey.toUpperCase().includes('FLY');
}

window.isAIModification=false; window.lastCalculation=null; window.sessionId="session_"+Date.now(); window.cabRequired=false;
// Conversation memory ‚Äî sent to backend so Sharad remembers previous messages
window.conversationHistory=[];

/* ============================================================
   HOTEL NAME AUTOCOMPLETE STATE
   ============================================================ */
let hotelNameDebounceTimer = null;
let hotelNameAbortController = null;
const HOTEL_NAME_DEBOUNCE_MS = 500;

/* ============================================================
   LIVE SEARCH MODE
   ============================================================ */
function setLiveSearchMode(mode){

    // If switching to a different mode, clear stale selection and results

    // so the confirm flow always reflects the active search mode.

    if(liveHotelState.searchMode !== mode){

        liveHotelState.selectedOffer = null;

        liveHotelState.searchResults = [];

        const confirmBtn = document.getElementById('lhConfirmBtn');

        if(confirmBtn) confirmBtn.disabled = true;

        const resultsArea = document.getElementById('lhResultsArea');

        if(resultsArea) resultsArea.innerHTML = '';

    }

    liveHotelState.searchMode = mode;

    document.getElementById('lhTabCity').classList.toggle('active', mode==='city');
    document.getElementById('lhTabName').classList.toggle('active', mode==='name');
    document.getElementById('lhTabBoth').classList.toggle('active', mode==='both');

    // City fields (original)
    const citySection = document.getElementById('lhCitySection');
    const nameSection = document.getElementById('lhNameSection');
    const nameDatesSection = document.getElementById('lhNameDatesSection');

    if(mode === 'city'){
        citySection.style.display = 'grid';
        nameSection.style.display = 'none';
        nameDatesSection.style.display = 'none';
    } else if(mode === 'name'){
        citySection.style.display = 'none';
        nameSection.style.display = 'block';
        nameDatesSection.style.display = 'block';
    } else { // both
        citySection.style.display = 'grid';
        nameSection.style.display = 'block';
        nameDatesSection.style.display = 'none';
    }
}

/* ============================================================
   HOTEL NAME AUTOCOMPLETE
   ============================================================ */
function onHotelNameInput(){
    const input = document.getElementById('lhHotelNameInput');
    const query = (input ? input.value : '').trim();
    liveHotelState.hotelNameQuery = query;

    // Clear any pending timer
    if(hotelNameDebounceTimer) clearTimeout(hotelNameDebounceTimer);

    // If query too short, hide dropdown
    if(query.length < 3){
        hideHotelNameAutocomplete();
        return;
    }

    // Show searching status
    showHotelNameStatus('searching', '‚åõ Searching hotels‚Ä¶');

    // Debounce
    hotelNameDebounceTimer = setTimeout(()=>{
        fetchHotelNameAutocomplete(query);
    }, HOTEL_NAME_DEBOUNCE_MS);
}

async function fetchHotelNameAutocomplete(query){
    // Abort previous request if any
    if(hotelNameAbortController){
        try{ hotelNameAbortController.abort(); }catch(e){}
    }
    hotelNameAbortController = new AbortController();

    try{
        const url = `${API_BASE}/hotel-lookup?q=${encodeURIComponent(query)}&limit=10`;
        const resp = await fetch(url, { signal: hotelNameAbortController.signal });

        if(resp.status === 429){
            showHotelNameStatus('rate-limited', '‚ö†Ô∏è Too many requests. Please wait a moment.');
            hideHotelNameAutocompleteDropdown();
            return;
        }

        const data = await resp.json();
        hideHotelNameStatus();

        if(data.error && (!data.results || !data.results.length)){
            showHotelNameStatus('error', `‚ö†Ô∏è ${data.error}`);
            hideHotelNameAutocompleteDropdown();
            return;
        }

        const results = data.results || [];
        if(!results.length){
            showHotelNameStatus('error', `No hotels found for "${query}".`);
            hideHotelNameAutocompleteDropdown();
            return;
        }

        renderHotelNameAutocomplete(results);

    }catch(e){
        if(e.name === 'AbortError') return; // Request was cancelled
        console.error('Hotel autocomplete error:', e);
        showHotelNameStatus('error', '‚ö†Ô∏è Hotel lookup unavailable. Please try again.');
        hideHotelNameAutocompleteDropdown();
    }
}

function renderHotelNameAutocomplete(results){
    const container = document.getElementById('lhHotelNameAutocomplete');
    if(!container) return;

    container.innerHTML = '';
    container.style.display = 'block';

    results.forEach(hotel => {
        const item = document.createElement('div');
        item.className = 'hotelNameAutocompleteItem';

        const nameEl = document.createElement('div');
        nameEl.className = 'ac-name';
        nameEl.textContent = hotel.hotel_name;

        const metaEl = document.createElement('div');
        metaEl.className = 'ac-meta';
        const parts = [];
        if(hotel.city) parts.push(hotel.city);
        if(hotel.country) parts.push(hotel.country);
        if(hotel.hotelId) parts.push(`ID: ${hotel.hotelId}`);
        metaEl.textContent = parts.join(' ¬∑ ');

        item.append(nameEl, metaEl);

        item.onclick = ()=>{
            selectHotelNameAutocompleteItem(hotel);
        };

        container.appendChild(item);
    });

    // Close autocomplete when clicking outside
    document.addEventListener('click', closeHotelNameAutocompleteOnClickOutside, {once: true});
}

function selectHotelNameAutocompleteItem(hotel){
    liveHotelState.hotelNameSelected = hotel;
    liveHotelState.hotelNameQuery = hotel.hotel_name;

    const input = document.getElementById('lhHotelNameInput');
    if(input) input.value = hotel.hotel_name;

    hideHotelNameAutocompleteDropdown();
    hideHotelNameStatus();

    // Show selected pill
    renderHotelNameSelectedPill(hotel);

    // If city available from hotel, auto-fill city code
    if(hotel.iataCode){
        const cityInput = document.getElementById('lhCityCode');
        if(cityInput && !cityInput.value) cityInput.value = hotel.iataCode;
    }

    // ‚îÄ‚îÄ AUTO-SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // When the user picks a hotel from the autocomplete dropdown, immediately
    // fire the Amadeus search if all required inputs are already populated.
    // 'name' mode uses lhCheckIn2/lhCheckOut2; 'both' mode uses lhCheckIn/lhCheckOut + city.
    // A 250 ms delay lets the iataCode auto-fill and pill render settle first.
    const _autoMode = liveHotelState.searchMode || 'city';
    if(_autoMode === 'name' || _autoMode === 'both'){
        const _autoCi = (_autoMode === 'name')
            ? (document.getElementById('lhCheckIn2')?.value || '')
            : (document.getElementById('lhCheckIn')?.value || '');
        const _autoCo = (_autoMode === 'name')
            ? (document.getElementById('lhCheckOut2')?.value || '')
            : (document.getElementById('lhCheckOut')?.value || '');
        // For 'both' mode a city code is required; for 'name' mode it's optional
        const _autoCity = (_autoMode === 'both')
            ? (document.getElementById('lhCityCode')?.value || '').trim()
            : 'OK';
        if(_autoCi && _autoCo && _autoCity.length >= 2){
            setTimeout(()=>doLiveHotelSearch(), 250);
        }
    }
}

function renderHotelNameSelectedPill(hotel){
    const pillContainer = document.getElementById('lhHotelNameSelectedPill');
    if(!pillContainer) return;

    pillContainer.style.display = 'block';
    const parts = [];
    if(hotel.city) parts.push(hotel.city);
    if(hotel.country) parts.push(hotel.country);

    pillContainer.innerHTML = `
        <div class="hotelNameSearchSelectedPill">
            üè® ${hotel.hotel_name}${parts.length?' ‚Äî '+parts.join(', '):''}
            <button class="pill-clear" onclick="clearHotelNameSelection()" title="Clear">‚úï</button>
        </div>`;
}

function clearHotelNameSelection(){
    liveHotelState.hotelNameSelected = null;
    liveHotelState.hotelNameQuery = '';
    const input = document.getElementById('lhHotelNameInput');
    if(input) input.value = '';
    const pillContainer = document.getElementById('lhHotelNameSelectedPill');
    if(pillContainer){ pillContainer.style.display = 'none'; pillContainer.innerHTML = ''; }
}

function hideHotelNameAutocomplete(){
    hideHotelNameAutocompleteDropdown();
    hideHotelNameStatus();
}

function hideHotelNameAutocompleteDropdown(){
    const container = document.getElementById('lhHotelNameAutocomplete');
    if(container){ container.style.display = 'none'; container.innerHTML = ''; }
}

function showHotelNameStatus(type, msg){
    const statusEl = document.getElementById('lhHotelNameStatus');
    if(!statusEl) return;
    statusEl.style.display = 'flex';
    statusEl.className = `hotelNameSearchStatus ${type}`;
    statusEl.textContent = msg;
}

function hideHotelNameStatus(){
    const statusEl = document.getElementById('lhHotelNameStatus');
    if(statusEl){ statusEl.style.display = 'none'; statusEl.textContent = ''; }
}

function closeHotelNameAutocompleteOnClickOutside(e){
    const container = document.getElementById('lhHotelNameAutocomplete');
    const input = document.getElementById('lhHotelNameInput');
    if(container && input && !container.contains(e.target) && e.target !== input){
        hideHotelNameAutocompleteDropdown();
    }
}

function syncDates2to1(){
    const ci2 = document.getElementById('lhCheckIn2');
    const co2 = document.getElementById('lhCheckOut2');
    if(!ci2 || !co2) return;
    // Sync to the main date fields if they exist
    const ci1 = document.getElementById('lhCheckIn');
    const co1 = document.getElementById('lhCheckOut');
    if(ci1 && ci2.value) ci1.value = ci2.value;
    if(co1 && co2.value) co1.value = co2.value;
    liveHotelState.checkInDate = ci2.value;
    liveHotelState.checkOutDate = co2.value;
    // Mirror what onLiveHotelCheckOutChange() does for city/both modes:
    // keep liveHotelState.nights and selectedNights in sync with the date fields.
    if(ci2.value && co2.value){
        const diffDays = Math.round((new Date(co2.value) - new Date(ci2.value)) / (1000 * 60 * 60 * 24));
        if(diffDays > 0){
            liveHotelState.nights = diffDays;
            if(diffDays !== selectedNights) selectedNights = diffDays;
        }
    }
    updateLiveHotelNightsNote();
}

/* ============================================================
   UI HELPERS
   ============================================================ */
const messages=document.getElementById("messages");
const optionsContainer=document.getElementById("optionsContainer");
function scrollToBottom(){requestAnimationFrame(()=>{requestAnimationFrame(()=>{messages.scrollTop=messages.scrollHeight;});});}
function addBot(msg){
    const d=document.createElement('div');
    d.className='botMessage';
    // Rich inline formatting: **bold**, *italic*, bullet lines, --- hr
    let html=msg
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
        .replace(/\*(.+?)\*/g,'<em>$1</em>')
        .replace(/^---$/gm,'<hr>')
        .replace(/^[‚Ä¢\-] (.+)$/gm,'<span class="ai-bullet">$1</span>')
        .replace(/\n/g,'<br>');
    d.innerHTML=html;
    d.style.opacity='0';
    messages.appendChild(d);
    requestAnimationFrame(()=>{requestAnimationFrame(()=>{d.style.opacity='1';});});
    scrollToBottom();
}
function addUser(msg){const d=document.createElement('div');d.className='userMessage';d.textContent=msg;d.style.opacity='0';messages.appendChild(d);requestAnimationFrame(()=>{requestAnimationFrame(()=>{d.style.opacity='1';});});scrollToBottom();}
function addTypingIndicator(){const t=document.createElement('div');t.className='botMessage typing-indicator';t.innerHTML='<span></span><span></span><span></span>';t.id='typingIndicator';messages.appendChild(t);scrollToBottom();}
function removeTypingIndicator(){const t=document.getElementById('typingIndicator');if(t)t.remove();}

function updateNavButtons(){
    const navGroup = document.getElementById('navBtnGroup');
    if(stepHistory.length > 0){
        navGroup.classList.remove('hidden');
        navGroup.classList.add('visible');
    } else {
        navGroup.classList.remove('visible');
        navGroup.classList.add('hidden');
    }
}
function goBack(){if(!stepHistory.length)return;currentStep=stepHistory.pop();optionsContainer.innerHTML="";updateNavButtons();updateSummary();renderStep();}

function goHome(){
    // Full state reset without page reload
    currentStep=STEPS.WELCOME;
    stepHistory=[];
    selectedRegionType='';selectedRegion=null;selectedDestination=null;selectedSeason='';
    selectedAdults=2;selectedChildren=0;selectedNights=0;selectedSightseeingDays=0;selectedRooms=0;
    selectedTransport='';selectedCab='';selectedHotel='';kasolSharing='';
    sightseeingSelectionsState=[];perNightHotels={};perNightKasolSharing={};selectedAddons=[];
    tripType='return';
    hotelSource='admin';
    resetLiveHotelState();
    resetFlightState();
    window.lastCalculation=null;
    window.conversationHistory=[];
    messages.innerHTML='';
    optionsContainer.innerHTML='';
    updateNavButtons();
    updateSummary();
    renderStep();
}

async function checkIfCabRequired(){try{const r=await fetch(`${API_BASE}/check-cab-required`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transport:selectedTransport,days:sightseeingSelectionsState})});const d=await r.json();window.cabRequired=d.cabRequired;}catch(e){window.cabRequired=true;}}

/* ============================================================
   FILTERING HELPERS
   ============================================================ */
function getFilteredRegions(){
    if(!selectedRegionType) return allRegions;
    const isDomestic = selectedRegionType==="DOMESTIC";
    return allRegions.filter(r=>{const regionIsDomestic=Boolean(r.is_domestic);return regionIsDomestic===isDomestic;});
}
function getFilteredHotels(){if(!selectedRegion) return allHotels;return allHotels.filter(h=>h.region_id===selectedRegion);}
function getFilteredTransports(){if(!selectedRegion) return allTransports;return allTransports.filter(t=>t.region_id===selectedRegion);}
function getFilteredDestinations(){if(!selectedRegion) return allDestinations;return allDestinations.filter(d=>d.region_id===selectedRegion);}
function getFilteredAddons(){if(!selectedRegion) return allAddons;return allAddons.filter(a=>a.region_id===selectedRegion);}
function getFilteredCabs(){if(!selectedRegion) return allCabs;return allCabs.filter(c=>c.region_id===selectedRegion);}

/* ============================================================
   STEP RENDERER
   ============================================================ */
function renderStep(){
    updateNavButtons();
    optionsContainer.innerHTML="";
    switch(currentStep){
        case STEPS.WELCOME:renderWelcome();break;
        case STEPS.REGION_TYPE:renderRegionType();break;
        case STEPS.DESTINATION:renderDestination();break;
        case STEPS.SEASON:renderSeason();break;
        case STEPS.TRAVELERS:renderTravelers();break;
        case STEPS.STAY_EXPERIENCE:renderStayExperience();break;
        case STEPS.ROOMS:renderRooms();break;
        case STEPS.TRANSPORT:renderTransport();break;
        case STEPS.CAB:checkIfCabRequired().then(()=>{if(window.cabRequired){renderCab();}else{currentStep=STEPS.ADDONS;renderStep();}});break;
        case STEPS.ADDONS:
            if(hotelSource === 'live'){
                addBot("Add-ons are not available when booking live hotels. Proceeding to price calculation...");
                setTimeout(()=>submitData(), 800);
            } else {
                renderAddons();
            }
            break;
        default:addBot("Flow completed!");break;
    }
}

function autoAdvance(value,nextStep=null){
    addUser(value);
    stepHistory.push(currentStep);
    currentStep=nextStep!==null?nextStep:currentStep+1;
    updateNavButtons();
    updateSummary();
    setTimeout(()=>renderStep(),300);
}

function renderWelcome(){addBot("Hi, I am Sharad, your AI-powered package advisor. Let's create your perfect trip!");setTimeout(()=>{stepHistory.push(currentStep);currentStep=STEPS.REGION_TYPE;updateNavButtons();renderStep();},1000);}

function renderRegionType(){addBot("Are you planning a domestic or international trip?");
    ["Domestic","International"].forEach(t=>{const b=document.createElement("button");b.className="optionButton";b.innerText=t;b.onclick=()=>{selectedRegionType=t==="Domestic"?"DOMESTIC":"INTERNATIONAL";autoAdvance(t);};optionsContainer.appendChild(b);});}

function renderDestination(){
    addBot("Select your destination:");
    const filtered=getFilteredRegions();
    if(!filtered.length){addBot("No destinations available for this selection. Please go back and choose a different option.");return;}
    filtered.forEach(r=>{
        const b=document.createElement("button");b.className="optionButton";b.innerText=r.name;
        b.onclick=()=>{
            selectedRegion=r.id;selectedDestination=r.name;
            const regionHotels=getFilteredHotels();const regionCabs=getFilteredCabs();
            if(regionHotels.length>0)selectedHotel=regionHotels[0].internal_name;
            if(regionCabs.length>0)selectedCab=regionCabs[0].internal_name;
            autoAdvance(r.name);
        };
        optionsContainer.appendChild(b);
    });
}

function renderSeason(){addBot("Season or Off Season?");
    [["Season","ON","Peak Season"],["Off Season","OFF","Off Season"]].forEach(([label,val,display])=>{const b=document.createElement("button");b.className="optionButton";b.innerText=label;b.onclick=()=>{selectedSeason=val;autoAdvance(display);};optionsContainer.appendChild(b);});}

/* ============================================================
   TRAVELERS STEP
   ============================================================ */
function renderTravelers(){
    addBot("How many travelers will be joining the trip?");
    const container = document.createElement('div');
    container.className = 'counterSelectorContainer';
    const rows = [
        {label:'Adults',key:'adults',min:1,max:20,val:selectedAdults},
        {label:'Children',key:'children',min:0,max:10,val:selectedChildren}
    ];
    rows.forEach(({label,key,min,max,val})=>{
        const row=document.createElement('div');row.className='counterRow';
        const lbl=document.createElement('span');lbl.className='counterLabel';lbl.textContent=label;
        const controls=document.createElement('div');controls.className='counterControls';
        const minusBtn=document.createElement('button');minusBtn.className='counterBtn';minusBtn.textContent='-';
        const valueSpan=document.createElement('span');valueSpan.className='counterValue';valueSpan.textContent=val;valueSpan.id=`counter_${key}`;
        const plusBtn=document.createElement('button');plusBtn.className='counterBtn';plusBtn.textContent='+';
        minusBtn.onclick=()=>{let cur=parseInt(valueSpan.textContent);if(cur>min){valueSpan.textContent=cur-1;}};
        plusBtn.onclick=()=>{let cur=parseInt(valueSpan.textContent);if(cur<max){valueSpan.textContent=cur+1;}};
        controls.append(minusBtn,valueSpan,plusBtn);
        row.append(lbl,controls);
        container.appendChild(row);
    });
    const confirmBtn=document.createElement('button');
    confirmBtn.className='optionButton';
    confirmBtn.style.marginTop='1rem';
    confirmBtn.style.width='100%';
    confirmBtn.textContent='Confirm Travelers ‚Üí';
    confirmBtn.onclick=()=>{
        selectedAdults=parseInt(document.getElementById('counter_adults').textContent);
        selectedChildren=parseInt(document.getElementById('counter_children').textContent);
        autoAdvance(`${selectedAdults} adult${selectedAdults!==1?'s':''}${selectedChildren>0?`, ${selectedChildren} child${selectedChildren!==1?'ren':''}`:''}`);
    };
    optionsContainer.appendChild(container);
    optionsContainer.appendChild(confirmBtn);
}

/* ============================================================
   STAY EXPERIENCE STEP
   ============================================================ */
function renderStayExperience(){
    addBot("How many nights? And how would you like to choose your accommodation?");
    const dualContainer = document.createElement('div');
    dualContainer.className = 'dualSelectorContainer';
    const nightsCol = document.createElement('div');
    nightsCol.className = 'selectorColumn';
    const nightsLabel = document.createElement('span');
    nightsLabel.className = 'selectorLabel';
    nightsLabel.textContent = 'üåô Nights';
    const nightsScroll = document.createElement('div');
    nightsScroll.className = 'horizontalScroll';
    for(let i=1;i<=14;i++){
        const opt=document.createElement('button');
        opt.className='magnifyOption'+(i===selectedNights?' active':'');
        opt.textContent=i;
        opt.dataset.val=i;
        opt.onclick=()=>{
            nightsScroll.querySelectorAll('.magnifyOption').forEach(x=>x.classList.remove('active'));
            opt.classList.add('active');
            selectedNights=i;
            updateNightsInSightseeing();
            updateLiveHotelCheckOutFromNights();
        };
        nightsScroll.appendChild(opt);
    }
    nightsCol.append(nightsLabel,nightsScroll);
    const sigCol = document.createElement('div');
    sigCol.className = 'selectorColumn';
    const sigLabel = document.createElement('span');
    sigLabel.className = 'selectorLabel';
    sigLabel.textContent = 'üó∫Ô∏è Sightseeing Days';
    const sigScroll = document.createElement('div');
    sigScroll.className = 'horizontalScroll';
    for(let i=0;i<=10;i++){
        const opt=document.createElement('button');
        opt.className='magnifyOption'+(i===selectedSightseeingDays?' active':'');
        opt.textContent=i===0?'None':i;
        opt.dataset.val=i;
        opt.onclick=()=>{
            sigScroll.querySelectorAll('.magnifyOption').forEach(x=>x.classList.remove('active'));
            opt.classList.add('active');
            selectedSightseeingDays=i;
        };
        sigScroll.appendChild(opt);
    }
    sigCol.append(sigLabel,sigScroll);
    dualContainer.append(nightsCol,sigCol);
    optionsContainer.appendChild(dualContainer);

    // Hotel Source
    const sourceContainer = document.createElement('div');
    sourceContainer.className = 'hotelSourceContainer';
    const sourceLabel = document.createElement('span');
    sourceLabel.className = 'hotelSourceLabel';
    sourceLabel.textContent = 'üè® Accommodation Source';
    const sourceBtns = document.createElement('div');
    sourceBtns.className = 'hotelSourceBtns';
    const adminBtn = document.createElement('button');
    adminBtn.className = 'hotelSourceBtn' + (hotelSource==='admin'?' active':'');
    adminBtn.innerHTML = '<span class="btn-icon">üóÑÔ∏è</span> Our Hotels';
    adminBtn.onclick = () => {
        if(hotelSource !== 'admin'){
            hotelSource = 'admin';
            resetLiveHotelState();
            adminBtn.classList.add('active');
            liveBtn.classList.remove('active');
            const ac=document.getElementById('adminHotelSelectContainer');if(ac)ac.style.display='block';
            updateSummary();
        }
    };
    const liveBtn = document.createElement('button');
    liveBtn.className = 'hotelSourceBtn' + (hotelSource==='live'?' active':'');
    liveBtn.innerHTML = '<span class="btn-icon">üåê</span> Live Hotels (Amadeus)';
    liveBtn.onclick = () => {
        if(hotelSource !== 'live'){
            hotelSource = 'live';
            resetAdminHotelState();
            liveBtn.classList.add('active');
            adminBtn.classList.remove('active');
            const ac=document.getElementById('adminHotelSelectContainer');if(ac)ac.style.display='none';
            updateSummary();
            openLiveHotelModal();
        }
    };
    sourceBtns.append(adminBtn,liveBtn);
    sourceContainer.append(sourceLabel,sourceBtns);
    optionsContainer.appendChild(sourceContainer);

    const liveHotelBadgeContainer = document.createElement('div');
    liveHotelBadgeContainer.id = 'liveHotelBadgeArea';
    renderLiveHotelBadge(liveHotelBadgeContainer);
    optionsContainer.appendChild(liveHotelBadgeContainer);

    const hotelSelectContainer = document.createElement('div');
    hotelSelectContainer.className = 'hotelSelectContainer';
    hotelSelectContainer.id = 'adminHotelSelectContainer';
    hotelSelectContainer.style.display = hotelSource==='admin' ? 'block' : 'none';
    const hotelSelect = document.createElement('select');
    hotelSelect.className = 'hotelSelect';
    const nullOpt = document.createElement('option');
    nullOpt.value='';nullOpt.textContent='‚Äî Select Hotel (optional) ‚Äî';
    hotelSelect.appendChild(nullOpt);
    getFilteredHotels().forEach(h=>{
        const o=document.createElement('option');
        o.value=h.internal_name;o.textContent=h.name;
        if(h.internal_name===selectedHotel)o.selected=true;
        hotelSelect.appendChild(o);
    });
    hotelSelect.onchange=()=>{selectedHotel=hotelSelect.value;renderKasolSharing(hotelSelectContainer);updateSummary();};
    hotelSelectContainer.appendChild(hotelSelect);
    renderKasolSharing(hotelSelectContainer);
    optionsContainer.appendChild(hotelSelectContainer);

    const sigConfigLabel = document.createElement('div');
    sigConfigLabel.style.cssText = 'margin-top:1.5rem;font-weight:600;font-size:0.9rem;margin-bottom:0.75rem;color:rgba(255,255,255,0.8)';
    sigConfigLabel.textContent = 'üìç Sightseeing Configuration';
    optionsContainer.appendChild(sigConfigLabel);
    renderSightseeingSelections(optionsContainer);

    const confirmBtn=document.createElement('button');
    confirmBtn.className='optionButton';
    confirmBtn.style.cssText='margin-top:1.5rem;width:100%;padding:1rem;font-size:1rem;font-weight:700';
    confirmBtn.textContent='Confirm Stay & Continue ‚Üí';
    confirmBtn.onclick=()=>{
        const activeNight=nightsScroll.querySelector('.magnifyOption.active');
        if(activeNight) selectedNights=parseInt(activeNight.dataset.val);
        const activeSig=sigScroll.querySelector('.magnifyOption.active');
        if(activeSig) selectedSightseeingDays=parseInt(activeSig.dataset.val);
        if(selectedNights<=0){addBot("Please select at least 1 night.");return;}
        if(hotelSource==='live' && !liveHotelState.selectedOffer){
            addBot("You selected Live Hotels mode. Please search and select a hotel first.");
            openLiveHotelModal();
            return;
        }
        let summary = `${selectedNights} night${selectedNights!==1?'s':''}, ${selectedSightseeingDays} sightseeing day${selectedSightseeingDays!==1?'s':''}`;
        if(hotelSource==='live' && liveHotelState.selectedOffer){
            summary += ` | Live Hotel: ${liveHotelState.selectedOffer.hotelName}`;
        } else if(hotelSource==='admin' && selectedHotel){
            summary += ` | Hotel: ${getHotelDisplayName(selectedHotel)}`;
        }
        autoAdvance(summary);
    };
    optionsContainer.appendChild(confirmBtn);
}

function updateNightsInSightseeing(){
    const sigContainer = document.getElementById('sightseeingDynamicContainer');
    if(sigContainer) renderSightseeingSelections(sigContainer.parentElement, true);
}

function updateLiveHotelCheckOutFromNights(){
    const checkIn = document.getElementById('lhCheckIn');
    const checkOut = document.getElementById('lhCheckOut');
    if(checkIn && checkIn.value && selectedNights>0){
        const ci = new Date(checkIn.value);
        ci.setDate(ci.getDate() + selectedNights);
        checkOut.value = ci.toISOString().split('T')[0];
        updateLiveHotelNightsNote();
    }
}

/* ============================================================
   KASOL SHARING HELPER
   ============================================================ */
function renderKasolSharing(parentEl){
    const existingKasol = parentEl.querySelector('.kasolSharingContainer');
    if(existingKasol) existingKasol.remove();
    if(!selectedHotel || hotelSource!=='admin') return;
    const hotel = allHotels.find(h=>h.internal_name===selectedHotel);
    if(!hotel || !hotel.is_kasol) return;
    const kasolContainer = document.createElement('div');
    kasolContainer.className = 'kasolSharingContainer';
    const lbl = document.createElement('span');
    lbl.className = 'kasolSharingLabel';
    lbl.textContent = 'Sharing Type for Kasol Hotel:';
    const btns = document.createElement('div');
    btns.className = 'kasolSharingButtons';
    ['DOUBLE','TRIPLE','QUAD'].forEach(type=>{
        const b=document.createElement('button');
        b.className='kasolSharingButton'+(kasolSharing===type?' active':'');
        b.textContent=type;
        b.onclick=()=>{
            kasolSharing=type;
            btns.querySelectorAll('.kasolSharingButton').forEach(x=>x.classList.remove('active'));
            b.classList.add('active');
        };
        btns.appendChild(b);
    });
    kasolContainer.append(lbl,btns);
    parentEl.appendChild(kasolContainer);
}

/* ============================================================
   SIGHTSEEING SELECTIONS
   ============================================================ */
function renderSightseeingSelections(parentEl, replace=false){
    if(replace){
        const existing = document.getElementById('sightseeingDynamicContainer');
        if(existing) existing.remove();
    }
    const container = document.createElement('div');
    container.id = 'sightseeingDynamicContainer';
    const filteredDests = getFilteredDestinations();
    if(!filteredDests.length && selectedSightseeingDays>0){
        const noDestMsg = document.createElement('div');
        noDestMsg.style.cssText='color:rgba(255,255,255,0.5);font-size:0.875rem;padding:0.75rem;text-align:center';
        noDestMsg.textContent='No destinations available for this region.';
        container.appendChild(noDestMsg);
        parentEl.appendChild(container);
        return;
    }
    const nights = selectedNights || 3;
    // Point 4 (v4.0): Use selectedSightseeingDays exactly ‚Äî do NOT use Math.max(nights, ...).
    // The old Math.max caused extra rows to appear when nights > sightseeing days.
    const days = selectedSightseeingDays || 0;
    while(sightseeingSelectionsState.length < days){sightseeingSelectionsState.push('N/A');}
    for(let i=0;i<days;i++){
        const row = document.createElement('div');
        row.className = 'sightseeingOption';
        const rowInner = document.createElement('div');
        rowInner.className = 'sightseeingRow';
        const lbl = document.createElement('span');
        lbl.className = 'dayLabel';
        lbl.textContent = `Day ${i+1}`;
        const sel = document.createElement('select');
        const naOpt = document.createElement('option');
        naOpt.value='N/A';naOpt.textContent='‚Äî No Sightseeing ‚Äî';
        sel.appendChild(naOpt);
        filteredDests.forEach(d=>{
            const o=document.createElement('option');
            o.value=d.internal_name;o.textContent=d.display_name||d.name;
            if(sightseeingSelectionsState[i]===d.internal_name)o.selected=true;
            sel.appendChild(o);
        });
        if(sightseeingSelectionsState[i]==='N/A' || !sightseeingSelectionsState[i]) sel.value='N/A';
        sel.onchange=()=>{sightseeingSelectionsState[i]=sel.value;updateSummary();};
        rowInner.append(lbl,sel);
        if(hotelSource==='admin'){
            const hotelBtn = document.createElement('button');
            hotelBtn.className = 'addHotelBtn';
            hotelBtn.textContent = perNightHotels[i]?'üè® Change Hotel':'+ Night Hotel';
            hotelBtn.onclick=()=>{
                const pnContainer = row.querySelector('.perNightHotelContainer');
                if(pnContainer){pnContainer.style.display=pnContainer.style.display==='none'?'block':'none';}
                else{renderPerNightHotelPicker(row,i,hotelBtn);}
            };
            rowInner.appendChild(hotelBtn);
        }
        row.appendChild(rowInner);
        container.appendChild(row);
    }
    parentEl.appendChild(container);
}

function renderPerNightHotelPicker(parentRow, nightIdx, triggerBtn){
    const pnContainer = document.createElement('div');
    pnContainer.className = 'perNightHotelContainer';
    const lbl = document.createElement('div');
    lbl.className = 'perNightHotelLabel';
    lbl.textContent = `Hotel for Night ${nightIdx+1}:`;
    const sel = document.createElement('select');
    sel.className = 'hotelSelect';
    sel.style.marginTop='0.5rem';
    const defOpt = document.createElement('option');
    defOpt.value='';defOpt.textContent='‚Äî Use Default Hotel ‚Äî';
    sel.appendChild(defOpt);
    getFilteredHotels().forEach(h=>{
        const o=document.createElement('option');
        o.value=h.internal_name;o.textContent=h.name;
        if(perNightHotels[nightIdx]===h.internal_name)o.selected=true;
        sel.appendChild(o);
    });
    sel.onchange=()=>{
        if(sel.value) perNightHotels[nightIdx]=sel.value;
        else delete perNightHotels[nightIdx];
        triggerBtn.textContent=perNightHotels[nightIdx]?'üè® Change Hotel':'+ Night Hotel';
        updateSummary();
    };
    pnContainer.append(lbl,sel);
    parentRow.appendChild(pnContainer);
}

/* ============================================================
   ROOMS STEP
   ============================================================ */
function renderRooms(){
    addBot("How many rooms do you need? (We can auto-calculate based on your group size.)");
    const container = document.createElement('div');
    container.className = 'counterSelectorContainer';
    const row = document.createElement('div');
    row.className = 'counterRow';
    const lbl = document.createElement('span');
    lbl.className = 'counterLabel';
    lbl.textContent = 'Rooms (0 = auto)';
    const controls = document.createElement('div');
    controls.className = 'counterControls';
    const minusBtn = document.createElement('button');
    minusBtn.className = 'counterBtn';
    minusBtn.textContent = '-';
    const valueSpan = document.createElement('span');
    valueSpan.className = 'counterValue';
    valueSpan.textContent = selectedRooms;
    valueSpan.id = 'counter_rooms';
    const plusBtn = document.createElement('button');
    plusBtn.className = 'counterBtn';
    plusBtn.textContent = '+';
    minusBtn.onclick=()=>{let c=parseInt(valueSpan.textContent);if(c>0)valueSpan.textContent=c-1;};
    plusBtn.onclick=()=>{let c=parseInt(valueSpan.textContent);if(c<20)valueSpan.textContent=c+1;};
    controls.append(minusBtn,valueSpan,plusBtn);
    row.append(lbl,controls);
    container.appendChild(row);
    const autoNote = document.createElement('div');
    autoNote.style.cssText='font-size:0.8rem;color:rgba(255,255,255,0.5);margin-top:0.5rem;text-align:center';
    autoNote.textContent='Set to 0 to auto-calculate based on travelers and sharing type';
    container.appendChild(autoNote);
    const confirmBtn = document.createElement('button');
    confirmBtn.className = 'optionButton';
    confirmBtn.style.cssText = 'margin-top:1rem;width:100%';
    confirmBtn.textContent = 'Confirm Rooms ‚Üí';
    confirmBtn.onclick=()=>{
        selectedRooms=parseInt(document.getElementById('counter_rooms').textContent);
        autoAdvance(selectedRooms===0?'Auto rooms':''+selectedRooms+' room'+(selectedRooms!==1?'s':''));
    };
    optionsContainer.append(container,confirmBtn);
}

/* ============================================================
   TRANSPORT STEP (WITH TRIP TYPE ONE WAY / RETURN)
   ============================================================ */
function renderTransport(){
    addBot("Choose your transport option:");
    const filtered = getFilteredTransports();
    if(!filtered.length){addBot("No transport options available. Please go back.");return;}

    // Trip Type Selection
    const tripTypeContainer = document.createElement('div');
    tripTypeContainer.className = 'tripTypeContainer';
    const tripTypeLabel = document.createElement('span');
    tripTypeLabel.className = 'tripTypeLabel';
    tripTypeLabel.textContent = 'üîÑ Journey Type';
    const tripTypeBtns = document.createElement('div');
    tripTypeBtns.className = 'tripTypeBtns';

    [['one_way','üõ´ One Way'],['return','üîÅ Return (default)']].forEach(([val, label]) => {
        const btn = document.createElement('button');
        btn.className = 'tripTypeBtn' + (tripType === val ? ' active' : '');
        btn.textContent = label;
        btn.onclick = () => {
            tripType = val;
            tripTypeBtns.querySelectorAll('.tripTypeBtn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateSummary();
        };
        tripTypeBtns.appendChild(btn);
    });

    tripTypeContainer.append(tripTypeLabel, tripTypeBtns);
    optionsContainer.appendChild(tripTypeContainer);

    // Transport options
    filtered.forEach(t=>{
        const b=document.createElement('button');
        b.className='optionButton'+(selectedTransport===t.transport_type?' active':'');
        b.innerText=t.display_name||t.name;
        b.onclick=()=>{
            selectedTransport=t.transport_type;
            if(isFlightTransport(t.transport_type)){
                addUser(t.display_name||t.name);
                stepHistory.push(currentStep);
                currentStep=STEPS.CAB;
                optionsContainer.innerHTML='';
                renderFlightSection(optionsContainer);
            } else {
                resetFlightState();
                autoAdvance(t.display_name||t.name);
            }
        };
        optionsContainer.appendChild(b);
    });
}

/* ============================================================
   FLIGHT SECTION
   ============================================================ */
function renderFlightSection(container){
    addBot("Great! Please configure your flight details:");
    const typeContainer = document.createElement('div');
    typeContainer.className = 'flightTypeContainer';
    ['none','one_way','return'].forEach(mode=>{
        const b=document.createElement('button');
        b.className='flightTypeBtn'+(flightState.mode===mode?' active':'');
        b.textContent = mode==='none'?'No Flight':mode==='one_way'?'One Way':'Return';
        b.onclick=()=>{
            flightState.mode=mode;
            typeContainer.querySelectorAll('.flightTypeBtn').forEach(x=>x.classList.remove('active'));
            b.classList.add('active');
            const form=document.getElementById('flightFormSection');
            if(form) form.remove();
            const detailCard=document.getElementById('flightDetailCardSection');
            if(detailCard) detailCard.remove();
            if(mode!=='none') renderFlightForm(container, mode);
        };
        typeContainer.appendChild(b);
    });
    container.appendChild(typeContainer);
    if(flightState.mode!=='none') renderFlightForm(container, flightState.mode);
    if(flightState.selectedOffer) renderFlightSelectedBadge(container);
    const skipBtn=document.createElement('button');
    skipBtn.className='optionButton';
    skipBtn.style.cssText='margin-top:1rem;width:100%';
    skipBtn.textContent=flightState.selectedOffer?'Continue with Selected Flight ‚Üí':'Skip Flight & Continue ‚Üí';
    skipBtn.onclick=()=>{
        autoAdvance(flightState.selectedOffer?`Flight: ${flightState.selectedOffer.airline} - ${formatCurrency(flightState.selectedOffer.price)}`:'No flight selected');
    };
    container.appendChild(skipBtn);
}

function renderFlightForm(container, mode){
    const form=document.createElement('div');
    form.className='flightSearchForm';
    form.id='flightFormSection';
    const grid=document.createElement('div');
    grid.className='flightSearchGrid';
    const fields=[
        {label:'From (IATA)',id:'fOrigin',placeholder:'DEL',val:flightState.origin},
        {label:'To (IATA)',id:'fDestination',placeholder:'BOM',val:flightState.destination},
        {label:'Departure Date',id:'fDepartureDate',type:'date',val:flightState.departureDate},
    ];
    if(mode==='return') fields.push({label:'Return Date',id:'fReturnDate',type:'date',val:flightState.returnDate});
    fields.forEach(({label,id,placeholder,type,val})=>{
        const grp=document.createElement('div');grp.className='flightFormGroup';
        const lbl=document.createElement('label');lbl.textContent=label;
        const inp=document.createElement('input');
        inp.className='flightInput';inp.id=id;inp.type=type||'text';
        if(placeholder)inp.placeholder=placeholder;
        if(val)inp.value=val;
        if(id==='fOrigin'||id==='fDestination') inp.style.textTransform='uppercase';
        inp.oninput=()=>{
            if(id==='fOrigin')flightState.origin=inp.value.toUpperCase();
            else if(id==='fDestination')flightState.destination=inp.value.toUpperCase();
            else if(id==='fDepartureDate')flightState.departureDate=inp.value;
            else if(id==='fReturnDate')flightState.returnDate=inp.value;
        };
        grp.append(lbl,inp);
        grid.appendChild(grp);
    });
    form.appendChild(grid);
    const searchBtn=document.createElement('button');
    searchBtn.className='flightSearchBtn';
    searchBtn.textContent='üîç Search Flights';
    searchBtn.onclick=()=>doFlightSearch(form, mode);
    form.appendChild(searchBtn);
    const resultsArea=document.createElement('div');
    resultsArea.id='flightResultsArea';
    form.appendChild(resultsArea);
    container.appendChild(form);
}

async function doFlightSearch(formEl, mode){
    const origin=(document.getElementById('fOrigin')?.value||'').trim().toUpperCase();
    const destination=(document.getElementById('fDestination')?.value||'').trim().toUpperCase();
    const departureDate=document.getElementById('fDepartureDate')?.value||'';
    const returnDate=document.getElementById('fReturnDate')?.value||'';
    if(!origin||origin.length<2){addBot("Please enter a valid departure IATA code.");return;}
    if(!destination||destination.length<2){addBot("Please enter a valid arrival IATA code.");return;}
    if(!departureDate){addBot("Please enter a departure date.");return;}
    if(mode==='return'&&!returnDate){addBot("Please enter a return date for round-trip.");return;}
    const resultsArea=document.getElementById('flightResultsArea');
    if(!resultsArea)return;
    resultsArea.innerHTML='<div class="flightSearching">Searching flights‚Ä¶ ‚úàÔ∏è</div>';
    const searchBtn=formEl.querySelector('.flightSearchBtn');
    if(searchBtn)searchBtn.disabled=true;
    try{
        const payload={
            origin,destination,departureDate,adults:selectedAdults,children:selectedChildren,trip_type:mode
        };
        if(mode==='return') payload.returnDate=returnDate;
        const resp=await fetch(`${API_BASE}/api/flight-search`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const data=await resp.json();
        if(data.error&&!data.offers?.length){
            resultsArea.innerHTML=`<div class="flightNoResults">‚ö†Ô∏è ${data.error}<br><small>${data.detail||''}</small></div>`;
            return;
        }
        const offers=data.offers||[];
        if(!offers.length){
            resultsArea.innerHTML='<div class="flightNoResults">No flights found for these dates. Try different options.</div>';
            return;
        }
        resultsArea.innerHTML='';
        const resultsContainer=document.createElement('div');
        resultsContainer.className='flightResultsContainer';
        offers.forEach(offer=>{
            const card=document.createElement('div');
            card.className='flightResultCard'+(flightState.selectedOffer?.id===offer.id?' selected':'');
            const header=document.createElement('div');header.className='flightCardHeader';
            const carrier=document.createElement('span');carrier.className='flightCarrier';carrier.textContent=offer.airline;
            const price=document.createElement('span');price.className='flightPrice';price.textContent=formatCurrency(offer.price)+' /person';
            header.append(carrier,price);
            const route=document.createElement('div');route.className='flightRoute';
            route.textContent=`${offer.origin} ‚Üí ${offer.destination}`;
            if(offer.returnDeparture) route.textContent+=` | Return: ${offer.destination} ‚Üí ${offer.origin}`;
            const meta=document.createElement('div');meta.className='flightMeta';
            meta.innerHTML=`<span>‚úà ${offer.flightNumber}</span><span>‚è± ${offer.duration}</span><span>üõë ${offer.stops===0?'Non-stop':offer.stops+' stop'+(offer.stops!==1?'s':'')}</span><span>üí∫ ${offer.cabinClass||'Economy'}</span>`;
            card.append(header,route,meta);
            card.onclick=()=>{
                resultsContainer.querySelectorAll('.flightResultCard').forEach(c=>c.classList.remove('selected'));
                card.classList.add('selected');
                flightState.selectedOffer=offer;
                flightState.detailData=null;
                updateSummary();
                // Fetch and render flight details
                fetchAndRenderFlightDetail(offer, mode, resultsArea.parentElement);
            };
            resultsContainer.appendChild(card);
        });
        resultsArea.appendChild(resultsContainer);
    }catch(e){
        console.error('Flight search error:',e);
        resultsArea.innerHTML='<div class="flightNoResults">Flight search temporarily unavailable. Please try again.</div>';
    }finally{
        if(searchBtn)searchBtn.disabled=false;
    }
}

/* ============================================================
   FLIGHT DETAILS ‚Äî FETCH + RENDER (NEW)
   ============================================================ */
async function fetchAndRenderFlightDetail(offer, mode, containerEl){
    if(!containerEl) return;

    // Remove any existing detail card
    const existingDetail = document.getElementById('flightDetailCardSection');
    if(existingDetail) existingDetail.remove();

    const detailWrapper = document.createElement('div');
    detailWrapper.id = 'flightDetailCardSection';
    detailWrapper.innerHTML = '<div class="flightSearching" style="margin-top:0.75rem">Loading flight details‚Ä¶ ‚úàÔ∏è</div>';
    containerEl.appendChild(detailWrapper);

    try{
        const payload = {
            offer_id: offer.id,
            origin: offer.origin || (document.getElementById('fOrigin')?.value||'').toUpperCase(),
            destination: offer.destination || (document.getElementById('fDestination')?.value||'').toUpperCase(),
            departureDate: offer.departure ? offer.departure.split('T')[0] : (document.getElementById('fDepartureDate')?.value||''),
            returnDate: (mode==='return') ? (document.getElementById('fReturnDate')?.value||'') : '',
            adults: selectedAdults,
            children: selectedChildren,
            tripType: mode,
        };

        const resp = await fetch(`${API_BASE}/api/flight-details`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await resp.json();

        if(data.error){
            detailWrapper.innerHTML = `<div class="flightNoResults" style="margin-top:0.75rem">‚ö†Ô∏è ${data.error}</div>`;
            return;
        }

        flightState.detailData = data;
        renderFlightDetailCard(detailWrapper, data, offer);

    }catch(e){
        console.error('Flight details error:', e);
        detailWrapper.innerHTML = '<div class="flightNoResults" style="margin-top:0.75rem">Could not load flight details.</div>';
    }
}

function renderFlightDetailCard(container, detail, offer){
    if(!container || !detail) return;
    container.innerHTML = '';

    const card = document.createElement('div');
    card.className = 'flightDetailCard';

    // Header with toggle
    const header = document.createElement('div');
    header.className = 'fd-header';
    const title = document.createElement('div');
    title.className = 'fd-title';
    title.innerHTML = `‚úà ${detail.airline || offer.airline} ¬∑ ${detail.flight_number || offer.flightNumber}`;
    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'fd-toggle';
    toggleBtn.textContent = 'Show Details ‚ñº';
    let isOpen = false;
    const body = document.createElement('div');
    body.className = 'fd-body';
    toggleBtn.onclick = () => {
        isOpen = !isOpen;
        body.classList.toggle('open', isOpen);
        toggleBtn.textContent = isOpen ? 'Hide Details ‚ñ≤' : 'Show Details ‚ñº';
    };
    header.append(title, toggleBtn);
    card.appendChild(header);

    // Body (expandable)
    // Route visualization
    const routeViz = document.createElement('div');
    routeViz.className = 'flightDetailRouteViz';

    const depAirport = document.createElement('div');
    depAirport.className = 'fdrv-airport';
    depAirport.innerHTML = `<div class="fdrv-code">${detail.departure_airport||'‚Äî'}</div><div class="fdrv-time">${formatDateTime(detail.departure_time)}</div>${detail.departure_terminal?`<div style="font-size:0.65rem;color:rgba(255,255,255,0.4)">Terminal ${detail.departure_terminal}</div>`:''}`;

    const routeLine = document.createElement('div');
    routeLine.className = 'fdrv-line';
    const stopsText = detail.stops===0 ? 'Non-stop' : `${detail.stops} stop${detail.stops!==1?'s':''}`;
    routeLine.innerHTML = `<div class="fdrv-arrow">‚úà</div><div class="fdrv-duration">${detail.duration||''}</div><div class="fdrv-stops">${stopsText}</div>`;

    const arrAirport = document.createElement('div');
    arrAirport.className = 'fdrv-airport';
    arrAirport.innerHTML = `<div class="fdrv-code">${detail.arrival_airport||'‚Äî'}</div><div class="fdrv-time">${formatDateTime(detail.arrival_time)}</div>${detail.arrival_terminal?`<div style="font-size:0.65rem;color:rgba(255,255,255,0.4)">Terminal ${detail.arrival_terminal}</div>`:''}`;

    routeViz.append(depAirport, routeLine, arrAirport);
    body.appendChild(routeViz);

    // Detail grid
    const grid = document.createElement('div');
    grid.className = 'flightDetailGrid';
    const gridItems = [
        {label:'Airline', val: detail.airline||'‚Äî'},
        {label:'Flight No.', val: detail.flight_number||'‚Äî'},
        {label:'Cabin Class', val: detail.cabin_class||'Economy'},
        {label:'Fare Basis', val: detail.fare_basis||'‚Äî'},
    ];
    gridItems.forEach(({label,val})=>{
        const item = document.createElement('div');
        item.className = 'flightDetailItem';
        item.innerHTML = `<span class="fdi-label">${label}</span><span class="fdi-value">${val}</span>`;
        grid.appendChild(item);
    });
    body.appendChild(grid);

    // Baggage
    const bag = detail.baggage_allowance;
    if(bag && (bag.quantity || bag.weight)){
        const bagEl = document.createElement('div');
        bagEl.className = 'flightBaggageInfo';
        const bagText = bag.quantity ? `${bag.quantity} bag${bag.quantity!==1?'s':''}` : '';
        const weightText = bag.weight ? ` ¬∑ ${bag.weight}${bag.weightUnit||'KG'}` : '';
        bagEl.textContent = `üß≥ Checked Baggage: ${bagText}${weightText}`;
        body.appendChild(bagEl);
    }

    // Return leg (if present)
    if(detail.return_leg){
        const rl = detail.return_leg;
        const returnEl = document.createElement('div');
        returnEl.className = 'flightReturnLeg';
        returnEl.innerHTML = `<div class="frl-title">‚Ü© Return Leg</div>
            <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;justify-content:space-between">
                <div style="text-align:center"><div style="font-weight:800;font-size:1.1rem">${rl.departureAirport||'‚Äî'}</div><div style="font-size:0.72rem;color:rgba(255,255,255,0.55)">${formatDateTime(rl.departureTime)}</div></div>
                <div style="text-align:center;font-size:0.75rem;color:rgba(255,255,255,0.5)">‚Üí ${rl.duration||''} ¬∑ ${rl.stops===0?'Non-stop':rl.stops+' stop'+(rl.stops!==1?'s':'')}</div>
                <div style="text-align:center"><div style="font-weight:800;font-size:1.1rem">${rl.arrivalAirport||'‚Äî'}</div><div style="font-size:0.72rem;color:rgba(255,255,255,0.55)">${formatDateTime(rl.arrivalTime)}</div></div>
            </div>`;
        body.appendChild(returnEl);
    }

    // Pricing breakdown
    const pb = detail.pricing_breakdown;
    if(pb){
        const pbEl = document.createElement('div');
        pbEl.className = 'flightPricingBreakdown';
        const pbTitle = document.createElement('div');
        pbTitle.className = 'fpb-title';
        pbTitle.textContent = 'Pricing Breakdown';
        pbEl.appendChild(pbTitle);

        const rows = [];
        if(pb.baseFare) rows.push({label:`Base Fare (${pb.adults||selectedAdults} adult${(pb.adults||selectedAdults)!==1?'s':''})`, val: formatCurrency(pb.baseFare)});
        if(pb.taxes) rows.push({label:'Taxes & Fees', val: formatCurrency(pb.taxes)});
        rows.push({label:'Total', val: formatCurrency(pb.grandTotal)});

        rows.forEach(({label,val},idx)=>{
            const row = document.createElement('div');
            row.className = 'flightPricingRow';
            row.innerHTML = `<span class="fpr-label">${label}</span><span class="fpr-value">${val}</span>`;
            pbEl.appendChild(row);
        });

        // Per-traveler breakdown
        if(pb.perTraveler && pb.perTraveler.length){
            const ptTitle = document.createElement('div');
            ptTitle.style.cssText='font-size:0.7rem;color:rgba(255,255,255,0.4);margin-top:0.5rem;margin-bottom:0.25rem;text-transform:uppercase;letter-spacing:0.05em';
            ptTitle.textContent='Per Traveler';
            pbEl.appendChild(ptTitle);
            pb.perTraveler.forEach(pt=>{
                const ptRow = document.createElement('div');
                ptRow.className = 'flightPricingRow';
                ptRow.innerHTML = `<span class="fpr-label">${pt.travelerType} √ó${pt.quantity||1}</span><span class="fpr-value">${formatCurrency(pt.total)}</span>`;
                pbEl.appendChild(ptRow);
            });
        }

        body.appendChild(pbEl);
    }

    card.appendChild(body);
    container.appendChild(card);
}

function renderFlightSelectedBadge(container){
    const existing=container.querySelector('.flightSelectedBadge');
    if(existing)existing.remove();
    if(!flightState.selectedOffer)return;
    const badge=document.createElement('div');
    badge.className='flightSelectedBadge';
    badge.innerHTML=`‚úà ${flightState.selectedOffer.airline} ${flightState.selectedOffer.origin}‚Üí${flightState.selectedOffer.destination} ${formatCurrency(flightState.selectedOffer.price)}/person`;
    container.appendChild(badge);
}

/* ============================================================
   CAB STEP
   ============================================================ */
function renderCab(){
    addBot("Select a cab for local sightseeing transfers:");
    const filtered = getFilteredCabs();
    if(!filtered.length){addBot("No cabs available. Skipping cab selection.");currentStep=STEPS.ADDONS;setTimeout(()=>renderStep(),500);return;}
    filtered.forEach(c=>{
        const b=document.createElement('button');
        b.className='optionButton'+(selectedCab===c.internal_name?' active':'');
        b.innerText=c.display_name||c.name;
        b.onclick=()=>{selectedCab=c.internal_name;autoAdvance(c.display_name||c.name);};
        optionsContainer.appendChild(b);
    });
    const skipBtn=document.createElement('button');
    skipBtn.className='optionButton';
    skipBtn.style.marginTop='0.5rem';
    skipBtn.textContent='No Cab Needed';
    skipBtn.onclick=()=>{selectedCab='';autoAdvance('No cab');};
    optionsContainer.appendChild(skipBtn);
}

/* ============================================================
   ADDONS STEP
   ============================================================ */
function renderAddons(){
    addBot("Any add-ons for your trip? (Select all that apply)");
    const filtered = getFilteredAddons();
    if(!filtered.length){
        addBot("No add-ons available for this region. Proceeding to price calculation...");
        setTimeout(()=>submitData(),500);
        return;
    }
    const container = document.createElement('div');
    container.className = 'addonsContainer';
    filtered.forEach(a=>{
        const btn=document.createElement('button');
        btn.className='addonOption'+(selectedAddons.includes(a.internal_name)?' selected':'');
        btn.textContent=a.name;
        btn.onclick=()=>{
            const idx=selectedAddons.indexOf(a.internal_name);
            if(idx>=0){selectedAddons.splice(idx,1);btn.classList.remove('selected');}
            else{selectedAddons.push(a.internal_name);btn.classList.add('selected');}
            updateSummary();
        };
        container.appendChild(btn);
    });
    optionsContainer.appendChild(container);
    const confirmBtn=document.createElement('button');
    confirmBtn.className='optionButton';
    confirmBtn.style.cssText='margin-top:1.5rem;width:100%;padding:1rem;font-weight:700;font-size:1rem';
    confirmBtn.textContent='Get My Price Quote ‚Üí';
    confirmBtn.onclick=()=>{
        const selected=selectedAddons.map(k=>{const a=allAddons.find(x=>x.internal_name===k);return a?a.name:k;});
        addUser(selected.length?`Add-ons: ${selected.join(', ')}`:'No add-ons selected');
        submitData();
    };
    optionsContainer.appendChild(confirmBtn);
}

/* ============================================================
   LIVE HOTEL MODAL FUNCTIONS
   ============================================================ */
function openLiveHotelModal(){
    const modal = document.getElementById('liveHotelModal');
    modal.classList.add('open');

    // Restore search mode UI
    setLiveSearchMode(liveHotelState.searchMode || 'city');

    const cityInput = document.getElementById('lhCityCode');
    if(cityInput && liveHotelState.cityCode) cityInput.value = liveHotelState.cityCode;

    // Amadeus rejects same-day check-in ‚Äî minimum is always tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];

    // Amadeus rejects same-day check-in ‚Äî enforce minimum = tomorrow
    const _tomorrow = new Date();
    _tomorrow.setDate(_tomorrow.getDate() + 1);
    const _tomorrowStr = _tomorrow.toISOString().split('T')[0];

    const checkInInput = document.getElementById('lhCheckIn');
    if(checkInInput){
        checkInInput.min = _tomorrowStr;
        const savedCI = liveHotelState.checkInDate;
        checkInInput.value = (savedCI && savedCI >= _tomorrowStr) ? savedCI : _tomorrowStr;
    }
    const checkInInput2 = document.getElementById('lhCheckIn2');
    if(checkInInput2){
        checkInInput2.min = _tomorrowStr;
        checkInInput2.value = checkInInput ? checkInInput.value : _tomorrowStr;
    }

    const checkOutInput = document.getElementById('lhCheckOut');
    if(checkOutInput){
        const savedCO = liveHotelState.checkOutDate;
        const ciVal = checkInInput ? checkInInput.value : _tomorrowStr;
        if(savedCO && savedCO > ciVal){
            checkOutInput.value = savedCO;
        } else {
            const _co = new Date(ciVal);
            _co.setDate(_co.getDate() + (selectedNights > 0 ? selectedNights : 1));
            checkOutInput.value = _co.toISOString().split('T')[0];
        }
        checkOutInput.min = ciVal;
    }
    const checkOutInput2 = document.getElementById('lhCheckOut2');
    if(checkOutInput2){
        checkOutInput2.min = _tomorrowStr;
        checkOutInput2.value = checkOutInput ? checkOutInput.value : '';
    }

    // Restore hotel name input
    const hotelNameInput = document.getElementById('lhHotelNameInput');
    if(hotelNameInput && liveHotelState.hotelNameQuery) hotelNameInput.value = liveHotelState.hotelNameQuery;
    if(liveHotelState.hotelNameSelected){
        renderHotelNameSelectedPill(liveHotelState.hotelNameSelected);
    }

    const rooms = selectedRooms > 0 ? selectedRooms : Math.ceil((selectedAdults + selectedChildren) / 2);
    const infoNote = document.getElementById('lhInfoNote');
    if(infoNote){
        infoNote.textContent = `Travelers: ${selectedAdults} adult${selectedAdults!==1?'s':''}${selectedChildren>0?`, ${selectedChildren} child${selectedChildren!==1?'ren':''}`:''} ¬∑ Rooms: ${rooms}. (Adjust rooms in Step 5 if needed.)`;
    }
    updateLiveHotelNightsNote();
    const confirmBtn = document.getElementById('lhConfirmBtn');
    if(confirmBtn) confirmBtn.disabled = !liveHotelState.selectedOffer;
    if(liveHotelState.searchResults.length > 0){
        renderLiveHotelResults(liveHotelState.searchResults);
    } else {
        const resultsArea = document.getElementById('lhResultsArea');
        if(resultsArea) resultsArea.innerHTML = '';
    }
}

function cancelLiveHotelModal(){
    const modal = document.getElementById('liveHotelModal');
    modal.classList.remove('open');
    hideHotelNameAutocomplete();
    if(!liveHotelState.selectedOffer){
        hotelSource = 'admin';
        resetLiveHotelState();
        updateSummary();
        const sourceBtns = document.querySelectorAll('.hotelSourceBtn');
        sourceBtns.forEach(btn=>{
            if(btn.textContent.includes('Our Hotels')) btn.classList.add('active');
            else btn.classList.remove('active');
        });
        const adminContainer = document.getElementById('adminHotelSelectContainer');
        if(adminContainer) adminContainer.style.display = 'block';
        const badgeArea = document.getElementById('liveHotelBadgeArea');
        if(badgeArea) renderLiveHotelBadge(badgeArea);
    }
}

function onLiveHotelCheckInChange(){
    const checkIn = document.getElementById('lhCheckIn');
    const checkOut = document.getElementById('lhCheckOut');
    if(!checkIn || !checkOut) return;
    liveHotelState.checkInDate = checkIn.value;
    if(checkIn.value && selectedNights > 0){
        const ci = new Date(checkIn.value);
        ci.setDate(ci.getDate() + selectedNights);
        checkOut.value = ci.toISOString().split('T')[0];
        liveHotelState.checkOutDate = checkOut.value;
    }
    updateLiveHotelNightsNote();
}

function onLiveHotelCheckOutChange(){
    const checkIn = document.getElementById('lhCheckIn');
    const checkOut = document.getElementById('lhCheckOut');
    if(!checkIn || !checkOut) return;
    liveHotelState.checkOutDate = checkOut.value;
    if(checkIn.value && checkOut.value){
        const ci = new Date(checkIn.value);
        const co = new Date(checkOut.value);
        const diffDays = Math.round((co - ci) / (1000 * 60 * 60 * 24));
        if(diffDays > 0){
            liveHotelState.nights = diffDays;
            if(diffDays !== selectedNights) selectedNights = diffDays;
        }
    }
    updateLiveHotelNightsNote();
}

function updateLiveHotelNightsNote(){
    const checkIn = document.getElementById('lhCheckIn');
    const checkOut = document.getElementById('lhCheckOut');
    const note = document.getElementById('lhNightsNote');
    if(!note) return;
    if(checkIn && checkIn.value && checkOut && checkOut.value){
        const ci = new Date(checkIn.value);
        const co = new Date(checkOut.value);
        const diffDays = Math.round((co - ci) / (1000 * 60 * 60 * 24));
        if(diffDays > 0){
            note.textContent = `${diffDays} night${diffDays!==1?'s':''} stay`;
        } else if(diffDays <= 0){
            note.textContent = '‚ö†Ô∏è Check-out must be after check-in';
        } else {
            note.textContent = '';
        }
    } else {
        note.textContent = selectedNights > 0 ? `Based on ${selectedNights} nights from your trip settings` : '';
    }
}

// Point 5 (v4.0): Star rating filter toggle
function toggleStarFilter(btn, stars) {
    const allBtns = document.querySelectorAll('.star-filter-btn');
    allBtns.forEach(b => {
        b.classList.remove('star-active');
        b.style.background = 'rgba(255,255,255,0.1)';
        b.style.borderColor = 'rgba(255,255,255,0.25)';
        b.style.color = 'rgba(255,255,255,0.8)';
    });
    if(stars > 0){
        btn.classList.add('star-active');
        btn.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
        btn.style.borderColor = '#667eea';
        btn.style.color = '#fff';
    }
    // Auto re-search if results are already showing
    const resultsArea = document.getElementById('lhResultsArea');
    if(resultsArea && resultsArea.children.length > 0){
        doLiveHotelSearch();
    }
}

async function doLiveHotelSearch(){
    const mode = liveHotelState.searchMode || 'city';

    // Gather dates ‚Äî name mode reads from secondary fields (lhCheckIn2/lhCheckOut2)
    let checkIn = (document.getElementById('lhCheckIn')?.value || '').trim();
    let checkOut = (document.getElementById('lhCheckOut')?.value || '').trim();
    if(mode === 'name'){
        const ci2 = document.getElementById('lhCheckIn2')?.value;
        const co2 = document.getElementById('lhCheckOut2')?.value;
        if(ci2) checkIn = ci2;
        if(co2) checkOut = co2;
    }

    const cityCodeRaw = (document.getElementById('lhCityCode')?.value || '').trim().toUpperCase();

    // Validate per mode
    if(mode === 'city'){
        if(!cityCodeRaw || cityCodeRaw.length < 2){addBotInModal('Please enter a valid city IATA code (e.g. DXB, SIN, BKK).');return;}
    }
    if(mode === 'both'){
        if(!cityCodeRaw || cityCodeRaw.length < 2){addBotInModal('Please enter a valid city IATA code.');return;}
        if(!liveHotelState.hotelNameSelected){addBotInModal('Please type and select a hotel name first.');return;}
    }
    if(mode === 'name'){
        if(!liveHotelState.hotelNameSelected){
            addBotInModal('Please type and select a hotel name from the dropdown first.');return;
        }
    }

    if(!checkIn){addBotInModal('Please select a check-in date.');return;}
    if(!checkOut){addBotInModal('Please select a check-out date.');return;}
    if(checkOut <= checkIn){addBotInModal('Check-out date must be after check-in date.');return;}

    const nightsDiff = Math.round((new Date(checkOut) - new Date(checkIn)) / 86400000);
    if(nightsDiff <= 0){addBotInModal('Invalid date range. Please check your dates.');return;}

    // cityCode: explicit input wins; fall back to hotel iataCode; blank is OK when hotelId is present
    const cityCode = cityCodeRaw || (liveHotelState.hotelNameSelected?.iataCode || '');
    liveHotelState.cityCode = cityCode;
    liveHotelState.checkInDate = checkIn;
    liveHotelState.checkOutDate = checkOut;
    liveHotelState.nights = nightsDiff;
    // Sync global nights so submitData() always uses the dates chosen in the modal
    selectedNights = nightsDiff;

    // Reset any prior selection ‚Äî a fresh search always requires explicit re-selection
    liveHotelState.selectedOffer = null;
    const _confirmBtn = document.getElementById('lhConfirmBtn');
    if(_confirmBtn) _confirmBtn.disabled = true;

    const rooms = selectedRooms > 0 ? selectedRooms : Math.ceil((selectedAdults + selectedChildren) / 2);
    const resultsArea = document.getElementById('lhResultsArea');
    if(resultsArea) resultsArea.innerHTML = '<div class="liveHotelSearching">Searching live hotels‚Ä¶ üè®</div>';
    const searchBtn = document.getElementById('lhSearchBtn');
    if(searchBtn) searchBtn.disabled = true;

    // Abort controller so the button never stays permanently stuck
    const _searchAbort = new AbortController();
    const _searchTimer = setTimeout(() => _searchAbort.abort(), 45000);

    try{
        const payload = {
            cityCode: cityCode || 'XXX',  // backend ignores cityCode when hotelId present
            checkInDate: checkIn,
            checkOutDate: checkOut,
            adults: selectedAdults,
            roomQuantity: rooms
        };

        // Name / both mode: send specific hotelId so backend searches ONLY that hotel.
        // Also send iataCode so backend can fall back to city-wide search if needed.
        // Also send hotelName so backend can name-match within city fallback results,
        // collapsing 20 generic results into 1 exact match ‚Üí auto-select fires.
        if((mode === 'name' || mode === 'both') && liveHotelState.hotelNameSelected?.hotelId){
            payload.hotelId  = liveHotelState.hotelNameSelected.hotelId;
        }
        if((mode === 'name' || mode === 'both') && liveHotelState.hotelNameSelected?.iataCode){
            payload.iataCode = liveHotelState.hotelNameSelected.iataCode;
        }
        if((mode === 'name' || mode === 'both') && liveHotelState.hotelNameSelected?.hotel_name){
            payload.hotelName = liveHotelState.hotelNameSelected.hotel_name;
        }

        // Star rating filter
        const activeStarBtn = document.querySelector('.star-filter-btn.star-active');
        const selectedStars = activeStarBtn ? parseInt(activeStarBtn.dataset.stars) : 0;
        if(selectedStars > 0) payload.starRatings = [selectedStars];

        const resp = await fetch(`${API_BASE}/api/hotel-search`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            signal: _searchAbort.signal,
            body: JSON.stringify(payload)
        });
        clearTimeout(_searchTimer);

        const data = await resp.json();
        liveHotelState.searchResults = data.hotels || [];

        if(!liveHotelState.searchResults.length){
            const msg = data.message || 'No live hotels found. Try different dates or city code.';
            if(resultsArea) resultsArea.innerHTML = `<div class="liveHotelNoResults">üîç ${msg}</div>`;
            return;
        }

        // Show amber notice if backend fell back from the specific hotel to city-wide results
        if(data.fallbackMessage && resultsArea){
            const notice = document.createElement('div');
            notice.style.cssText = 'padding:0.6rem 1rem;background:rgba(255,193,7,0.12);border:1px solid rgba(255,193,7,0.3);border-radius:8px;font-size:0.8rem;color:rgba(255,220,100,0.9);margin-bottom:0.75rem';
            notice.textContent = '‚ö†Ô∏è ' + data.fallbackMessage;
            resultsArea.innerHTML = '';
            resultsArea.appendChild(notice);
        }

        renderLiveHotelResults(liveHotelState.searchResults);

    }catch(e){
        clearTimeout(_searchTimer);
        console.error('Live hotel search error:', e);
        const msg = e.name === 'AbortError'
            ? 'Hotel search timed out. Please try again.'
            : 'Hotel search temporarily unavailable. Please try again.';
        if(resultsArea) resultsArea.innerHTML = `<div class="liveHotelNoResults">${msg}</div>`;
    }finally{
        if(searchBtn) searchBtn.disabled = false;
    }
}


function addBotInModal(msg){
    const resultsArea = document.getElementById('lhResultsArea');
    if(!resultsArea) return;
    const errDiv = document.createElement('div');
    errDiv.style.cssText = 'padding:0.75rem 1rem;background:rgba(231,76,60,0.15);border:1px solid rgba(231,76,60,0.3);border-radius:8px;font-size:0.875rem;color:rgba(255,150,150,0.9);margin-bottom:0.75rem';
    errDiv.textContent = msg;
    resultsArea.insertBefore(errDiv, resultsArea.firstChild);
    setTimeout(()=>errDiv.remove(), 4000);
}

function selectLiveHotelCard(idx){
    const hotels = liveHotelState.searchResults;
    if(!hotels || idx < 0 || idx >= hotels.length) return;
    const hotel = hotels[idx];

    // Highlight selected card, deselect others√ü
    document.querySelectorAll('.liveHotelCard').forEach((c, i)=>{
        c.classList.toggle('selected', i === idx);
    });

    liveHotelState.selectedOffer = hotel;

    const confirmBtn = document.getElementById('lhConfirmBtn');
    if(confirmBtn) confirmBtn.disabled = false;
}

function renderLiveHotelResults(hotels){
    const resultsArea = document.getElementById('lhResultsArea');
    if(!resultsArea) return;

    // Clean up any old delegation listener
    if(resultsArea._hotelClickHandler){
        resultsArea.removeEventListener('click', resultsArea._hotelClickHandler);
        resultsArea._hotelClickHandler = null;
    }

    resultsArea.innerHTML = '';

    if(!hotels || !hotels.length){
        resultsArea.innerHTML = '<div class="liveHotelNoResults">No hotels found for these dates.</div>';
        return;
    }

    const resultsContainer = document.createElement('div');
    resultsContainer.className = 'liveHotelResults';

    hotels.forEach((hotel, idx)=>{
        const card = document.createElement('div');
        const isSelected = liveHotelState.selectedOffer && liveHotelState.selectedOffer.id === hotel.id;
        card.className = 'liveHotelCard' + (isSelected ? ' selected' : '');

        // Inline onclick ‚Äî most reliable across all Safari versions and layouts
        card.setAttribute('onclick', `selectLiveHotelCard(${idx})`);

        const header = document.createElement('div');
        header.className = 'liveHotelCardHeader';
        const nameEl = document.createElement('div');
        nameEl.className = 'liveHotelName';
        nameEl.textContent = hotel.hotelName || 'Hotel';
        const priceEl = document.createElement('div');
        priceEl.className = 'liveHotelTotalPrice';
        priceEl.textContent = formatCurrency(hotel.totalPrice);
        header.append(nameEl, priceEl);

        const meta = document.createElement('div');
        meta.className = 'liveHotelMeta';
        const roomTypePill = document.createElement('span');
        roomTypePill.textContent = 'üõè ' + (hotel.roomType || 'Standard');
        const boardPill = document.createElement('span');
        boardPill.textContent = 'üçΩ ' + (hotel.boardType || 'Room Only');
        const cancelPill = document.createElement('span');
        cancelPill.textContent = 'üìã ' + (hotel.cancellationPolicy || 'Check policy');
        meta.append(roomTypePill, boardPill, cancelPill);

        const perNight = document.createElement('div');
        perNight.className = 'liveHotelPerNight';
        const nights = liveHotelState.nights || selectedNights || 1;
        const perNightCalc = nights > 0 ? Math.round(hotel.totalPrice / nights) : hotel.totalPrice;
        perNight.textContent = `‚âà ${formatCurrency(perNightCalc)}/night (display only) ¬∑ ${nights} night${nights!==1?'s':''}`;

        if(hotel.originalCurrency && hotel.originalCurrency !== 'INR'){
            const fxNote = document.createElement('div');
            fxNote.style.cssText = 'font-size:0.7rem;color:rgba(255,255,255,0.3);margin-top:0.2rem';
            fxNote.textContent = `Originally ${hotel.originalCurrency} ${(hotel.originalPrice||0).toLocaleString()}`;
            card.append(fxNote);
        }
        card.append(header, meta, perNight);
        resultsContainer.appendChild(card);
    });

    resultsArea.appendChild(resultsContainer);

    // If exactly one result came back (common in name/both mode where a specific
    // hotel was requested), auto-select it so the confirm button enables immediately.
    if(hotels.length === 1){
        selectLiveHotelCard(0);
    }
}

function confirmLiveHotelSelection(){
    if(!liveHotelState.selectedOffer){addBotInModal('Please select a hotel first.');return;}
    hotelSource = 'live';
    const modal = document.getElementById('liveHotelModal');
    modal.classList.remove('open');
    hideHotelNameAutocomplete();
    const badgeArea = document.getElementById('liveHotelBadgeArea');
    if(badgeArea) renderLiveHotelBadge(badgeArea);
    const adminContainer = document.getElementById('adminHotelSelectContainer');
    if(adminContainer) adminContainer.style.display = 'none';
    updateSummary();
    addBot(`‚úÖ Live hotel selected: ${liveHotelState.selectedOffer.hotelName} ‚Äî ${formatCurrency(liveHotelState.selectedOffer.totalPrice)} total`);
}

function renderLiveHotelBadge(container){
    if(!container) return;
    container.innerHTML = '';
    if(hotelSource !== 'live' || !liveHotelState.selectedOffer) return;
    const offer = liveHotelState.selectedOffer;
    const badge = document.createElement('div');
    badge.className = 'liveHotelSelectedBadge';
    const nameDiv = document.createElement('div');
    nameDiv.className = 'badge-name';
    nameDiv.textContent = offer.hotelName;
    const metaDiv = document.createElement('div');
    metaDiv.className = 'badge-meta';
    metaDiv.textContent = `${offer.roomType||'Standard'} ¬∑ ${offer.boardType||'Room Only'} ¬∑ ${liveHotelState.nights||selectedNights} nights`;
    const priceDiv = document.createElement('div');
    priceDiv.className = 'badge-price';
    priceDiv.textContent = `${formatCurrency(offer.totalPrice)} total (INR)`;
    const btns = document.createElement('div');
    btns.className = 'liveHotelChangeBtns';
    const changeBtn = document.createElement('button');
    changeBtn.className = 'liveHotelChangeBtn';
    changeBtn.textContent = 'üîÑ Change Hotel';
    changeBtn.onclick = (e)=>{e.stopPropagation();openLiveHotelModal();};
    const removeBtn = document.createElement('button');
    removeBtn.className = 'liveHotelChangeBtn remove';
    removeBtn.textContent = '‚úï Remove';
    removeBtn.onclick = (e)=>{
        e.stopPropagation();
        resetLiveHotelState();
        hotelSource = 'admin';
        container.innerHTML = '';
        const adminContainer = document.getElementById('adminHotelSelectContainer');
        if(adminContainer) adminContainer.style.display = 'block';
        updateSummary();
    };
    btns.append(changeBtn, removeBtn);
    badge.append(nameDiv, metaDiv, priceDiv, btns);
    container.appendChild(badge);
}

/* ============================================================
   SUMMARY UPDATE
   ============================================================ */
function updateSummary(){
    const sidebar = document.querySelector('#sidebar .summary');
    if(!sidebar) return;
    let html = '';
    if(selectedDestination){html+=`<b>üìç Destination:</b> ${selectedDestination}<br>`;}
    if(selectedSeason){html+=`<b>üå§ Season:</b> ${selectedSeason==='ON'?'Peak Season':'Off Season'}<br>`;}
    if(selectedAdults){
        let trav=`<b>üë• Travelers:</b> ${selectedAdults} adult${selectedAdults!==1?'s':''}`;
        if(selectedChildren>0) trav+=`, ${selectedChildren} child${selectedChildren!==1?'ren':''}`;
        html+=trav+'<br>';
    }
    if(selectedNights>0){html+=`<b>üåô Nights:</b> ${selectedNights}<br>`;}
    if(selectedSightseeingDays>0){html+=`<b>üó∫ Sightseeing:</b> ${selectedSightseeingDays} day${selectedSightseeingDays!==1?'s':''}<br>`;}

    // Trip type
    html+=`<b>üîÑ Journey:</b> ${tripType==='return'?'Return':'One Way'}<br>`;

    html+=`<b>üè® Hotel Source:</b> ${hotelSource==='live'?'Live (Amadeus)':'Our Hotels'}<br>`;
    if(hotelSource==='live' && liveHotelState.selectedOffer){
        html+=`<b>üè® Hotel:</b> ${liveHotelState.selectedOffer.hotelName}<br>`;
        html+=`<b>üõè Room:</b> ${liveHotelState.selectedOffer.roomType||'Standard'} ¬∑ ${liveHotelState.selectedOffer.boardType||'Room Only'}<br>`;
        html+=`<b>üí∞ Hotel Total:</b> ${formatCurrency(liveHotelState.selectedOffer.totalPrice)}<br>`;
    } else if(hotelSource==='admin' && selectedHotel){
        html+=`<b>üè® Hotel:</b> ${getHotelDisplayName(selectedHotel)}<br>`;
    }
    if(selectedRooms>0){html+=`<b>üö™ Rooms:</b> ${selectedRooms}<br>`;}
    if(selectedTransport){html+=`<b>üöå Transport:</b> ${getTransportDisplayName(selectedTransport)}<br>`;}
    if(selectedCab){html+=`<b>üöó Cab:</b> ${getCabDisplayName(selectedCab)}<br>`;}
    if(flightState.selectedOffer){
        html+=`<b>‚úà Flight:</b> ${flightState.selectedOffer.airline} ${flightState.selectedOffer.origin}‚Üí${flightState.selectedOffer.destination} ${formatCurrency(flightState.selectedOffer.price)}/pp<br>`;
    }
    if(selectedAddons.length>0){
        const names=selectedAddons.map(k=>{const a=allAddons.find(x=>x.internal_name===k);return a?a.name:k;});
        html+=`<b>‚ûï Add-ons:</b> ${names.join(', ')}<br>`;
    }
    const activeDestinations=sightseeingSelectionsState.filter(s=>s&&s!=='N/A');
    if(activeDestinations.length>0){
        const names=activeDestinations.map(k=>getDestinationDisplayName(k));
        html+=`<b>üìç Days:</b> ${names.join(', ')}<br>`;
    }
    if(html) html+='<hr>';
    if(window.lastCalculation){
        const lc=window.lastCalculation;
        html+=`<div class="price-total-box">
            <div class="price-label">Total Package Cost</div>
            <div class="price-total-amount">${formatCurrency(lc.total)}</div>
            <div class="price-per-person">‚âà ${formatCurrency(lc.perPerson)} / person</div>
        </div>`;
        html+=`<hr>`;
        html+=`<b>üè® Hotel:</b> ${formatCurrency(lc.hotelCost)}<br>`;
        html+=`<b>üöå Transport:</b> ${formatCurrency(lc.transportCost)}<br>`;
        if(lc.sightseeingCost>0) html+=`<b>üó∫ Sightseeing:</b> ${formatCurrency(lc.sightseeingCost)}<br>`;
        if(lc.cabCost>0) html+=`<b>üöó Cab:</b> ${formatCurrency(lc.cabCost)}<br>`;
        if(lc.flightCost>0) html+=`<b>‚úà Flight:</b> ${formatCurrency(lc.flightCost)}<br>`;
        if(lc.addonCost>0) html+=`<b>‚ûï Add-ons:</b> ${formatCurrency(lc.addonCost)}<br>`;
        if(lc.ruleAdjustments!==0) html+=`<b>‚öñ Rule Adj:</b> ${formatCurrency(lc.ruleAdjustments)}<br>`;
        html+=`<b>üîß Service:</b> ${formatCurrency(lc.serviceCharge)}<br>`;
        html+=`<b>üìã Booking:</b> ${formatCurrency(lc.bookingCharge)}<br>`;
        if(lc.rooms) html+=`<b>üö™ Rooms:</b> ${lc.rooms}<br>`;
        if(lc.tripType) html+=`<b>üîÑ Trip Type:</b> ${lc.tripType}<br>`;
        if(lc.hotelSource) html+=`<b>üè® Source:</b> ${lc.hotelSource}<br>`;
        if(lc.appliedRules && lc.appliedRules.length){
            html+=`<b>üìú Rules Applied:</b> ${lc.appliedRules.map(r=>r.name).join(', ')}<br>`;
        }
        if(lc.liveHotelMeta){
            const lhm = lc.liveHotelMeta;
            html+=`<hr><b>üåê Live Hotel Details:</b><br>`;
            if(lhm.hotelName) html+=`Name: ${lhm.hotelName}<br>`;
            if(lhm.roomType) html+=`Room: ${lhm.roomType}<br>`;
            if(lhm.boardType) html+=`Board: ${lhm.boardType}<br>`;
            if(lhm.originalCurrency && lhm.originalCurrency!=='INR') html+=`Original: ${lhm.originalCurrency} ${(lhm.originalPrice||0).toLocaleString()}<br>`;
        }
    } else {
        html += '<span style="color:rgba(255,255,255,0.4);font-size:0.8rem">Complete the steps to see your price quote.</span>';
    }
    sidebar.innerHTML = html;
}

/* ============================================================
   SUBMIT DATA (WITH TRIP TYPE IN PAYLOAD)
   ============================================================ */
async function submitData(){
    addTypingIndicator();
    updateSummary();
    try{
        const payload = {
            client_id: CLIENT_ID,
            region_id: selectedRegion,
            adults: selectedAdults,
            children: selectedChildren,
            nights: selectedNights,
            season: selectedSeason,
            rooms: selectedRooms || 0,
            hotel: hotelSource === 'admin' ? (selectedHotel||'') : '',
            transport: selectedTransport,
            cab: selectedCab||'',
            days: sightseeingSelectionsState.slice(0, Math.max(selectedNights, selectedSightseeingDays)),
            addons: hotelSource === 'live' ? [] : selectedAddons,
            hotel_source: hotelSource,
            // Trip type ‚Äî passed to backend for transport pricing multiplier
            tripType: tripType,
            trip_type: tripType,
        };

        if(hotelSource === 'admin'){
            payload.perNightHotels = perNightHotels;
            payload.kasolSharing = kasolSharing;
            payload.perNightKasolSharing = perNightKasolSharing;
        }
        if(hotelSource === 'live' && liveHotelState.selectedOffer){
            const offer = liveHotelState.selectedOffer;
            payload.live_hotel = {
                live_hotel_id: offer.id || '',
                live_hotel_name: offer.hotelName || '',
                live_hotel_room_type: offer.roomType || '',
                live_hotel_board_type: offer.boardType || '',
                live_hotel_total_price: offer.totalPrice,
                live_hotel_currency: offer.currency || 'INR',
                live_hotel_original_price: offer.originalPrice || offer.totalPrice,
                live_hotel_original_currency: offer.originalCurrency || 'INR',
            };
        }
        if(flightState.selectedOffer){
            payload.flight = {
                type: flightState.mode || 'one_way',
                base_fare: flightState.selectedOffer.price,
                pax: selectedAdults + selectedChildren,
            };
        } else if(flightState.mode && flightState.mode !== 'none'){
            payload.flight = null;
        }

        const resp = await fetch(`${API_BASE}/calculate`, {
            method: 'POST',headers: {'Content-Type': 'application/json'},body: JSON.stringify(payload)
        });
        const data = await resp.json();
        removeTypingIndicator();
        if(!data.success){
            addBot(`‚ùå Error: ${data.error || 'Calculation failed. Please try again.'}`);
            return;
        }
        window.lastCalculation = data;
        updateSummary();

        let msg = `‚úÖ Your Package Quote:\n\n`;
        msg += `üí∞ Total: ${formatCurrency(data.total)}\n`;
        msg += `üë§ Per Person: ${formatCurrency(data.perPerson)}\n\n`;
        msg += `üìä Breakdown:\n`;
        msg += `  üè® Hotel: ${formatCurrency(data.hotelCost)}\n`;
        msg += `  üöå Transport: ${formatCurrency(data.transportCost)}\n`;
        if(data.sightseeingCost>0) msg+=`  üó∫ Sightseeing: ${formatCurrency(data.sightseeingCost)}\n`;
        if(data.cabCost>0) msg+=`  üöó Cab: ${formatCurrency(data.cabCost)}\n`;
        if(data.flightCost>0) msg+=`  ‚úà Flight: ${formatCurrency(data.flightCost)}\n`;
        if(data.addonCost>0) msg+=`  ‚ûï Add-ons: ${formatCurrency(data.addonCost)}\n`;
        if(data.ruleAdjustments!==0) msg+=`  ‚öñ Adjustments: ${formatCurrency(data.ruleAdjustments)}\n`;
        msg+=`  üîß Service: ${formatCurrency(data.serviceCharge)}\n`;
        msg+=`  üìã Booking: ${formatCurrency(data.bookingCharge)}\n`;
        if(data.rooms) msg+=`\nüö™ Rooms: ${data.rooms}`;
        if(data.roomAllocation) msg+=` (${data.roomAllocation.allocation_detail})`;
        if(data.tripType) msg+=`\nüîÑ Journey: ${data.tripType}`;
        msg+='\n';
        if(data.hotelSource==='live') msg+=`üåê Hotel Source: Live (Amadeus)\n`;
        if(data.liveHotelMeta && data.liveHotelMeta.hotelName){
            msg+=`üè® ${data.liveHotelMeta.hotelName} ¬∑ ${data.liveHotelMeta.roomType}\n`;
        }
        if(data.appliedRules && data.appliedRules.length>0){
            msg+=`\nüìú Rules Applied: ${data.appliedRules.map(r=>r.name).join(', ')}`;
        }
        addBot(msg);

        if(window.innerWidth <= 768){
            setTimeout(()=>{
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('mobileSidebarOverlay');
                const closeBtn = document.getElementById('sidebarCloseBtn');
                sidebar.classList.add('mobile-open');
                overlay.classList.add('show');
                closeBtn.style.display = 'block';
            }, 800);
        }

        setTimeout(()=>{
            addBot("Would you like to modify your package?");
            renderModifyOptions();
        }, 600);

    }catch(e){
        removeTypingIndicator();
        console.error('Calculate error:',e);
        addBot("‚ùå Could not fetch price. Please check your connection and try again.");
    }
}

/* ============================================================
   BOOK PACKAGE ‚Äî Point 3 (v4.0)
   Amadeus Create Order: real Flight PNR + Hotel Confirmation
   Strict separation: flight_pnr and hotel_confirmation always separate
   ============================================================ */

let bookingModalOpen = false;

function openBookingModal() {
    // Only allow if there's a flight or hotel to book
    const hasFlightOffer = flightState.selectedOffer && flightState.selectedOffer.id;
    const hasHotelOffer = liveHotelState.selectedOffer && liveHotelState.selectedOffer.id && hotelSource === 'live';

    if (!hasFlightOffer && !hasHotelOffer) {
        addBot("‚ö†Ô∏è No bookable flight or live hotel selected. Please search and select a flight or live hotel first.");
        return;
    }

    const modal = document.getElementById('bookingModal');
    if (modal) {
        modal.style.display = 'flex';
        bookingModalOpen = true;
        // Pre-fill adults count hint
        document.getElementById('bm-adult-count').textContent = selectedAdults;
    }
}

function closeBookingModal() {
    const modal = document.getElementById('bookingModal');
    if (modal) modal.style.display = 'none';
    bookingModalOpen = false;
    // Clear form
    ['bm-fname','bm-lname','bm-dob','bm-email','bm-phone'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    document.getElementById('bm-gender').value = 'MALE';
    document.getElementById('bm-err').textContent = '';
    document.getElementById('bm-err').style.display = 'none';
    const resultDiv = document.getElementById('bm-result');
    if (resultDiv) resultDiv.style.display = 'none';
}

async function submitBooking() {
    const errEl = document.getElementById('bm-err');
    errEl.style.display = 'none';
    errEl.textContent = '';

    // Gather traveler details
    const firstName = document.getElementById('bm-fname').value.trim().toUpperCase();
    const lastName = document.getElementById('bm-lname').value.trim().toUpperCase();
    const dateOfBirth = document.getElementById('bm-dob').value;
    const email = document.getElementById('bm-email').value.trim();
    const phone = document.getElementById('bm-phone').value.trim();
    const gender = document.getElementById('bm-gender').value;

    // Client-side pre-validation (backend validates too)
    if (!firstName || !lastName) { showBookingErr('Please enter traveler first and last name.'); return; }
    if (!dateOfBirth) { showBookingErr('Please enter date of birth.'); return; }
    if (!email || !email.includes('@')) { showBookingErr('Please enter a valid email address.'); return; }
    if (!phone) { showBookingErr('Please enter a phone number.'); return; }

    const submitBtn = document.getElementById('bm-submit-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Booking‚Ä¶';

    const travelers = [{
        firstName,
        lastName,
        dateOfBirth,
        gender,
        email,
        phone,
    }];

    const payload = {
        client_id: window.globalClientId || 1,
        travelers,
    };

    // Add flight offer ID if available
    if (flightState.selectedOffer && flightState.selectedOffer.id) {
        payload.flight_offer_id = String(flightState.selectedOffer.id);
    }

    // Add hotel offer ID if live hotel selected
    if (liveHotelState.selectedOffer && liveHotelState.selectedOffer.id && hotelSource === 'live') {
        payload.hotel_offer_id = String(liveHotelState.selectedOffer.id);
    }

    try {
        const resp = await fetch(`${API_BASE}/api/create-booking`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        });
        const data = await resp.json();

        submitBtn.disabled = false;
        submitBtn.textContent = 'Confirm Booking';

        if (data.success) {
            // Show confirmation in modal
            const resultDiv = document.getElementById('bm-result');
            if (resultDiv) {
                let html = `<div style="background:#e8f5e9;border:1px solid #4caf50;border-radius:10px;padding:16px;margin-top:14px">`;
                html += `<div style="font-weight:700;color:#2e7d32;font-size:15px;margin-bottom:10px">‚úÖ Booking Confirmed!</div>`;
                html += `<div style="font-size:13px;color:#333;line-height:1.8">`;
                html += `<b>Internal Ref:</b> ${data.internal_ref}<br>`;
                if (data.flight_pnr) html += `<b>‚úà Flight PNR:</b> <span style="font-family:monospace;font-size:16px;font-weight:700;color:#1565c0">${data.flight_pnr}</span><br>`;
                if (data.hotel_confirmation) html += `<b>üè® Hotel Confirmation:</b> <span style="font-family:monospace;font-size:16px;font-weight:700;color:#6a1b9a">${data.hotel_confirmation}</span><br>`;
                html += `</div></div>`;
                resultDiv.innerHTML = html;
                resultDiv.style.display = 'block';

                // Also add to chat
                let chatMsg = `üéâ **Booking Confirmed!**\n`;
                chatMsg += `üìã Internal Ref: ${data.internal_ref}\n`;
                if (data.flight_pnr) chatMsg += `‚úà Flight PNR: **${data.flight_pnr}**\n`;
                if (data.hotel_confirmation) chatMsg += `üè® Hotel Ref: **${data.hotel_confirmation}**\n`;
                if (data.warnings && data.warnings.length) chatMsg += `‚ö†Ô∏è Note: ${data.warnings[0]}`;
                addBot(chatMsg);
            }
        } else {
            showBookingErr(data.error || 'Booking failed. Please try again.');
            if (data.details) console.error('Booking validation errors:', data.details);
        }
    } catch (e) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Confirm Booking';
        console.error('Booking error:', e);
        showBookingErr('Connection error. Please check your internet and try again.');
    }
}

function showBookingErr(msg) {
    const errEl = document.getElementById('bm-err');
    errEl.textContent = msg;
    errEl.style.display = 'block';
}

/* ============================================================
   MODIFY OPTIONS
   ============================================================ */
function renderModifyOptions(){
    optionsContainer.innerHTML='';
    const options=[
        {label:'Change Hotel',action:()=>{
            if(hotelSource==='live') openLiveHotelModal();
            else{currentStep=STEPS.STAY_EXPERIENCE;stepHistory.push(currentStep);updateNavButtons();renderStep();}
        }},
        {label:'Change Transport',action:()=>{currentStep=STEPS.TRANSPORT;stepHistory.push(currentStep);updateNavButtons();renderStep();}},
        {label:'Modify Travelers',action:()=>{currentStep=STEPS.TRAVELERS;stepHistory.push(currentStep);updateNavButtons();renderStep();}},
        {label:'Recalculate',action:()=>submitData()},
        {label:'üìã Book Package',action:()=>openBookingModal()},
        {label:'Start Over',action:()=>startOver()},
    ];
    options.forEach(({label,action})=>{
        const b=document.createElement('button');b.className='optionButton';b.textContent=label;
        b.onclick=action;
        optionsContainer.appendChild(b);
    });
}

function startOver(){
    currentStep=STEPS.WELCOME;
    stepHistory=[];
    selectedRegionType='';selectedRegion=null;selectedDestination=null;selectedSeason='';
    selectedAdults=2;selectedChildren=0;selectedNights=0;selectedSightseeingDays=0;selectedRooms=0;
    selectedTransport='';selectedCab='';selectedHotel='';kasolSharing='';
    sightseeingSelectionsState=[];perNightHotels={};perNightKasolSharing={};selectedAddons=[];
    tripType='return';
    hotelSource='admin';
    resetLiveHotelState();
    resetFlightState();
    window.lastCalculation=null;
    messages.innerHTML='';
    optionsContainer.innerHTML='';
    updateNavButtons();
    updateSummary();
    renderStep();
}

/* ============================================================
   AI CHAT
   ============================================================ */
// Accept optional prefilled message (from quick-action chips)
async function sendAIMessage(prefill){
    const input=document.getElementById('aiInput');
    const msg=prefill||(input.value||'').trim();
    if(!msg)return;
    input.value='';
    addUser(msg);
    addTypingIndicator();

    // Build full state snapshot ‚Äî Sharad needs this to understand and explain the package
    const currentState={
        destination:selectedDestination,
        region:selectedRegion,
        nights:selectedNights,
        season:selectedSeason,
        adults:selectedAdults,
        children:selectedChildren,
        rooms:selectedRooms,
        transport:selectedTransport,
        hotel:hotelSource==='live'?null:selectedHotel,
        hotelSource,
        tripType,
        selectedAddons,
        cab:selectedCab,
        // Enrich with human-readable display names
        transportName:selectedTransport?getTransportDisplayName(selectedTransport):null,
        hotelName:selectedHotel?getHotelDisplayName(selectedHotel):null,
        liveHotel:(hotelSource==='live'&&liveHotelState.selectedOffer)?{
            hotelName:liveHotelState.selectedOffer.hotelName,
            roomType:liveHotelState.selectedOffer.roomType,
            boardType:liveHotelState.selectedOffer.boardType,
            totalPrice:liveHotelState.selectedOffer.totalPrice,
        }:null,
        flight:flightState.selectedOffer?{
            airline:flightState.selectedOffer.airline,
            origin:flightState.selectedOffer.origin,
            destination:flightState.selectedOffer.destination,
            price:flightState.selectedOffer.price,
        }:null,
    };

    const _aiAbort=new AbortController();
    const _aiTimer=setTimeout(()=>_aiAbort.abort(),45000);
    try{
        const resp=await fetch(`${API_BASE}/ai-chat`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            signal:_aiAbort.signal,
            body:JSON.stringify({
                message:msg,
                sessionId:window.sessionId,
                currentState,
                lastCalculation:window.lastCalculation,
                client_id:CLIENT_ID,
                conversationHistory:window.conversationHistory,  // full memory
            })
        });
        clearTimeout(_aiTimer);
        removeTypingIndicator();
        if(!resp.ok){addBot("I'm having a little trouble right now. Please try again in a moment! üòä");return;}
        const data=await resp.json();
        let reply;
        try{reply=JSON.parse(data.reply);}catch(e){reply={action:'GENERAL_CHAT',message:data.reply||"I'm here to help! üòä"};}
        if(!reply||!reply.action)reply={action:'GENERAL_CHAT',message:"I'm here to help! üòä"};

        // Sync conversation history ‚Äî server is source of truth
        if(data.updatedHistory&&Array.isArray(data.updatedHistory)){
            window.conversationHistory=data.updatedHistory;
        }else{
            window.conversationHistory.push({role:'user',content:msg});
            window.conversationHistory.push({role:'assistant',content:reply.message||''});
            if(window.conversationHistory.length>60)window.conversationHistory=window.conversationHistory.slice(-60);
        }
        handleAIReply(reply);
    }catch(e){
        clearTimeout(_aiTimer);
        removeTypingIndicator();
        if(e.name==='AbortError'){addBot("That took a bit longer than expected ‚Äî please try again! üòä");}
        else{addBot("Connection issue. Please check your network and try again.");}
    }
}

// Apply a single state-change action. Shared by handleAIReply and MULTI_ACTION.
function _applyAction(action, value){
    switch(action){
        case 'SET_DESTINATION':{
            const dest=allDestinations.find(d=>d.internal_name===value);
            if(dest){
                selectedRegion=dest.region_id;
                selectedDestination=dest.display_name||dest.name||value;
                const rh=getFilteredHotels(); if(rh.length)selectedHotel=rh[0].internal_name;
                const rc=getFilteredCabs();   if(rc.length)selectedCab=rc[0].internal_name;
            }
            break;
        }
        case 'SET_SEASON':    selectedSeason=value; break;
        case 'SET_HOTEL':     if(hotelSource==='admin')selectedHotel=value; break;
        case 'SET_TRANSPORT': selectedTransport=value; break;
        case 'SET_CAB':       selectedCab=value; break;
        case 'SET_ADULTS':    selectedAdults=Math.max(1,parseInt(value)||1); break;
        case 'SET_CHILDREN':  selectedChildren=Math.max(0,parseInt(value)||0); break;
        case 'SET_NIGHTS':    selectedNights=Math.max(1,parseInt(value)||1); break;
        case 'SET_ROOMS':     selectedRooms=Math.max(1,parseInt(value)||1); break;
        case 'ADD_ADDON':     if(hotelSource!=='live'&&!selectedAddons.includes(value))selectedAddons.push(value); break;
        case 'REMOVE_ADDON':  selectedAddons=selectedAddons.filter(a=>a!==value); break;
    }
}

const _STATE_ACTIONS=new Set([
    'SET_DESTINATION','SET_SEASON','SET_HOTEL','SET_TRANSPORT','SET_CAB',
    'SET_ADULTS','SET_CHILDREN','SET_NIGHTS','SET_ROOMS',
    'ADD_ADDON','REMOVE_ADDON','MULTI_ACTION'
]);

function handleAIReply(reply){
    if(!reply) return;
    const action=reply.action||'GENERAL_CHAT';
    const msg=reply.message||'';

    switch(action){
        // ‚îÄ‚îÄ Batch changes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        case 'MULTI_ACTION':{
            (reply.actions||[]).forEach(sa=>_applyAction(sa.action, sa.value));
            addBot(msg||"Done! I've updated your package. üòä");
            break;
        }
        // ‚îÄ‚îÄ Narrative explanation (no state change) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        case 'EXPLAIN_PACKAGE':{
            addBot(msg||"Your package is looking great! Let me know if you'd like to change anything.");
            break;
        }
        // ‚îÄ‚îÄ Single state changes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        case 'SET_DESTINATION':
        case 'SET_SEASON':
        case 'SET_HOTEL':
        case 'SET_TRANSPORT':
        case 'SET_CAB':
        case 'SET_ADULTS':
        case 'SET_CHILDREN':
        case 'SET_NIGHTS':
        case 'SET_ROOMS':
        case 'ADD_ADDON':
        case 'REMOVE_ADDON':
            _applyAction(action, reply.value);
            addBot(msg);
            break;
        // ‚îÄ‚îÄ Calculate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        case 'READY_TO_CALCULATE':
            addBot(msg);
            setTimeout(()=>submitData(), 300);
            break;
        // ‚îÄ‚îÄ Non-state responses ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        case 'SUGGEST_UPGRADE':
        case 'ASK_FIELD':
        case 'GENERAL_CHAT':
        default:
            addBot(msg||"I'm here to help! üòä");
            break;
    }

    updateSummary();
    // Auto-recalculate when state changed and package is complete enough
    if(_STATE_ACTIONS.has(action) && selectedRegion && selectedTransport && selectedNights>0){
        setTimeout(()=>submitData(), 600);
    }
}

document.getElementById('aiInput').addEventListener('keypress',e=>{if(e.key==='Enter')sendAIMessage();});

// ‚îÄ‚îÄ AI provider status check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function checkAIStatus(){
    try{
        const r=await fetch(`${API_BASE}/api/ai-status`);
        if(!r.ok) return;
        const d=await r.json();
        const badge=document.getElementById('aiStatusBadge');
        if(!badge) return;
        if(d.status==='active'){
            badge.textContent=`‚ú® ${d.label}`;
            badge.className='active';
            badge.title=`Sharad is powered by ${d.label}`;
        } else {
            badge.textContent='‚ö† Basic mode';
            badge.className='limited';
            badge.title='No AI API key found ‚Äî set OPENAI_API_KEY or ANTHROPIC_API_KEY';
            // Show setup banner inside messages
            const banner=document.createElement('div');
            banner.className='ai-no-key-banner';
            banner.style.display='block';
            banner.innerHTML=(
                '<strong>‚ö† AI running in basic mode</strong><br>'+
                'To enable full AI intelligence, add your API key to the <code>.env</code> file in your project root:<br>'+
                '<code>ANTHROPIC_API_KEY=sk-ant-...</code> or <code>OPENAI_API_KEY=sk-...</code><br>'+
                'Then restart the server. Anthropic keys are available at <strong>console.anthropic.com</strong>'
            );
            const msgs=document.getElementById('messages');
            if(msgs) msgs.prepend(banner);
        }
    }catch(e){ /* silent ‚Äî server may not have endpoint yet */ }
}
/* ============================================================
   VOICE INPUT
   ============================================================ */
let recognition=null,isListening=false;

function toggleVoiceInput(){
    if(!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)){
        addBot("Voice input is not supported in your browser. Please use Chrome.");
        return;
    }
    if(isListening){
        if(recognition) recognition.stop();
        isListening=false;
        document.getElementById('voiceBtn').classList.remove('listening');
        document.getElementById('voiceStatus').style.opacity='0';
        return;
    }
    const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
    recognition=new SpeechRecognition();
    recognition.lang='en-IN';
    recognition.interimResults=false;
    recognition.maxAlternatives=1;
    recognition.onstart=()=>{
        isListening=true;
        document.getElementById('voiceBtn').classList.add('listening');
        const statusEl=document.getElementById('voiceStatus');
        statusEl.textContent='Listening‚Ä¶';
        statusEl.style.opacity='1';
    };
    recognition.onresult=(event)=>{
        const transcript=event.results[0][0].transcript;
        document.getElementById('aiInput').value=transcript;
        sendAIMessage();
    };
    recognition.onerror=()=>{
        isListening=false;
        document.getElementById('voiceBtn').classList.remove('listening');
        document.getElementById('voiceStatus').style.opacity='0';
        addBot("Voice input error. Please try again.");
    };
    recognition.onend=()=>{
        isListening=false;
        document.getElementById('voiceBtn').classList.remove('listening');
        document.getElementById('voiceStatus').style.opacity='0';
    };
    recognition.start();
}

/* ============================================================
   INIT
   ============================================================ */
window.addEventListener('DOMContentLoaded', async()=>{
    await loadAllData();
    renderStep();
    checkAIStatus();  // show which AI provider is active
});
</script>
</body>
</html>